/*! ice-editor 2014-02-14 */
(function(){var Block,BlockEndToken,BlockStartToken,BlockView,BoundingBoxState,CursorToken,CursorView,DROP_AREA_HEIGHT,EMPTY_INDENT_HEIGHT,EMPTY_INDENT_WIDTH,EMPTY_SOCKET_HEIGHT,EMPTY_SOCKET_WIDTH,Editor,FONT_HEIGHT,INDENT_SPACES,INDENT_SPACING,INPUT_LINE_HEIGHT,IceEditorChangeEvent,IceView,Indent,IndentEndToken,IndentStartToken,IndentView,MIN_DRAG_DISTANCE,MIN_SEGMENT_DROP_AREA_WIDTH,NewlineToken,PADDING,PALETTE_MARGIN,PALETTE_WIDTH,PathWaypoint,Segment,SegmentEndToken,SegmentStartToken,SegmentView,Socket,SocketEndToken,SocketStartToken,SocketView,TAB_HEIGHT,TAB_OFFSET,TAB_WIDTH,TOUNGE_HEIGHT,TextToken,TextView,Token,exports,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};exports={},exports.Block=Block=function(){function Block(contents){var head,token,_i,_len;for(this.start=new BlockStartToken(this),this.end=new BlockEndToken(this),this.type="block",this.color="#ddf",this.selected=!1,head=this.start,_i=0,_len=contents.length;_len>_i;_i++)token=contents[_i],head=head.append(token.clone());head.append(this.end),this.view=new BlockView(this)}return Block.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Block([]),clone.color=this.color,head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:"cursorToken"!==head.type&&(cursor=cursor.append(head.clone()))}head=head.next}return cursor.append(clone.end),clone},Block.prototype.inSocket=function(){var head;for(head=this.start.prev;null!=head&&"segmentStart"===head.type;)head=head.prev;return null!=head&&"socketStart"===head.type},Block.prototype.moveTo=function(parent){for(var first,last,_ref;null!=this.start.prev&&"segmentStart"===this.start.prev.type&&this.start.prev.segment.end===this.end.next;)this.start.prev.segment.remove();if(null!=this.end.next&&null!=this.start.prev){for(last=this.end.next;null!=last&&("segmentEnd"===last.type||"cursor"===last.type);)last=last.next;for(first=this.start.prev;null!=first&&("segmentStart"===first.type||"cursor"===first.type);)first=first.prev;null==first||"newline"!==first.type||null!=last&&"newline"!==last.type&&"indentEnd"!==last.type||"indentStart"===(null!=(_ref=first.prev)?_ref.type:void 0)&&"indentEnd"===last.type?null==last||"newline"!==last.type||null!=first&&"newline"!==first.type||last.remove():first.remove()}return null!=this.start.prev&&(this.start.prev.next=this.end.next),null!=this.end.next&&(this.end.next.prev=this.start.prev),this.start.prev=this.end.next=null,null!=parent?(this.end.next=parent.next,null!=parent.next&&(parent.next.prev=this.end),parent.next=this.start,this.start.prev=parent):void 0},Block.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Block.prototype.toString=function(){var string;return string=this.start.toString({indent:""}),string.slice(0,+(string.length-this.end.toString({indent:""}).length-1)+1||9e9)},Block}(),exports.Indent=Indent=function(){function Indent(contents,depth){var block,head,_i,_len;for(this.depth=depth,this.start=new IndentStartToken(this),this.end=new IndentEndToken(this),this.type="indent",head=this.start,_i=0,_len=contents.length;_len>_i;_i++)block=contents[_i],head=head.append(block.clone());head.append(this.end),this.view=new IndentView(this)}return Indent.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Indent([],this.depth),head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:"cursorToken"!==head.type&&(cursor=cursor.append(head.clone()))}head=head.next}return cursor.append(clone.end),clone},Indent.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Indent.prototype.toString=function(state){var string;return string=this.start.toString(state),string.slice(0,string.length-this.end.toString(state).length-1)},Indent}(),exports.Segment=Segment=function(){function Segment(contents){var block,head,_i,_len;for(this.start=new SegmentStartToken(this),this.end=new SegmentEndToken(this),this.type="segment",head=this.start,_i=0,_len=contents.length;_len>_i;_i++)block=contents[_i],head=head.append(block.clone());head.append(this.end),this.view=new SegmentView(this)}return Segment.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Segment([]),head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:"cursorToken"!==head.type&&(cursor=cursor.append(head.clone()))}head=head.next}return cursor.append(clone.end),clone},Segment.prototype.remove=function(){return this.start.remove(),this.end.remove(),this.start.next=this.end,this.end.prev=this.start},Segment.prototype.moveTo=function(parent){for(var first,last,_ref;null!=this.start.prev&&"segmentStart"===this.start.prev.type&&this.start.prev.segment.end===this.end.next;)this.start.prev.segment.remove();if(null!=this.end.next&&null!=this.start.prev){for(last=this.end.next;null!=last&&("segmentEnd"===last.type||"cursor"===last.type);)last=last.next;for(first=this.start.prev;null!=first&&("segmentStart"===first.type||"cursor"===first.type);)first=first.prev;null==first||"newline"!==first.type||null!=last&&"newline"!==last.type&&"indentEnd"!==last.type||"indentStart"===(null!=(_ref=first.prev)?_ref.type:void 0)&&"indentEnd"===last.type?null==last||"newline"!==last.type||null!=first&&"newline"!==first.type||last.remove():first.remove()}return null!=this.start.prev&&(this.start.prev.next=this.end.next),null!=this.end.next&&(this.end.next.prev=this.start.prev),this.start.prev=this.end.next=null,null!=parent?(this.end.next=parent.next,null!=parent.next&&(parent.next.prev=this.end),parent.next=this.start,this.start.prev=parent):void 0},Segment.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Segment.prototype.toString=function(){var start;return start=this.start.toString({indent:""}),start.slice(0,start.length-this.end.toString({indent:""}).length)},Segment}(),exports.Socket=Socket=function(){function Socket(content){this.start=new SocketStartToken(this),this.end=new SocketEndToken(this),null!=content&&null!=content.start?(this.start.next=content.start,content.start.prev=this.start,this.end.prev=content.end,content.end.next=this.end):null!=content?(this.start.next=content,content.prev=this.start,this.end.prev=content,content.next=this.end):(this.start.next=this.end,this.end.prev=this.start),this.type="socket",this.handwritten=!1,this.view=new SocketView(this)}return Socket.prototype.clone=function(){return null!=this.content()?new Socket(this.content().clone()):new Socket},Socket.prototype.content=function(){var unwrap;return unwrap=function(el){switch(el.type){case"blockStart":return el.block;case"segmentStart":return unwrap(el.next);default:return el}},this.start.next!==this.end?unwrap(this.start.next):null},Socket.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Socket.prototype.toString=function(){return this.start.toString({indent:""}).slice(0,+-this.end.toString({indent:""}).length+1||9e9)},Socket}(),exports.Token=Token=function(){function Token(){this.prev=this.next=null}return Token.prototype.append=function(token){return token.prev=this,this.next=token},Token.prototype.insert=function(token){return null!=this.next&&(token.next=this.next,this.next.prev=token),token.prev=this,this.next=token,this.next},Token.prototype.insertBefore=function(token){return null!=this.prev&&(token.prev=this.prev,this.prev.next=token),token.next=this,this.prev=token,this.prev},Token.prototype.remove=function(){return null!=this.prev&&(this.prev.next=this.next),null!=this.next&&(this.next.prev=this.prev),this.prev=this.next=null},Token.prototype.toString=function(state){return null!=this.next?this.next.toString(state):""},Token}(),exports.CursorToken=CursorToken=function(_super){function CursorToken(){this.prev=this.next=null,this.view=new CursorView(this),this.type="cursor"}return __extends(CursorToken,_super),CursorToken.prototype.clone=function(){return new CursorToken},CursorToken}(Token),exports.TextToken=TextToken=function(_super){function TextToken(value){this.value=value,this.prev=this.next=null,this.view=new TextView(this),this.type="text"}return __extends(TextToken,_super),TextToken.prototype.clone=function(){return new TextToken(this.value)},TextToken.prototype.toString=function(state){return this.value+(null!=this.next?this.next.toString(state):"")},TextToken}(Token),exports.BlockStartToken=BlockStartToken=function(_super){function BlockStartToken(block){this.block=block,this.prev=this.next=null,this.type="blockStart"}return __extends(BlockStartToken,_super),BlockStartToken}(Token),exports.BlockEndToken=BlockEndToken=function(_super){function BlockEndToken(block){this.block=block,this.prev=this.next=null,this.type="blockEnd"}return __extends(BlockEndToken,_super),BlockEndToken}(Token),exports.SocketStartToken=SocketStartToken=function(_super){function SocketStartToken(socket){this.socket=socket,this.prev=this.next=null,this.type="socketStart"}return __extends(SocketStartToken,_super),SocketStartToken}(Token),exports.SocketEndToken=SocketEndToken=function(_super){function SocketEndToken(socket){this.socket=socket,this.prev=this.next=null,this.type="socketEnd"}return __extends(SocketEndToken,_super),SocketEndToken}(Token),exports.SegmentStartToken=SegmentStartToken=function(_super){function SegmentStartToken(segment){this.segment=segment,this.prev=this.next=null,this.type="segmentStart"}return __extends(SegmentStartToken,_super),SegmentStartToken}(Token),exports.SegmentEndToken=SegmentEndToken=function(_super){function SegmentEndToken(segment){this.segment=segment,this.prev=this.next=null,this.type="segmentEnd"}return __extends(SegmentEndToken,_super),SegmentEndToken}(Token),exports.IndentStartToken=IndentStartToken=function(_super){function IndentStartToken(indent){this.indent=indent,this.prev=this.next=null,this.type="indentStart"}return __extends(IndentStartToken,_super),IndentStartToken.prototype.toString=function(state){return state.indent+=function(){var _i,_ref,_results;for(_results=[],_i=1,_ref=this.indent.depth;_ref>=1?_ref>=_i:_i>=_ref;_ref>=1?_i++:_i--)_results.push(" ");return _results}.call(this).join(""),this.next?this.next.toString(state):""},IndentStartToken}(Token),exports.IndentEndToken=IndentEndToken=function(_super){function IndentEndToken(indent){this.indent=indent,this.prev=this.next=null,this.type="indentEnd"}return __extends(IndentEndToken,_super),IndentEndToken.prototype.toString=function(state){return state.indent=state.indent.slice(0,-this.indent.depth),this.next?this.next.toString(state):""},IndentEndToken}(Token),exports.NewlineToken=NewlineToken=function(_super){function NewlineToken(){this.prev=this.next=null,this.type="newline"}return __extends(NewlineToken,_super),NewlineToken.prototype.clone=function(){return new NewlineToken},NewlineToken.prototype.toString=function(state){return"\n"+state.indent+(this.next?this.next.toString(state):"")},NewlineToken}(Token),window.ICE=exports,PADDING=5,INDENT_SPACING=10,TOUNGE_HEIGHT=10,FONT_HEIGHT=15,EMPTY_SOCKET_HEIGHT=FONT_HEIGHT+2*PADDING,EMPTY_SOCKET_WIDTH=20,EMPTY_INDENT_HEIGHT=FONT_HEIGHT+2*PADDING,EMPTY_INDENT_WIDTH=50,MIN_SEGMENT_DROP_AREA_WIDTH=100,DROP_AREA_HEIGHT=30,TAB_WIDTH=15,TAB_HEIGHT=5,TAB_OFFSET=10,BoundingBoxState=function(){function BoundingBoxState(point){this.x=point.x,this.y=point.y}return BoundingBoxState}(),PathWaypoint=function(){function PathWaypoint(left,right){this.left=left,this.right=right}return PathWaypoint}(),IceView=function(){function IceView(block){this.block=block,this.children=[],this.lineStart=this.lineEnd=null,this.lineChildren={},this.dimensions={},this.cursors=[],this.dropArea=null,this.highlightArea=null,this.indented={},this.indentEndsOn={},this.indentStartsOn={},this.pathWaypoints={},this.bounds={}}return IceView.prototype.computeChildren=function(line){var head,l,occupiedLine,_base,_base1,_base10,_base11,_base2,_base3,_base4,_base5,_base6,_base7,_base8,_base9,_i,_j,_k,_l,_m,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;for(this.children=[],this.lineStart=this.lineEnd=null,this.dropArea=this.highlightArea=null,this.lineChildren={},this.dimensions={},this.indented={},this.indentEndsOn={},this.indentStartsOn={},this.pathWaypoints={},this.bounds={},this.cursors=[],this.lineStart=line,head=this.block.start.next;head!==this.block.end;){switch(head.type){case"blockStart":for(line=head.block.view.computeChildren(line),this.children.push(head.block.view),occupiedLine=_i=_ref=head.block.view.lineStart,_ref1=head.block.view.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;occupiedLine=_ref1>=_ref?++_i:--_i)null==(_base=this.lineChildren)[occupiedLine]&&(_base[occupiedLine]=[]),this.lineChildren[occupiedLine].push(head.block.view),(_base1=this.indented)[occupiedLine]||(_base1[occupiedLine]=head.block.view.indented[occupiedLine]),(_base2=this.indentEndsOn)[occupiedLine]||(_base2[occupiedLine]=head.block.view.indentEndsOn[occupiedLine]);head=head.block.end;break;case"indentStart":for(line=head.indent.view.computeChildren(line),this.children.push(head.indent.view),occupiedLine=_j=_ref2=head.indent.view.lineStart,_ref3=head.indent.view.lineEnd;_ref3>=_ref2?_ref3>=_j:_j>=_ref3;occupiedLine=_ref3>=_ref2?++_j:--_j)null==(_base3=this.lineChildren)[occupiedLine]&&(_base3[occupiedLine]=[]),this.lineChildren[occupiedLine].push(head.indent.view),this.indented[occupiedLine]=!0;this.indentEndsOn[head.indent.view.lineEnd]=!0,this.indentStartsOn[head.indent.view.lineStart]=!0,head=head.indent.end;break;case"socketStart":for(line=head.socket.view.computeChildren(line),this.children.push(head.socket.view),occupiedLine=_k=_ref4=head.socket.view.lineStart,_ref5=head.socket.view.lineEnd;_ref5>=_ref4?_ref5>=_k:_k>=_ref5;occupiedLine=_ref5>=_ref4?++_k:--_k)null==(_base4=this.lineChildren)[occupiedLine]&&(_base4[occupiedLine]=[]),this.lineChildren[occupiedLine].push(head.socket.view),(_base5=this.indented)[occupiedLine]||(_base5[occupiedLine]=head.socket.view.indented[occupiedLine]),(_base6=this.indentEndsOn)[occupiedLine]||(_base6[occupiedLine]=head.socket.view.indentEndsOn[occupiedLine]);head=head.socket.end;break;case"segmentStart":for(line=head.segment.view.computeChildren(line),this.children.push(head.segment.view),occupiedLine=_l=_ref6=head.segment.view.lineStart,_ref7=head.segment.view.lineEnd;_ref7>=_ref6?_ref7>=_l:_l>=_ref7;occupiedLine=_ref7>=_ref6?++_l:--_l)null==(_base7=this.lineChildren)[occupiedLine]&&(_base7[occupiedLine]=[]),this.lineChildren[occupiedLine].push(head.segment.view),(_base8=this.indented)[occupiedLine]||(_base8[occupiedLine]=head.segment.view.indented[occupiedLine]),(_base9=this.indentEndsOn)[occupiedLine]||(_base9[occupiedLine]=head.segment.view.indentEndsOn[occupiedLine]);head=head.segment.end;break;case"text":head.view.computeChildren(line),this.children.push(head.view),null==(_base10=this.lineChildren)[line]&&(_base10[line]=[]),this.lineChildren[line].push(head.view);break;case"cursor":this.cursors.push({token:head,line:line});break;case"newline":line+=1}head=head.next}for(this.lineEnd=line,l=_m=_ref8=this.lineStart,_ref9=this.lineEnd;_ref9>=_ref8?_ref9>=_m:_m>=_ref9;l=_ref9>=_ref8?++_m:--_m)null==(_base11=this.lineChildren)[l]&&(_base11[l]=[]);return line},IceView.prototype.computeDimensions=function(){var child,_i,_len,_ref;for(_ref=this.children,_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],child.computeDimensions();return this.dimensions},IceView.prototype.computeBoundingBox=function(line,state){var child,_i,_len,_ref;for(_ref=this.lineChildren[line],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],child.computeBoundingBox(line,state);return this.bounds[line]=new draw.NoRectangle},IceView.prototype.computePath=function(){var child,_i,_len,_ref;for(_ref=this.children,_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],child.computePath();return this.bounds},IceView.prototype.drawPath=function(ctx){var child,_i,_len,_ref,_results;for(_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.drawPath(ctx));return _results},IceView.prototype.drawCursor=function(ctx){var child,cursor,yCoordinate,_i,_j,_len,_len1,_ref,_ref1,_results;for(_ref=this.children,_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],child.drawCursor(ctx);for(_ref1=this.cursors,_results=[],_j=0,_len1=_ref1.length;_len1>_j;_j++)cursor=_ref1[_j],yCoordinate="newline"===cursor.token.prev.type||"segmentStart"===cursor.token.prev.type?this.bounds[cursor.line].y:this.bounds[cursor.line].bottom(),cursor.token.view.point.y=yCoordinate,ctx.fillStyle="#000",ctx.strokeSTyle="#000",ctx.beginPath(),this.bounds[cursor.line].x>=5?(ctx.moveTo(this.bounds[cursor.line].x,yCoordinate),ctx.lineTo(this.bounds[cursor.line].x-5,yCoordinate-5),ctx.lineTo(this.bounds[cursor.line].x-5,yCoordinate+5)):(ctx.moveTo(this.bounds[cursor.line].x,yCoordinate),ctx.lineTo(this.bounds[cursor.line].x+5,yCoordinate-5),ctx.lineTo(this.bounds[cursor.line].x+5,yCoordinate+5)),ctx.stroke(),_results.push(ctx.fill());return _results},IceView.prototype.draw=function(ctx){return this.drawPath(ctx),this.drawCursor(ctx)},IceView.prototype.computeBoundingBoxes=function(){var cursor,line,_i,_ref,_ref1;for(cursor=new draw.Point(0,0),line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i)this.computeBoundingBox(line,new BoundingBoxState(cursor)),cursor.y+=this.dimensions[line].height;return this.bounds},IceView.prototype.getBounds=function(){var bound,line,_i,_ref,_ref1;for(bound=new draw.NoRectangle,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i)bound.unite(this.bounds[line]);return bound},IceView.prototype.compute=function(line){return null==line&&(line=0),this.computeChildren(line),this.computeDimensions(),this.computeBoundingBoxes(),this.computePath()},IceView.prototype.translate=function(point){var bound,child,line,_i,_len,_ref,_ref1,_results;_ref=this.bounds;for(line in _ref)bound=_ref[line],bound.translate(point);for(_ref1=this.children,_results=[],_i=0,_len=_ref1.length;_len>_i;_i++)child=_ref1[_i],_results.push(child.translate(point));return _results},IceView}(),BlockView=function(_super){function BlockView(block){BlockView.__super__.constructor.call(this,block),this.path=null}return __extends(BlockView,_super),BlockView.prototype.computeDimensions=function(){var child,height,line,width,_i,_j,_len,_ref,_ref1,_ref2,_results;for(BlockView.__super__.computeDimensions.apply(this,arguments),_results=[],line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(width=PADDING,height=2*PADDING,_ref2=this.lineChildren[line],_j=0,_len=_ref2.length;_len>_j;_j++)child=_ref2[_j],"indent"===child.block.type?(width+=child.dimensions[line].width+INDENT_SPACING,height=Math.max(height,child.dimensions[line].height+(child.lineEnd===line?TOUNGE_HEIGHT:0))):child.indented[line]?(width+=child.dimensions[line].width+PADDING,height=Math.max(height,child.dimensions[line].height)):(width+=child.dimensions[line].width+PADDING,height=Math.max(height,child.dimensions[line].height+2*PADDING));_results.push(this.dimensions[line]=new draw.Size(width,height))}return _results},BlockView.prototype.computeBoundingBox=function(line,state){var axis,child,cursor,indentChild,paddingLeft,_i,_len,_ref;for(axis=state.y+this.dimensions[line].height/2,cursor=state.x,this.bounds[line]=new draw.Rectangle(state.x,state.y,this.dimensions[line].width,this.dimensions[line].height),_ref=this.lineChildren[line],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],"indent"===child.block.type?(cursor+=INDENT_SPACING,child.computeBoundingBox(line,new BoundingBoxState(new draw.Point(cursor,state.y)))):(cursor+=PADDING,child.computeBoundingBox(line,new BoundingBoxState(new draw.Point(cursor,axis-child.dimensions[line].height/2)))),cursor+=child.dimensions[line].width;return this.lineChildren[line].length>0&&!this.lineChildren[line][0].indented[line]&&"indent"!==this.lineChildren[line][0].block.type?this.pathWaypoints[line]=new PathWaypoint([new draw.Point(this.bounds[line].x,this.bounds[line].y),new draw.Point(this.bounds[line].x,this.bounds[line].bottom())],[new draw.Point(this.bounds[line].right(),this.bounds[line].y),new draw.Point(this.bounds[line].right(),this.bounds[line].bottom())]):this.lineChildren[line].length>0?line===this.lineChildren[line][0].lineEnd&&"indent"===this.lineChildren[line][0].block.type?(indentChild=this.lineChildren[line][0],paddingLeft="indent"===this.lineChildren[line][0].block.type?INDENT_SPACING:PADDING,this.pathWaypoints[line]=1===this.lineChildren[line].length?new PathWaypoint([new draw.Point(this.bounds[line].x,this.bounds[line].y),new draw.Point(this.bounds[line].x,this.bounds[line].bottom())],[new draw.Point(this.bounds[line].x+paddingLeft,this.bounds[line].y),new draw.Point(this.bounds[line].x+paddingLeft,indentChild.bounds[line].bottom()),new draw.Point(indentChild.bounds[line].right(),indentChild.bounds[line].bottom()),new draw.Point(this.bounds[line].right(),indentChild.bounds[line].bottom()),new draw.Point(this.bounds[line].right(),this.bounds[line].bottom())]):new PathWaypoint([new draw.Point(this.bounds[line].x,this.bounds[line].y),new draw.Point(this.bounds[line].x,this.bounds[line].bottom())],[new draw.Point(this.bounds[line].x+paddingLeft,this.bounds[line].y),new draw.Point(this.bounds[line].x+paddingLeft,indentChild.bounds[line].bottom()),new draw.Point(indentChild.bounds[line].right(),indentChild.bounds[line].bottom()),new draw.Point(indentChild.bounds[line].right(),this.bounds[line].y),new draw.Point(this.bounds[line].right(),this.bounds[line].y),new draw.Point(this.bounds[line].right(),this.bounds[line].bottom())])):this.pathWaypoints[line]=new PathWaypoint([new draw.Point(this.bounds[line].x,this.bounds[line].y),new draw.Point(this.bounds[line].x,this.bounds[line].bottom())],[new draw.Point(this.bounds[line].x+INDENT_SPACING,this.bounds[line].y),new draw.Point(this.bounds[line].x+INDENT_SPACING,this.bounds[line].bottom())]):void 0},BlockView.prototype.computePath=function(){var entryPoint,line,point,waypoint,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3,_ref4;BlockView.__super__.computePath.apply(this,arguments),this.path=new draw.Path,this.dropArea=new draw.Rectangle(this.bounds[this.lineEnd].x,this.bounds[this.lineEnd].bottom()-DROP_AREA_HEIGHT/2,this.bounds[this.lineEnd].width,DROP_AREA_HEIGHT),this.dropHighlightReigon=new draw.Rectangle(this.bounds[this.lineEnd].x,this.bounds[this.lineEnd].bottom()-5,this.bounds[this.lineEnd].width,10),(null!=(_ref=this.block.inSocket())?_ref:!1)||(this.path.push(new draw.Point(this.bounds[this.lineStart].x+TAB_OFFSET,this.bounds[this.lineStart].y)),this.path.push(new draw.Point(this.bounds[this.lineStart].x+TAB_OFFSET+TAB_WIDTH/8,this.bounds[this.lineStart].y+TAB_HEIGHT)),this.path.push(new draw.Point(this.bounds[this.lineStart].x+TAB_OFFSET+7*TAB_WIDTH/8,this.bounds[this.lineStart].y+TAB_HEIGHT)),this.path.push(new draw.Point(this.bounds[this.lineStart].x+TAB_OFFSET+TAB_WIDTH,this.bounds[this.lineStart].y))),_ref1=this.pathWaypoints;for(line in _ref1){for(waypoint=_ref1[line],this.indentStartsOn[line]&&(entryPoint=new draw.Point(this.bounds[line].x+INDENT_SPACING+TAB_OFFSET+TAB_WIDTH,this.bounds[line].y),this.path._points.length>0&&entryPoint.y!==this.path._points[this.path._points.length-1].y&&this.path.push(new draw.Point(this.path._points[this.path._points.length-1].x,entryPoint.y)),this.path.push(entryPoint),this.path.push(new draw.Point(this.bounds[line].x+INDENT_SPACING+TAB_OFFSET+7*TAB_WIDTH/8,this.bounds[line].y+TAB_HEIGHT)),this.path.push(new draw.Point(this.bounds[line].x+INDENT_SPACING+TAB_OFFSET+TAB_WIDTH/8,this.bounds[line].y+TAB_HEIGHT)),this.path.push(new draw.Point(this.bounds[line].x+INDENT_SPACING+TAB_OFFSET,this.bounds[line].y))),_ref2=waypoint.left,_i=0,_len=_ref2.length;_len>_i;_i++)point=_ref2[_i],this.path._points.length>0&&point.x!==this.path._points[0].x&&this.path.unshift(new draw.Point(point.x,this.path._points[0].y)),this.path.unshift(point);for(_ref3=waypoint.right,_j=0,_len1=_ref3.length;_len1>_j;_j++)point=_ref3[_j],this.path._points.length>0&&point.y!==this.path._points[this.path._points.length-1].y&&this.path.push(new draw.Point(this.path._points[this.path._points.length-1].x,point.y)),this.path.push(point)}return(null!=(_ref4=this.block.inSocket())?_ref4:!1)||(this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+TAB_OFFSET,this.bounds[this.lineEnd].bottom())),this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+TAB_OFFSET+TAB_WIDTH/8,this.bounds[this.lineEnd].bottom()+TAB_HEIGHT)),this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+TAB_OFFSET+7*TAB_WIDTH/8,this.bounds[this.lineEnd].bottom()+TAB_HEIGHT)),this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+TAB_OFFSET+TAB_WIDTH,this.bounds[this.lineEnd].bottom()))),this.path.style.fillColor=this.block.color,this.path.style.strokeColor="#000"},BlockView.prototype.drawPath=function(ctx){return 0===this.path._points.length,this.path.draw(ctx),BlockView.__super__.drawPath.apply(this,arguments)},BlockView.prototype.translate=function(point){return this.path.translate(point),BlockView.__super__.translate.apply(this,arguments)},BlockView}(IceView),TextView=function(_super){function TextView(block){TextView.__super__.constructor.call(this,block),this.textElement=null}return __extends(TextView,_super),TextView.prototype.computeChildren=function(line){return this.lineStart=this.lineEnd=line},TextView.prototype.computeDimensions=function(){return this.textElement=new draw.Text(new draw.Point(0,0),this.block.value),this.dimensions[this.lineStart]=new draw.Size(this.textElement.bounds().width,this.textElement.bounds().height),this.dimesions},TextView.prototype.computeBoundingBox=function(line,state){return line===this.lineStart?(this.bounds[line]=new draw.Rectangle(state.x,state.y,this.dimensions[line].width,this.dimensions[line].height),this.textElement.setPosition(new draw.Point(state.x,state.y))):void 0},TextView.prototype.computePath=function(){},TextView.prototype.drawPath=function(ctx){return this.textElement.draw(ctx)},TextView.prototype.translate=function(point){return this.textElement.translate(point),TextView.__super__.translate.apply(this,arguments)},TextView}(IceView),IndentView=function(_super){function IndentView(block){IndentView.__super__.constructor.call(this,block)}return __extends(IndentView,_super),IndentView.prototype.computeChildren=function(){return IndentView.__super__.computeChildren.apply(this,arguments),this.lineStart+=1,this.lineEnd},IndentView.prototype.computeDimensions=function(){var child,height,line,width,_i,_j,_len,_ref,_ref1,_ref2,_results;if(IndentView.__super__.computeDimensions.apply(this,arguments),this.lineEnd>=this.lineStart){for(_results=[],line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(height=width=0,_ref2=this.lineChildren[line],_j=0,_len=_ref2.length;_len>_j;_j++)child=_ref2[_j],width+=child.dimensions[line].width,height=Math.max(height,child.dimensions[line].height);height=Math.max(height,EMPTY_INDENT_HEIGHT),width=Math.max(width,EMPTY_INDENT_WIDTH),_results.push(this.dimensions[line]=new draw.Size(width,height))}return _results}},IndentView.prototype.computeBoundingBox=function(line,state){var child,cursorX,cursorY,_i,_len,_ref,_results;for(cursorX=state.x,cursorY=state.y,this.bounds[line]=new draw.Rectangle(state.x,state.y,this.dimensions[line].width,this.dimensions[line].height),_ref=this.lineChildren[line],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],child.computeBoundingBox(line,new BoundingBoxState(new draw.Point(cursorX,cursorY))),_results.push(cursorX+=child.dimensions[line].width);return _results},IndentView.prototype.computePath=function(){return this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-DROP_AREA_HEIGHT/2,this.bounds[this.lineStart].width,DROP_AREA_HEIGHT),this.dropHighlightReigon=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,this.bounds[this.lineStart].width,10),IndentView.__super__.computePath.apply(this,arguments)},IndentView}(IceView),SocketView=function(_super){function SocketView(block){SocketView.__super__.constructor.call(this,block)}return __extends(SocketView,_super),SocketView.prototype.computeDimensions=function(){var content,line,value,_ref;if(SocketView.__super__.computeDimensions.apply(this,arguments),null!=(content=this.block.content()))switch(this.block.content().type){case"block":_ref=content.view.dimensions;for(line in _ref)value=_ref[line],this.dimensions[line]=new draw.Size(value.width,value.height);break;case"text":this.dimensions[content.view.lineStart]=new draw.Size(content.view.dimensions[content.view.lineStart].width+2*PADDING,content.view.dimensions[content.view.lineStart].height+2*PADDING),this.dimensions[content.view.lineStart].width=Math.max(this.dimensions[content.view.lineStart].width,EMPTY_SOCKET_WIDTH)}else this.dimensions[this.lineStart]=new draw.Size(EMPTY_SOCKET_WIDTH,EMPTY_SOCKET_HEIGHT);return this.dimensions},SocketView.prototype.computeBoundingBox=function(line,state){if(this.bounds[line]=new draw.Rectangle(state.x,state.y,this.dimensions[line].width,this.dimensions[line].height),0!==this.lineChildren[line].length){if(this.lineChildren[line].length>1)throw"Error: more than one child inside a socket";
return"text"===this.block.content().type?this.lineChildren[line][0].computeBoundingBox(line,new BoundingBoxState(new draw.Point(state.x+PADDING,state.y+PADDING))):this.lineChildren[line][0].computeBoundingBox(line,state)}},SocketView.prototype.computePath=function(){var _ref;return"block"!==(null!=(_ref=this.block.content())?_ref.type:void 0)&&(this.dropHighlightReigon=this.dropArea=new draw.Rectangle).copy(this.bounds[this.lineStart]),SocketView.__super__.computePath.apply(this,arguments)},SocketView.prototype.drawPath=function(ctx){return(null==this.block.content()||"text"===this.block.content().type)&&(this.bounds[this.lineStart].stroke(ctx,"#000"),this.bounds[this.lineStart].fill(ctx,"#FFF")),SocketView.__super__.drawPath.apply(this,arguments)},SocketView}(IceView),SegmentView=function(_super){function SegmentView(block){SegmentView.__super__.constructor.call(this,block)}return __extends(SegmentView,_super),SegmentView.prototype.computeDimensions=function(){var child,height,line,width,_i,_j,_len,_ref,_ref1,_ref2,_results;for(SegmentView.__super__.computeDimensions.apply(this,arguments),_results=[],line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(height=width=0,_ref2=this.lineChildren[line],_j=0,_len=_ref2.length;_len>_j;_j++)child=_ref2[_j],width+=child.dimensions[line].width,height=Math.max(height,child.dimensions[line].height);_results.push(this.dimensions[line]=new draw.Size(width,height))}return _results},SegmentView.prototype.computeBoundingBox=function(line,state){var child,cursorX,cursorY,_i,_len,_ref,_results;for(cursorX=state.x,cursorY=state.y,this.bounds[line]=new draw.Rectangle(state.x,state.y,this.dimensions[line].width,this.dimensions[line].height),_ref=this.lineChildren[line],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],child.computeBoundingBox(line,new BoundingBoxState(new draw.Point(cursorX,cursorY))),_results.push(cursorX+=child.dimensions[line].width);return _results},SegmentView.prototype.drawPath=function(){return this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,Math.max(this.bounds[this.lineStart].width,MIN_SEGMENT_DROP_AREA_WIDTH),10),this.dropHighlightReigon=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,this.bounds[this.lineStart].width,10),SegmentView.__super__.drawPath.apply(this,arguments)},SegmentView}(IceView),CursorView=function(){function CursorView(block){this.block=block,this.point=new draw.Point(0,0)}return CursorView}(),INDENT_SPACES=2,INPUT_LINE_HEIGHT=15,PALETTE_MARGIN=10,PALETTE_WIDTH=300,MIN_DRAG_DISTANCE=5,exports.IceEditorChangeEvent=IceEditorChangeEvent=function(){function IceEditorChangeEvent(block,target){this.block=block,this.target=target}return IceEditorChangeEvent}(),exports.Editor=Editor=function(){function Editor(el,paletteBlocks){var child,deleteFromCursor,drag,dragCtx,eventName,getPointFromEvent,getRectFromPoints,highlight,hitTest,hitTestFloating,hitTestFocus,hitTestLasso,hitTestPalette,hitTestRoot,insertHandwrittenBlock,main,mainCtx,moveBlockTo,moveCursorBefore,moveCursorDown,moveCursorTo,moveCursorUp,offset,palette,paletteBlock,paletteCtx,redrawTextInput,scrollCursorIntoView,setTextInputAnchor,setTextInputFocus,setTextInputHead,textInputAnchor,textInputHead,textInputSelecting,track,_editedInputLine,_i,_j,_len,_len1,_ref,_ref1,_this=this;for(this.paletteBlocks=paletteBlocks,null==this.paletteBlocks&&(this.paletteBlocks=[]),this.paletteBlocks=function(){var _i,_len,_ref,_results;for(_ref=this.paletteBlocks,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)paletteBlock=_ref[_i],_results.push(paletteBlock.clone());return _results}.call(this),this.tree=null,this.floatingBlocks=[],this.focus=null,this.editedText=null,this.handwritten=!1,this.hiddenInput=null,this.isEditingText=function(){return _this.hiddenInput===document.activeElement},textInputAnchor=textInputHead=null,textInputSelecting=!1,_editedInputLine=-1,this.selection=null,this.lassoSegment=null,this._lassoBounds=null,this.cursor=new CursorToken,this.undoStack=[],this.scrollOffset=new draw.Point(0,0),offset=null,highlight=null,main=document.createElement("canvas"),main.className="canvas",main.height=el.offsetHeight,main.width=el.offsetWidth-PALETTE_WIDTH,palette=document.createElement("canvas"),palette.className="palette",palette.height=el.offsetHeight,palette.width=PALETTE_WIDTH,drag=document.createElement("canvas"),drag.className="drag",drag.height=el.offsetHeight,drag.width=el.offsetWidth-PALETTE_WIDTH,this.hiddenInput=document.createElement("input"),this.hiddenInput.className="hidden_input",track=document.createElement("div"),track.className="trackArea",_ref=[main,palette,drag,track,this.hiddenInput],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],el.appendChild(child);for(mainCtx=main.getContext("2d"),dragCtx=drag.getContext("2d"),paletteCtx=palette.getContext("2d"),draw._setCTX(mainCtx),this.clear=function(){return mainCtx.clearRect(_this.scrollOffset.x,_this.scrollOffset.y,main.width,main.height)},this.redraw=function(){var float,view,_j,_k,_len1,_len2,_ref1,_ref2,_results;if(_this.clear(),_this.tree.view.compute(),_this.tree.view.draw(mainCtx),null!=_this.lassoSegment){for(_this._lassoBounds=_this.lassoSegment.view.getBounds(),_ref1=_this.floatingBlocks,_j=0,_len1=_ref1.length;_len1>_j;_j++)float=_ref1[_j],_this.lassoSegment===float.block&&_this._lassoBounds.translate(float.position);_this.lassoSegment!==_this.selection&&(_this._lassoBounds.stroke(mainCtx,"#000"),_this._lassoBounds.fill(mainCtx,"rgba(0, 0, 256, 0.3)"))}for(_ref2=_this.floatingBlocks,_results=[],_k=0,_len2=_ref2.length;_len2>_k;_k++)float=_ref2[_k],view=float.block.view,view.compute(),view.translate(float.position),_results.push(view.draw(mainCtx));return _results},this.attemptReparse=function(){try{return _this.tree=coffee.parse(_this.getValue()).segment,_this.redraw()}catch(_error){}},moveBlockTo=function(block,target){var parent;for(parent=block.start.prev;null!=parent&&("newline"===parent.type||"segmentStart"===parent.type&&parent.segment!==_this.tree||"cursor"===parent.type);)parent=parent.prev;return _this.undoStack.push({block:block,target:null!=parent?function(){switch(parent.type){case"indentStart":case"indentEnd":return parent.indent;case"blockStart":case"blockEnd":return parent.block;case"socketStart":case"socketEnd":return parent.socket;case"segmentStart":case"segmentEnd":return parent.segment;default:return parent}}():null}),block.moveTo(target),null!=_this.onChange?_this.onChange(new IceEditorChangeEvent(block,target)):void 0},this.undo=function(){var head,lastOperation,operation;if(_this.undoStack.length>0){for(operation=lastOperation={target:null};null==operation.target&&operation.block===lastOperation.block&&(operation=_this.undoStack.pop(),null!=operation);)if(null!=operation.target)switch(operation.target.type){case"indent":for(head=operation.target.end.prev;"segmentEnd"===head.type||"segmentStart"===head.type||"cursor"===head.type;)head=head.prev;operation.block.moveTo("newline"===head.type?operation.target.start.next:operation.target.start.insert(new NewlineToken));break;case"block":operation.block.moveTo(operation.target.end.insert(new NewlineToken));break;case"socket":null!=operation.target.content()&&operation.target.content().remove(),operation.block.moveTo(operation.target.start);break;default:operation.target===_this.tree&&(operation.block.moveTo(_this.tree.start),operation.block.end.next!==_this.tree.end&&operation.block.end.insert(new NewlineToken))}else operation.block.moveTo(operation.target);return _this.redraw(),null!=_this.onChange?_this.onChange(new IceEditorChangeEvent(operation.block,operation.target)):void 0}},this.redrawPalette=function(){var lastBottomEdge,_j,_len1,_ref1,_results;for(lastBottomEdge=0,_ref1=_this.paletteBlocks,_results=[],_j=0,_len1=_ref1.length;_len1>_j;_j++)paletteBlock=_ref1[_j],paletteBlock.view.compute(),paletteBlock.view.translate(new draw.Point(0,lastBottomEdge)),lastBottomEdge=paletteBlock.view.bounds[paletteBlock.view.lineEnd].bottom()+PALETTE_MARGIN,_results.push(paletteBlock.view.draw(paletteCtx));return _results},this.redrawPalette(),insertHandwrittenBlock=function(){var newBlock,newSocket;return newBlock=new Block([]),newSocket=new Socket([]),newSocket.handwritten=!0,newBlock.start.insert(newSocket.start),newBlock.end.prev.insert(newSocket.end),"newline"===_this.cursor.next.type||"indentEnd"===_this.cursor.next.type||"segmentEnd"===_this.cursor.next.type?("indentEnd"===_this.cursor.next.type&&"newline"===_this.cursor.prev.type?moveBlockTo(newBlock,_this.cursor.prev):moveBlockTo(newBlock,_this.cursor.prev.insert(new NewlineToken)),_this.redraw(),setTextInputFocus(newSocket)):("newline"===_this.cursor.prev.type||"segmentStart"===_this.cursor.prev.type)&&(moveBlockTo(newBlock,_this.cursor.prev),newBlock.end.insert(new NewlineToken),_this.redraw(),setTextInputFocus(newSocket)),scrollCursorIntoView()},scrollCursorIntoView=function(){return _this.redraw(),_this.cursor.view.point.y<_this.scrollOffset.y?(mainCtx.translate(0,_this.scrollOffset.y-_this.cursor.view.point.y),_this.scrollOffset.y=_this.cursor.view.point.y,_this.redraw()):_this.cursor.view.point.y>_this.scrollOffset.y+main.height?(mainCtx.translate(0,_this.scrollOffset.y+main.height-_this.cursor.view.point.y),_this.scrollOffset.y=_this.cursor.view.point.y-main.height,_this.redraw()):void 0},moveCursorTo=function(token){var head,_ref1;if(_this.cursor.remove(),head=token,head!==_this.tree.start)for(;null!=head&&"newline"!==(_ref1=head.type)&&"indentEnd"!==_ref1&&"segmentEnd"!==_ref1;)head=head.next;return null!=head?("newline"===head.type||head===_this.tree.start?head.insert(_this.cursor):head.insertBefore(_this.cursor),scrollCursorIntoView()):void 0},moveCursorBefore=function(token){return _this.cursor.remove(),token.insertBefore(_this.cursor),scrollCursorIntoView()},deleteFromCursor=function(){var head;for(head=_this.cursor.prev;null!==head&&"indentStart"!==head.type&&"blockEnd"!==head.type;)head=head.prev;return null!==head?("blockEnd"===head.type&&(moveBlockTo(head.block,null),_this.redraw()),scrollCursorIntoView()):void 0},moveCursorUp=function(){var depth,head,_ref1,_ref2;for(head=_this.cursor.prev.prev;null!==head&&"newline"!==(_ref1=head.type)&&"indentEnd"!==_ref1&&"segmentStart"!==_ref1;)head=head.prev;if(null!==head){for("indentEnd"===head.type?moveCursorBefore(head):moveCursorTo(head),head=_this.cursor,depth=0;"blockEnd"!==(_ref2=head.type)&&"indentEnd"!==_ref2&&"segmentEnd"!==_ref2||0!==depth;){switch(head.type){case"blockStart":case"indentStart":case"segmentStart":case"socketStart":depth+=1;break;case"blockEnd":case"indentEnd":case"segmentEnd":case"socketEnd":depth-=1}head=head.next}return"blockEnd"===head.type?moveCursorUp():void 0}},moveCursorDown=function(){var depth,head,_ref1,_ref2;for(head=_this.cursor.next.next;null!==head&&"newline"!==(_ref1=head.type)&&"indentEnd"!==_ref1&&"segmentEnd"!==_ref1;)head=head.next;if(null!==head){for("indentEnd"===head.type||"segmentEnd"===head.type?moveCursorBefore(head):moveCursorTo(head),head=_this.cursor,depth=0;"blockEnd"!==(_ref2=head.type)&&"indentEnd"!==_ref2&&"segmentEnd"!==_ref2||0!==depth;){switch(head.type){case"blockStart":case"indentStart":case"segmentStart":case"socketStart":depth+=1;break;case"blockEnd":case"indentEnd":case"segmentEnd":case"socketEnd":depth-=1}head=head.next}return"blockEnd"===head.type?moveCursorDown():void 0}},_ref1=["input","keydown","keyup","keypress"],_j=0,_len1=_ref1.length;_len1>_j;_j++)eventName=_ref1[_j],this.hiddenInput.addEventListener(eventName,function(){return _this.isEditingText()?redrawTextInput():!0});this.hiddenInput.addEventListener("keydown",function(event){var head,newIndent,_ref2,_ref3,_ref4,_ref5;if(!_this.isEditingText())return!0;switch(event.keyCode){case 13:return _this.handwritten?insertHandwrittenBlock():(setTextInputFocus(null),_this.hiddenInput.blur(),_this.redraw());case 8:if(_this.handwritten&&0===_this.hiddenInput.value.length)return deleteFromCursor(),setTextInputFocus(null),_this.hiddenInput.blur();break;case 9:if(_this.handwritten){for(head=_this.focus.start.prev.prev;null!==head&&"blockEnd"!==head.type&&"blockStart"!==head.type;)head=head.prev;if("blockStart"!==head.type)return"indentEnd"===head.prev.type?(moveBlockTo(_this.focus.start.prev.block,head.prev.prev.insert(new NewlineToken)),moveCursorTo(_this.focus.start.prev.block.end),_this.redraw(),event.preventDefault(),!1):(newIndent=new Indent([],INDENT_SPACES),head.prev.insert(newIndent.start),head.prev.insert(newIndent.end),moveBlockTo(_this.focus.start.prev.block,newIndent.start.insert(new NewlineToken)),moveCursorTo(_this.focus.start.prev.block.end),_this.redraw(),event.preventDefault(),!1)}break;case 38:return setTextInputFocus(null),_this.hiddenInput.blur(),moveCursorUp(),_this.redraw();case 40:return setTextInputFocus(null),_this.hiddenInput.blur(),moveCursorDown(),_this.redraw();case 37:if(_this.hiddenInput.selectionStart===_this.hiddenInput.selectionEnd&&0===_this.hiddenInput.selectionStart){for(head=_this.focus.start;null!=head&&("socketEnd"!==head.type||"block"===(_ref2=null!=(_ref3=head.socket.content())?_ref3.type:void 0)||"socket"===_ref2);)head=head.prev;if(null==head)return;return setTextInputFocus(head.socket)}break;case 39:if(_this.hiddenInput.selectionStart===_this.hiddenInput.selectionEnd&&_this.hiddenInput.selectionStart===_this.hiddenInput.value.length){for(head=_this.focus.end;null!=head&&("socketStart"!==head.type||"block"===(_ref4=null!=(_ref5=head.socket.content())?_ref5.type:void 0)||"socket"===_ref4);)head=head.next;if(null==head)return;return setTextInputFocus(head.socket)}}}),this.hiddenInput.addEventListener("blur",function(event){return event.target!==document.activeElement?setTextInputFocus(null):void 0}),document.body.addEventListener("keydown",function(event){var head,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8;if("INPUT"!==(_ref2=event.target.tagName)&&"TEXTAREA"!==_ref2){switch(event.keyCode){case 13:_this.isEditingText()||insertHandwrittenBlock();break;case 38:null!=_this.cursor&&moveCursorUp();break;case 40:null!=_this.cursor&&moveCursorDown();break;case 8:null!=_this.cursor&&deleteFromCursor();break;case 37:if(null!=_this.cursor){for(head=_this.cursor;null!=head&&("socketEnd"!==head.type||"block"===(_ref3=null!=(_ref4=head.socket.content())?_ref4.type:void 0)||"socket"===_ref3);)head=head.prev;if(null==head)return;setTextInputFocus(head.socket)}break;case 39:if(null!=_this.cursor){for(head=_this.cursor;null!=head&&("socketStart"!==head.type||"block"===(_ref5=null!=(_ref6=head.socket.content())?_ref6.type:void 0)||"socket"===_ref5);)head=head.next;if(null==head)return;setTextInputFocus(head.socket)}}return(13===(_ref7=event.keyCode)||38===_ref7||40===_ref7||8===_ref7)&&_this.redraw(),13===(_ref8=event.keyCode)||38===_ref8||40===_ref8||8===_ref8||37===_ref8?event.preventDefault():void 0}}),hitTest=function(point,root){var head,seek;for(head=root,seek=null;head!==seek;)"blockStart"===head.type&&head.block.view.path.contains(point)&&(seek=head.block.end),head=head.next;return null!=seek?seek.block:null},hitTestRoot=function(point){return hitTest(point,_this.tree.start)},hitTestFloating=function(point){var float,_k,_len2,_ref2;for(_ref2=_this.floatingBlocks,_k=0,_len2=_ref2.length;_len2>_k;_k++)if(float=_ref2[_k],null!==hitTest(point,float.block.start))return float.block;return null},hitTestFocus=function(point){var head;for(head=_this.tree.start;null!==head;){if("socketStart"===head.type&&("text"===head.next.type||"socketEnd"===head.next.type)&&head.socket.view.bounds[head.socket.view.lineStart].contains(point))return head.socket;head=head.next}return null},hitTestLasso=function(point){return null!=_this.lassoSegment&&_this._lassoBounds.contains(point)?_this.lassoSegment:null},hitTestPalette=function(point){var block,_k,_len2,_ref2;for(point=new draw.Point(point.x+PALETTE_WIDTH,point.y),_ref2=_this.paletteBlocks,_k=0,_len2=_ref2.length;_len2>_k;_k++)if(block=_ref2[_k],null!=hitTest(point,block.start))return block;return null},getPointFromEvent=function(event){switch(!1){case null==event.offsetX:return new draw.Point(event.offsetX-PALETTE_WIDTH,event.offsetY+_this.scrollOffset.y);case!event.layerX:return new draw.Point(event.layerX-PALETTE_WIDTH,event.layerY+_this.scrollOffset.y)}},track.addEventListener("mousedown",function(event){var flag,float,point,selectionInPalette,_k,_len2,_ref2,_ref3,_ref4,_ref5,_ref6;if(0===event.button){if(_this.hiddenInput.blur(),point=getPointFromEvent(event),_this.ephemeralSelection=null!=(_ref2=null!=(_ref3=null!=(_ref4=null!=(_ref5=hitTestFloating(point))?_ref5:hitTestLasso(point))?_ref4:hitTestFocus(point))?_ref3:hitTestRoot(point))?_ref2:hitTestPalette(point),null==_this.ephemeralSelection){if(null!=_this.lassoSegment){for(flag=!1,_ref6=_this.floatingBlocks,_k=0,_len2=_ref6.length;_len2>_k;_k++)if(float=_ref6[_k],float.block===_this.lassoSegment){flag=!0;break}flag||_this.lassoSegment.remove(),_this.lassoSegment=null,_this.redraw()}return _this.lassoAnchor=point}return"socket"===_this.ephemeralSelection.type?(setTextInputFocus(_this.ephemeralSelection),_this.ephemeralSelection=null,setTimeout(function(){return setTextInputAnchor(point),redrawTextInput(),textInputSelecting=!0},0)):(selectionInPalette=!1,_this.ephemeralPoint=new draw.Point(point.x,point.y),moveCursorTo(_this.ephemeralSelection.end))}}),track.addEventListener("mousemove",function(event){var dest,fixedDest,float,head,i,next_head,old_highlight,point,rect,selectionInPalette,_k,_len2,_ref2,_ref3;if(null!=_this.ephemeralSelection&&(point=getPointFromEvent(event),point.from(_this.ephemeralPoint).magnitude()>MIN_DRAG_DISTANCE)){for(_this.selection=_this.ephemeralSelection,_this.ephemeralSelection=null,head=_this.selection.start;head!==_this.selection.end;)next_head=head.next,"cursor"===head.type&&head.remove(),head=next_head;for(_ref2=_this.selection,__indexOf.call(_this.paletteBlocks,_ref2)>=0&&(_this.ephemeralPoint.add(PALETTE_WIDTH,0),selectionInPalette=!0),rect=_this.selection.view.bounds[_this.selection.view.lineStart],offset=_this.ephemeralPoint.from(new draw.Point(rect.x,rect.y)),selectionInPalette&&(_this.selection=_this.selection.clone()),_ref3=_this.floatingBlocks,i=_k=0,_len2=_ref3.length;_len2>_k;i=++_k)if(float=_ref3[i],float.block===_this.selection){_this.floatingBlocks.splice(i,1);break}moveBlockTo(_this.selection,null),_this.selection.view.compute(),_this.selection.view.draw(dragCtx),fixedDest=selectionInPalette?new draw.Point(rect.x-PALETTE_WIDTH,rect.y):new draw.Point(rect.x-_this.scrollOffset.x,rect.y-_this.scrollOffset.y),drag.style.webkitTransform=drag.style.mozTransform=drag.style.transform="translate("+fixedDest.x+"px, "+fixedDest.y+"px)",_this.redraw()}return null!=_this.selection?(point=getPointFromEvent(event),point.add(-_this.scrollOffset.x,-_this.scrollOffset.y),fixedDest=new draw.Point(-offset.x+point.x,-offset.y+point.y),point.translate(_this.scrollOffset),dest=new draw.Point(-offset.x+point.x,-offset.y+point.y),old_highlight=highlight,highlight=_this.tree.find(function(block){var _ref4;return!(null!=(_ref4="function"==typeof block.inSocket?block.inSocket():void 0)?_ref4:!1)&&null!=block.view.dropArea&&block.view.dropArea.contains(dest)}),old_highlight!==highlight&&_this.redraw(),null!=highlight&&highlight.view.dropHighlightReigon.fill(mainCtx,"#fff"),drag.style.webkitTransform=drag.style.mozTransform=drag.style.transform="translate("+fixedDest.x+"px, "+fixedDest.y+"px)"):void 0}),track.addEventListener("mouseup",function(event){var dest,head,point;if(null!=_this.ephemeralSelection&&(_this.ephemeralSelection=null,_this.ephemeralPoint=null),null!=_this.selection){if(point=getPointFromEvent(event),dest=new draw.Point(-offset.x+point.x,-offset.y+point.y),null!=highlight)switch(highlight.type){case"indent":for(head=highlight.end.prev;"segmentEnd"===head.type||"segmentStart"===head.type||"cursor"===head.type;)head=head.prev;"newline"===head.type?moveBlockTo(_this.selection,highlight.start.next):moveBlockTo(_this.selection,highlight.start.insert(new NewlineToken));break;case"block":moveBlockTo(_this.selection,highlight.end.insert(new NewlineToken));break;case"socket":null!=highlight.content()&&highlight.content().remove(),moveBlockTo(_this.selection,highlight.start);break;default:highlight===_this.tree&&(moveBlockTo(_this.selection,_this.tree.start),_this.selection.end.next!==_this.tree.end&&_this.selection.end.insert(new NewlineToken))}else dest.x>0?_this.floatingBlocks.push({position:dest,block:_this.selection}):_this.selection===_this.lassoSegment&&(_this.lassoSegment=null);return drag.style.webkitTransform=drag.style.mozTransform=drag.style.transform="translate(0px, 0px)",dragCtx.clearRect(0,0,drag.width,drag.height),null!=highlight&&moveCursorTo(_this.selection.end),_this.selection=null,_this.redraw()}}),getRectFromPoints=function(a,b){return new draw.Rectangle(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.abs(a.x-b.x),Math.abs(a.y-b.y))},track.addEventListener("mousemove",function(event){var point,rect;return null!=_this.lassoAnchor?(point=getPointFromEvent(event),point.add(-_this.scrollOffset.x,-_this.scrollOffset.y),rect=getRectFromPoints(new draw.Point(_this.lassoAnchor.x-_this.scrollOffset.x,_this.lassoAnchor.y-_this.scrollOffset.y),point),dragCtx.clearRect(0,0,drag.width,drag.height),dragCtx.strokeStyle="#00f",dragCtx.strokeRect(rect.x,rect.y,rect.width,rect.height)):void 0}),track.addEventListener("mouseup",function(event){var depth,firstLassoed,head,lastLassoed,point,rect,tokensToInclude;if(null!=_this.lassoAnchor){for(point=getPointFromEvent(event),rect=getRectFromPoints(_this.lassoAnchor,point),head=_this.tree.start,firstLassoed=null;head!==_this.tree.end;){if("blockStart"===head.type&&head.block.view.path.intersects(rect)){firstLassoed=head;break}head=head.next}for(head=_this.tree.end,lastLassoed=null;head!==_this.tree.start;){if("blockEnd"===head.type&&head.block.view.path.intersects(rect)){lastLassoed=head;break}head=head.prev}if(null!=firstLassoed&&null!=lastLassoed){for(tokensToInclude=[],head=firstLassoed;head!==lastLassoed;){switch(head.type){case"blockStart":case"blockEnd":tokensToInclude.push(head.block.start),tokensToInclude.push(head.block.end);break;case"indentStart":case"indentEnd":tokensToInclude.push(head.indent.start),tokensToInclude.push(head.indent.end);break;case"segmentStart":case"segmentEnd":tokensToInclude.push(head.segment.start),tokensToInclude.push(head.segment.end)}head=head.next}for(head=_this.tree.start;head!==_this.tree.end;){if(__indexOf.call(tokensToInclude,head)>=0){firstLassoed=head;break}head=head.next}for(head=_this.tree.end,lastLassoed=null;head!==_this.tree.start;){if(__indexOf.call(tokensToInclude,head)>=0){lastLassoed=head;break}head=head.prev}if("indentStart"===firstLassoed.type){for(depth=0;depth>0||"blockStart"!==head.type;)"blockStart"===firstLassoed.type?depth-=1:"blockEnd"===firstLassoed.type&&(depth+=1),firstLassoed=firstLassoed.prev;lastLassoed=firstLassoed.block.end}if("indentStart"===firstLassoed.type){for(depth=0;depth>0||"blockEnd"!==head.type;)"blockEnd"===lastLassoed.type?depth-=1:"blockStart"===lastLassoed.type&&(depth+=1);firstLassoed=lastLassoed.block.start}_this.lassoSegment=new Segment([]),firstLassoed.insertBefore(_this.lassoSegment.start),lastLassoed.insert(_this.lassoSegment.end),_this.redraw()}return dragCtx.clearRect(0,0,drag.width,drag.height),null!=_this.lassoSegment&&moveCursorTo(_this.lassoSegment.end),_this.lassoAnchor=null,_this.redraw()}}),redrawTextInput=function(){var end,start;return _this.editedText.value=_this.hiddenInput.value,_this.redraw(),start=_this.editedText.view.bounds[_editedInputLine].x+mainCtx.measureText(_this.hiddenInput.value.slice(0,_this.hiddenInput.selectionStart)).width,end=_this.editedText.view.bounds[_editedInputLine].x+mainCtx.measureText(_this.hiddenInput.value.slice(0,_this.hiddenInput.selectionEnd)).width,start===end?mainCtx.strokeRect(start,_this.editedText.view.bounds[_editedInputLine].y,0,INPUT_LINE_HEIGHT):(mainCtx.fillStyle="rgba(0, 0, 256, 0.3",mainCtx.fillRect(start,_this.editedText.view.bounds[_editedInputLine].y,end-start,INPUT_LINE_HEIGHT))},setTextInputFocus=function(focus){var depth,head,newParse,_ref2,_ref3;if(console.log("changing focus",_this.focus,focus),null!=_this.focus){try{console.log("trying",_this.focus.toString()),newParse=coffee.parse(_this.focus.toString()).next,console.log("here now",newParse),"blockStart"===newParse.type&&(_this.focus.handwritten?(newParse.block.moveTo(_this.focus.start.prev.block.start.prev),_this.focus.start.prev.block.moveTo(null)):("text"===(null!=(_ref2=_this.focus.content())?_ref2.type:void 0)?_this.focus.content().remove():"block"===(null!=(_ref3=_this.focus.content())?_ref3.type:void 0)&&_this.focus.content().moveTo(null),newParse.block.moveTo(_this.focus.start)))}catch(_error){}null!=_this.onChange&&_this.onChange(new IceEditorChangeEvent(_this.focus,focus))}if(_this.focus=focus,null!==_this.focus){if(_editedInputLine=_this.focus.view.lineStart,_this.handwritten=_this.focus.handwritten,_this.focus.content()){if("text"!==_this.focus.content().type)throw"Cannot edit occupied socket.";_this.editedText=_this.focus.content()}else _this.editedText=new TextToken(""),_this.focus.start.insert(_this.editedText);for(head=_this.focus.end,depth=0;"newline"!==head.type&&"indentEnd"!==head.type&&"segmentEnd"!==head.type;)head=head.next;return"newline"===head.type?moveCursorTo(head):moveCursorBefore(head),_this.hiddenInput.value=_this.editedText.value,setTimeout(function(){return _this.hiddenInput.focus()},0)}},setTextInputHead=function(point){return textInputHead=Math.round((point.x-_this.focus.view.bounds[_editedInputLine].x)/mainCtx.measureText(" ").width),_this.hiddenInput.setSelectionRange(Math.min(textInputAnchor,textInputHead),Math.max(textInputAnchor,textInputHead))},setTextInputAnchor=function(point){return textInputAnchor=textInputHead=Math.round((point.x-_this.focus.view.bounds[_editedInputLine].x-PADDING)/mainCtx.measureText(" ").width),_this.hiddenInput.setSelectionRange(textInputAnchor,textInputHead)},track.addEventListener("mousemove",function(event){var point;return _this.isEditingText()&&textInputSelecting?(point=getPointFromEvent(event),setTextInputHead(point),redrawTextInput()):void 0}),track.addEventListener("mouseup",function(){return _this.isEditingText()?textInputSelecting=!1:void 0}),track.addEventListener("mousewheel",function(event){return _this.clear(),event.wheelDelta>0?_this.scrollOffset.y>=100?(_this.scrollOffset.add(0,-100),mainCtx.translate(0,100)):(mainCtx.translate(0,_this.scrollOffset.y),_this.scrollOffset.y=0):(_this.scrollOffset.add(0,100),mainCtx.translate(0,-100)),_this.redraw()})}return Editor.prototype.setValue=function(value){return this.tree=coffee.parse(value).segment,this.redraw()},Editor.prototype.getValue=function(){return this.tree.toString()},Editor}(),window.onload=function(){var paletteElement;return window.editor=new Editor(document.getElementById("editor"),function(){var _i,_len,_ref,_results;for(_ref=["for i in [1..10]\n  alert 'hello'","alert 'hello'","if a is b\n  alert 'hi'\nelse\n  alert 'bye'","a = b"],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)paletteElement=_ref[_i],_results.push(coffee.parse(paletteElement).next.block);return _results}()),editor.setValue("for i in [1..10]\n  if i % 2 is 0\n    alert i\n    alert 'bye'\n  else\n    alert 'fizz'\n  alert 'buzz'"),editor.onChange=function(){return document.getElementById("out").value=editor.getValue()},document.getElementById("out").addEventListener("input",function(){try{return editor.setValue(this.value)}catch(_error){}}),document.getElementById("undo").addEventListener("click",function(){return editor.undo()})}}).call(this);