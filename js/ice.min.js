/*! ice-editor 2014-02-06 */
(function(){var Block,BlockEndToken,BlockPaper,BlockStartToken,CursorToken,CursorTokenPaper,DEFAULT_CURSOR_WIDTH,DROP_AREA_MAX_WIDTH,EMPTY_INDENT_WIDTH,EMPTY_SEGMENT_DROP_WIDTH,Editor,FONT_SIZE,INDENT,INDENT_SPACES,INPUT_LINE_HEIGHT,IcePaper,Indent,IndentEndToken,IndentPaper,IndentStartToken,MIN_INDENT_DROP_WIDTH,MOUTH_BOTTOM,NewlineToken,PADDING,PALETTE_MARGIN,PALETTE_WHITESPACE,PALETTE_WIDTH,Segment,SegmentEndToken,SegmentPaper,SegmentStartToken,Socket,SocketEndToken,SocketPaper,SocketStartToken,TextToken,TextTokenPaper,Token,exports,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};exports={},exports.Block=Block=function(){function Block(contents){var head,token,_i,_len;for(this.start=new BlockStartToken(this),this.end=new BlockEndToken(this),this.type="block",this.color="#ddf",this.selected=!1,head=this.start,_i=0,_len=contents.length;_len>_i;_i++)token=contents[_i],head=head.append(token.clone());head.append(this.end),this.paper=new BlockPaper(this)}return Block.prototype.embedded=function(){return"socketStart"===this.start.prev.type},Block.prototype.contents=function(){var contents,head;for(contents=[],head=this.start;head!==this.end;)contents.push(head),head=head.next;return contents.push(this.end),contents},Block.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Block([]),clone.color=this.color,head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:"cursorToken"!==head.type&&(cursor=cursor.append(head.clone()))}head=head.next}return cursor.append(clone.end),clone},Block.prototype.inSocket=function(){var head;for(head=this.start.prev;null!=head&&"segmentStart"===head.type;)head=head.prev;return null!=head&&"socketStart"===head.type},Block.prototype.lines=function(){var contents,currentLine,head;for(contents=[],currentLine=[],head=this.start;head!==this.end;)contents.push(head),"newline"===head.type&&(contents.push(currentLine),currentLine=[]),head=head.next;return currentLine.push(this.end),contents.push(currentLine),contents},Block.prototype._moveTo=function(parent){for(var first,last;null!=this.start.prev&&"segmentStart"===this.start.prev.type&&this.start.prev.segment.end===this.end.next;)this.start.prev.segment.remove();if(null!=this.end.next&&null!=this.start.prev){for(last=this.end.next;null!=last&&("segmentEnd"===last.type||"cursor"===last.type);)last=last.next;for(first=this.start.prev;null!=first&&("segmentStart"===first.type||"cursor"===first.type);)first=first.prev;null==first||"newline"!==first.type||null!=last&&"newline"!==last.type&&"indentEnd"!==last.type?null==last||"newline"!==last.type||null!=first&&"newline"!==first.type||last.remove():first.remove()}return null!=this.start.prev&&(this.start.prev.next=this.end.next),null!=this.end.next&&(this.end.next.prev=this.start.prev),this.start.prev=this.end.next=null,null!=parent?(this.end.next=parent.next,parent.next.prev=this.end,parent.next=this.start,this.start.prev=parent):void 0},Block.prototype.findBlock=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.findBlock(f);head=head.next}return f(this)?this:null},Block.prototype.findSocket=function(f){var head;for(head=this.start.next;head!==this.end;){if("socketStart"===head.type&&f(head.socket))return head.socket.findSocket(f);head=head.next}return null},Block.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Block.prototype.toString=function(){var string;return string=this.start.toString({indent:""}),string.slice(0,+(string.length-this.end.toString({indent:""}).length-1)+1||9e9)},Block}(),exports.Indent=Indent=function(){function Indent(contents,depth){var block,head,_i,_len;for(this.depth=depth,this.start=new IndentStartToken(this),this.end=new IndentEndToken(this),this.type="indent",head=this.start,_i=0,_len=contents.length;_len>_i;_i++)block=contents[_i],head=head.append(block.clone());head.append(this.end),this.paper=new IndentPaper(this)}return Indent.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Indent([],this.depth),head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:"cursorToken"!==head.type&&(cursor=cursor.append(head.clone()))}head=head.next}return cursor.append(clone.end),clone},Indent.prototype.embedded=function(){return!1},Indent.prototype.toString=function(state){var string;return string=this.start.toString(state),string.slice(0,string.length-this.end.toString(state).length-1)},Indent.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Indent}(),exports.Segment=Segment=function(){function Segment(contents){var block,head,_i,_len;for(this.start=new SegmentStartToken(this),this.end=new SegmentEndToken(this),this.type="segment",head=this.start,_i=0,_len=contents.length;_len>_i;_i++)block=contents[_i],head=head.append(block.clone());head.append(this.end),this.paper=new SegmentPaper(this)}return Segment.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Segment([]),head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:"cursorToken"!==head.type&&(cursor=cursor.append(head.clone()))}head=head.next}return cursor.append(clone.end),clone},Segment.prototype.embedded=function(){return!1},Segment.prototype.remove=function(){return this.start.remove(),this.end.remove(),this.start.next=this.end,this.end.prev=this.start},Segment.prototype._moveTo=function(parent){for(var first,last;null!=this.start.prev&&"segmentStart"===this.start.prev.type&&this.start.prev.segment.end===this.end.next;)this.start.prev.segment.remove();if(null!=this.end.next&&null!=this.start.prev){for(last=this.end.next;null!=last&&("segmentEnd"===last.type||"cursor"===last.type);)last=last.next;for(first=this.start.prev;null!=first&&("segmentStart"===first.type||"cursor"===first.type);)first=first.prev;null==first||"newline"!==first.type||null!=last&&"newline"!==last.type&&"indentEnd"!==last.type?null==last||"newline"!==last.type||null!=first&&"newline"!==first.type||last.remove():first.remove()}return null!=this.start.prev&&(this.start.prev.next=this.end.next),null!=this.end.next&&(this.end.next.prev=this.start.prev),this.start.prev=this.end.next=null,null!=parent?(this.end.next=parent.next,parent.next.prev=this.end,parent.next=this.start,this.start.prev=parent):void 0},Segment.prototype.findBlock=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.findBlock(f);head=head.next}return null},Segment.prototype.findSocket=function(f){var head;for(head=this.start.next;head!==this.end;){if("socketStart"===head.type&&f(head.socket))return head.socket.findSocket(f);head=head.next}return null},Segment.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Segment.prototype.toString=function(){var start;return start=this.start.toString({indent:""}),start.slice(0,start.length-this.end.toString({indent:""}).length)},Segment}(),exports.Socket=Socket=function(){function Socket(content){this.start=new SocketStartToken(this),this.end=new SocketEndToken(this),null!=content&&null!=content.start?(this.start.next=content.start,content.start.prev=this.start,this.end.prev=content.end,content.end.next=this.end):null!=content?(this.start.next=content,content.prev=this.start,this.end.prev=content,content.next=this.end):(this.start.next=this.end,this.end.prev=this.start),this.type="socket",this.handwritten=!1,this.paper=new SocketPaper(this)}return Socket.prototype.clone=function(){return null!=this.content()?new Socket(this.content().clone()):new Socket},Socket.prototype.embedded=function(){return!1},Socket.prototype.content=function(){var unwrap;return unwrap=function(el){switch(el.type){case"blockStart":return el.block;case"segmentStart":return unwrap(el.next);default:return el}},this.start.next!==this.end?unwrap(this.start.next):null},Socket.prototype.findSocket=function(f){var head;for(head=this.start.next;head!==this.end;){if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Socket.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Socket.prototype.toString=function(){return null!=this.content()?this.content().toString({indent:""}):""},Socket}(),exports.Token=Token=function(){function Token(){this.prev=this.next=null}return Token.prototype.append=function(token){return token.prev=this,this.next=token},Token.prototype.insert=function(token){return null!=this.next&&(token.next=this.next,this.next.prev=token),token.prev=this,this.next=token,this.next},Token.prototype.insertBefore=function(token){return null!=this.prev&&(token.prev=this.prev,this.prev.next=token),token.next=this,this.prev=token,this.prev},Token.prototype.remove=function(){return null!=this.prev&&(this.prev.next=this.next),null!=this.next&&(this.next.prev=this.prev),this.prev=this.next=null},Token.prototype.toString=function(state){return null!=this.next?this.next.toString(state):""},Token}(),exports.CursorToken=CursorToken=function(_super){function CursorToken(){this.prev=this.next=null,this.paper=new CursorTokenPaper(this),this.type="cursor"}return __extends(CursorToken,_super),CursorToken}(Token),exports.TextToken=TextToken=function(_super){function TextToken(value){this.value=value,this.prev=this.next=null,this.paper=new TextTokenPaper(this),this.type="text"}return __extends(TextToken,_super),TextToken.prototype.clone=function(){return new TextToken(this.value)},TextToken.prototype.toString=function(state){return this.value+(null!=this.next?this.next.toString(state):"")},TextToken}(Token),exports.BlockStartToken=BlockStartToken=function(_super){function BlockStartToken(block){this.block=block,this.prev=this.next=null,this.type="blockStart"}return __extends(BlockStartToken,_super),BlockStartToken}(Token),exports.BlockEndToken=BlockEndToken=function(_super){function BlockEndToken(block){this.block=block,this.prev=this.next=null,this.type="blockEnd"}return __extends(BlockEndToken,_super),BlockEndToken}(Token),exports.NewlineToken=NewlineToken=function(_super){function NewlineToken(){this.prev=this.next=null,this.type="newline"}return __extends(NewlineToken,_super),NewlineToken.prototype.clone=function(){return new NewlineToken},NewlineToken.prototype.toString=function(state){return"\n"+state.indent+(this.next?this.next.toString(state):"")},NewlineToken}(Token),exports.IndentStartToken=IndentStartToken=function(_super){function IndentStartToken(indent){this.indent=indent,this.prev=this.next=null,this.type="indentStart"}return __extends(IndentStartToken,_super),IndentStartToken.prototype.toString=function(state){return state.indent+=function(){var _i,_ref,_results;for(_results=[],_i=1,_ref=this.indent.depth;_ref>=1?_ref>=_i:_i>=_ref;_ref>=1?_i++:_i--)_results.push(" ");return _results}.call(this).join(""),this.next?this.next.toString(state):""},IndentStartToken}(Token),exports.IndentEndToken=IndentEndToken=function(_super){function IndentEndToken(indent){this.indent=indent,this.prev=this.next=null,this.type="indentEnd"}return __extends(IndentEndToken,_super),IndentEndToken.prototype.toString=function(state){return state.indent=state.indent.slice(0,-this.indent.depth),this.next?this.next.toString(state):""},IndentEndToken}(Token),exports.SocketStartToken=SocketStartToken=function(_super){function SocketStartToken(socket){this.socket=socket,this.prev=this.next=null,this.type="socketStart"}return __extends(SocketStartToken,_super),SocketStartToken}(Token),exports.SocketEndToken=SocketEndToken=function(_super){function SocketEndToken(socket){this.socket=socket,this.prev=this.next=null,this.type="socketEnd"}return __extends(SocketEndToken,_super),SocketEndToken}(Token),exports.SegmentStartToken=SegmentStartToken=function(_super){function SegmentStartToken(segment){this.segment=segment,this.prev=this.next=null,this.type="segmentStart"}return __extends(SegmentStartToken,_super),SegmentStartToken}(Token),exports.SegmentEndToken=SegmentEndToken=function(_super){function SegmentEndToken(segment){this.segment=segment,this.prev=this.next=null,this.type="segmentEnd"}return __extends(SegmentEndToken,_super),SegmentEndToken}(Token),exports.lispParse=function(str){var block,block_stack,char,currentString,first,head,socket,socket_stack,_i,_len;for(currentString="",first=head=new TextToken(""),block_stack=[],socket_stack=[],_i=0,_len=str.length;_len>_i;_i++)switch(char=str[_i]){case"(":head=head.append(new TextToken(currentString)),block_stack.push(block=new Block([])),socket_stack.push(socket=new Socket(block)),head=head.append(socket.start),head=head.append(block.start),head=head.append(new TextToken("(")),currentString="";break;case")":head=head.append(new TextToken(currentString)),head=head.append(new TextToken(")")),head=head.append(block_stack.pop().end),head=head.append(socket_stack.pop().end),currentString="";break;case" ":head=head.append(new TextToken(currentString)),head=head.append(new TextToken(" ")),currentString="";break;case"\n":head=head.append(new TextToken(currentString)),head=head.append(new NewlineToken),currentString="";break;default:currentString+=char}return head=head.append(new TextToken(currentString)),first},exports.indentParse=function(str){var block,char,currentString,depth_stack,first,head,indent,line,popped,socket,stack,_i,_j,_len,_len1,_ref,_ref1;for(head=first=new TextToken(""),stack=[],depth_stack=[0],_ref=str.split("\n"),_i=0,_len=_ref.length;_len>_i;_i++){for(line=_ref[_i],indent=line.length-line.trimLeft().length,indent>_.last(depth_stack)&&(head=head.append(new Indent([],indent-_.last(depth_stack)).start),stack.push(head.indent),depth_stack.push(indent));indent<_.last(depth_stack);)head=head.append(stack.pop().end),depth_stack.pop();for(head=head.append(new NewlineToken),currentString="",_ref1=line.trimLeft(),_j=0,_len1=_ref1.length;_len1>_j;_j++)switch(char=_ref1[_j]){case"(":currentString.length>0&&(head=head.append(new TextToken(currentString))),stack.length>0&&"block"===_.last(stack).type&&(stack.push(socket=new Socket(block)),head=head.append(socket.start)),stack.push(block=new Block([])),head=head.append(block.start),head=head.append(new TextToken("(")),currentString="";break;case")":for(currentString.length>0&&(head=head.append(new TextToken(currentString))),popped={};"block"!==popped.type;)popped=stack.pop(),"block"===popped.type&&(head=head.append(new TextToken(")"))),head=head.append(popped.end),"indentEnd"===head.type&&depth_stack.pop();stack.length>0&&"socket"===_.last(stack).type&&(head=head.append(stack.pop().end)),currentString="";break;case" ":currentString.length>0&&(head=head.append(new TextToken(currentString))),head=head.append(new TextToken(" ")),currentString="";break;default:currentString+=char}currentString.length>0&&(head=head.append(new TextToken(currentString)))}for(;stack.length>0;)head=head.append(stack.pop().end);return first.next.next},window.ICE=exports,PADDING=5,INDENT=10,MOUTH_BOTTOM=50,DROP_AREA_MAX_WIDTH=50,FONT_SIZE=15,EMPTY_INDENT_WIDTH=50,PALETTE_WIDTH=300,PALETTE_WHITESPACE=10,MIN_INDENT_DROP_WIDTH=20,EMPTY_SEGMENT_DROP_WIDTH=100,DEFAULT_CURSOR_WIDTH=100,window.RUN_PAPER_TESTS=!1,window.PERFORMANCE_TEST=!1,IcePaper=function(){function IcePaper(block){this.block=block,this.point=new draw.Point(0,0),this.group=new draw.Group,this.bounds={},this.lineGroups={},this.children=[],this.lineStart=this.lineEnd=0}return IcePaper.prototype.compute=function(){return this},IcePaper.prototype.finish=function(){var child,_i,_len,_ref,_results;for(_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.finish());return _results},IcePaper.prototype.draw=function(){},IcePaper.prototype.setLeftCenter=function(){},IcePaper.prototype.translate=function(vector){return this.point.translate(vector),this.group.translate(vector)},IcePaper.prototype.position=function(point){return this.translate(this.point.from(point))},IcePaper}(),BlockPaper=function(_super){function BlockPaper(block){BlockPaper.__super__.constructor.call(this,block),this._lineChildren={},this.indented={},this.indentEnd={}}return __extends(BlockPaper,_super),BlockPaper.prototype.compute=function(state){var axis,head,height,i,indent,line,top,_i,_ref,_ref1;for(this.indented={},this.indentEnd={},this._pathBits={},this.bounds={},this.lineGroups={},this.children=[],this.lineStart=state.line,head=this.block.start.next;head!==this.block.end;){switch(head.type){case"text":this.children.push(head.paper.compute(state)),this.group.push(head.paper.group);break;case"blockStart":this.children.push(head.block.paper.compute(state)),this.group.push(head.block.paper.group),head=head.block.end;break;case"indentStart":indent=head.indent.paper.compute(state),this.children.push(indent),this.group.push(indent.group),head=head.indent.end;break;case"socketStart":this.children.push(head.socket.paper.compute(state)),this.group.push(head.socket.paper.group),head=head.socket.end;break;case"newline":state.line+=1}head=head.next}for(this.lineEnd=state.line,i=0,top=0,axis=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(this._lineChildren[line]=[],this._pathBits[line]={left:[],right:[]},this.lineGroups[line]=new draw.Group,this.bounds[line]=new draw.NoRectangle;i<this.children.length&&line>this.children[i].lineEnd;)i+=1;for(;i<this.children.length&&line>=this.children[i].lineStart&&line<=this.children[i].lineEnd;)this._lineChildren[line].push(this.children[i]),i+=1;i-=1,height=this._computeHeight(line),axis=top+height/2,this.setLeftCenter(line,new draw.Point(0,axis)),top+=this.bounds[line].height}return this},BlockPaper.prototype._computeHeight=function(line){var child,height,_heightModifier,_i,_len,_ref;for(height=0,_heightModifier=0,_ref=this._lineChildren[line],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],height="indent"===child.block.type&&line===child.lineEnd?Math.max(height,child.bounds[line].height+10):Math.max(height,child.bounds[line].height);return(this.indented[line]||this._lineChildren[line].length>0&&"indent"===this._lineChildren[line][0].block.type)&&(height-=2*PADDING),height+2*PADDING},BlockPaper.prototype.setLeftCenter=function(line,point){var child,cursor,i,indentChild,topPoint,_bottomModifier,_i,_len,_ref;for(cursor=point.clone(),cursor.add(PADDING,0),this.lineGroups[line].empty(),this._pathBits[line].left.length=0,this._pathBits[line].right.length=0,this.bounds[line].clear(),this.bounds[line].swallow(point),_bottomModifier=0,topPoint=null,this.indented[line]=this.indentEnd[line]=!1,indentChild=null,_ref=this._lineChildren[line],i=_i=0,_len=_ref.length;_len>_i;i=++_i)child=_ref[i],0===i&&"indent"===child.block.type?(this.indented[line]=!0,this.indentEnd[line]=line===child.lineEnd||child.indentEnd[line],cursor.add(INDENT,0),indentChild=child,child.setLeftCenter(line,new draw.Point(cursor.x,cursor.y-this._computeHeight(line)/2+child.bounds[line].height/2)),0===child.bounds[line].height?(this._pathBits[line].right.push(topPoint=new draw.Point(child.bounds[line].x,child.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(child.bounds[line].x,child.bounds[line].y+10)),this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].y+10)),this._lineChildren[line].length>1&&this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].y-5-PADDING))):(this._pathBits[line].right.push(topPoint=new draw.Point(child.bounds[line].x,child.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(child.bounds[line].x,child.bounds[line].bottom())),line===child.lineEnd&&this._lineChildren[line].length>1&&(this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].bottom())),this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].y)))),child.lineEnd===line&&(_bottomModifier+=INDENT)):(this.indented[line]=this.indented[line]||(null!=child.indented?child.indented[line]:!1),this.indentEnd[line]=this.indentEnd[line]||(null!=child.indentEnd?child.indentEnd[line]:!1),null!=child.indentEnd&&child.indentEnd[line]?child.setLeftCenter(line,new draw.Point(cursor.x,cursor.y-this._computeHeight(line)/2+child.bounds[line].height/2)):child.setLeftCenter(line,cursor)),this.lineGroups[line].push(child.lineGroups[line]),this.bounds[line].unite(child.bounds[line]),cursor.add(child.bounds[line].width,0);return this.indented[line]||(this.bounds[line].width+=PADDING,this.bounds[line].y-=PADDING,this.bounds[line].height+=2*PADDING),null!=topPoint&&(topPoint.y=this.bounds[line].y),this._pathBits[line].left.push(new draw.Point(this.bounds[line].x,this.bounds[line].y)),this._pathBits[line].left.push(new draw.Point(this.bounds[line].x,this.bounds[line].bottom()+_bottomModifier)),"indent"===this._lineChildren[line][0].block.type&&this._lineChildren[line][0].lineStart===line&&(child=this._lineChildren[line][0],this._pathBits[line].right.unshift(new draw.Point(this.bounds[line].x+INDENT+PADDING+10,this.bounds[line].y)),this._pathBits[line].right.unshift(new draw.Point(this.bounds[line].x+INDENT+PADDING+10,this.bounds[line].y+5)),this._pathBits[line].right.unshift(new draw.Point(this.bounds[line].x+INDENT+PADDING+30,this.bounds[line].y+5)),this._pathBits[line].right.unshift(new draw.Point(this.bounds[line].x+INDENT+PADDING+30,this.bounds[line].y))),this.indentEnd[line]&&this._lineChildren[line].length>1?(this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom()+_bottomModifier)),this.bounds[line].height+=10):!this.indented[line]||"indent"===this._lineChildren[line][0].block.type&&this._lineChildren[line][0].lineEnd===line?"indent"===this._lineChildren[line][0].block.type&&this._lineChildren[line][0].lineEnd===line?(this._lineChildren[line].length>1?(this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom()+_bottomModifier))):(this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom())),this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom()+_bottomModifier))),this.bounds[line].height+=10):(this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom()+_bottomModifier))):(this._pathBits[line].right.push(new draw.Point(this.bounds[line].x+INDENT+PADDING,this.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(this.bounds[line].x+INDENT+PADDING,this.bounds[line].bottom())))},BlockPaper.prototype.finish=function(){var bit,child,line,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2,_results;this._container=new draw.Path,this.block.inSocket()||(this._container.push(new draw.Point(this.bounds[this.lineStart].x+10,this.bounds[this.lineStart].y)),this._container.push(new draw.Point(this.bounds[this.lineStart].x+10,this.bounds[this.lineStart].y+5)),this._container.push(new draw.Point(this.bounds[this.lineStart].x+30,this.bounds[this.lineStart].y+5)));for(line in this._pathBits){for(_ref=this._pathBits[line].left,_i=0,_len=_ref.length;_len>_i;_i++)bit=_ref[_i],this._container.unshift(bit);for(_ref1=this._pathBits[line].right,_j=0,_len1=_ref1.length;_len1>_j;_j++)bit=_ref1[_j],this._container.push(bit)}for(this.block.inSocket()||(this._container.unshift(new draw.Point(this.bounds[this.lineEnd].x+10,this.bounds[this.lineEnd].bottom()+5)),this._container.unshift(new draw.Point(this.bounds[this.lineEnd].x+30,this.bounds[this.lineEnd].bottom()+5)),this._container.unshift(new draw.Point(this.bounds[this.lineEnd].x+30,this.bounds[this.lineEnd].bottom()))),this._container.style.strokeColor=this.block.selected?"#FFF":"#000",this._container.style.fillColor=this.block.color,this.dropArea=new draw.Rectangle(this.bounds[this.lineEnd].x,this.bounds[this.lineEnd].bottom()-5,this.bounds[this.lineEnd].width,10),this.topCursorArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,this.bounds[this.lineStart].width,10),_ref2=this.children,_results=[],_k=0,_len2=_ref2.length;_len2>_k;_k++)child=_ref2[_k],_results.push(child.finish());return _results},BlockPaper.prototype.draw=function(ctx){var child,_i,_len,_ref,_results;for(this._container.draw(ctx),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.draw(ctx));return _results},BlockPaper.prototype.translate=function(vector){var bit,child,line,point,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2,_ref3,_results;this.point.translate(vector);for(line in this.bounds)this.lineGroups[line].translate(vector),this.bounds[line].translate(vector);_ref=this._pathBits;for(line in _ref){for(bit=_ref[line],_ref1=bit.left,_i=0,_len=_ref1.length;_len>_i;_i++)point=_ref1[_i],point.translate(vector);for(_ref2=bit.right,_j=0,_len1=_ref2.length;_len1>_j;_j++)point=_ref2[_j],point.translate(vector)}for(_ref3=this.children,_results=[],_k=0,_len2=_ref3.length;_len2>_k;_k++)child=_ref3[_k],_results.push(child.translate(vector));return _results},BlockPaper}(IcePaper),SocketPaper=function(_super){function SocketPaper(block){SocketPaper.__super__.constructor.call(this,block),this._empty=!1,this._content=null,this._line=0,this.indented={},this.children=[]}return __extends(SocketPaper,_super),SocketPaper.prototype.compute=function(state){var contentPaper,line;if(this.bounds={},this.lineGroups={},this.group=new draw.Group,this.dropArea=null,null!=(this._content=this.block.content())){(contentPaper=this._content.paper).compute(state);for(line in contentPaper.bounds)"text"===this._content.type?(this._line=state.line,this.bounds[line]=new draw.NoRectangle,this.bounds[line].copy(contentPaper.bounds[line]),this.bounds[line].y-=PADDING,this.bounds[line].width+=2*PADDING,this.bounds[line].x-=PADDING,this.bounds[line].height+=2*PADDING,this.bounds[line].width=Math.max(this.bounds[line].width,20),this.dropArea=this.bounds[line]):this.bounds[line]=contentPaper.bounds[line],this.lineGroups[line]=contentPaper.lineGroups[line];this.indented=this._content.paper.indented,this.indentEnd=this._content.paper.indentEnd,this.group=contentPaper.group,this.children=[this._content.paper],this.lineStart=contentPaper.lineStart,this.lineEnd=contentPaper.lineEnd}else this.dropArea=this.bounds[state.line]=new draw.Rectangle(0,0,20,20),this.lineStart=this.lineEnd=this._line=state.line,this.children=[],this.indented={},this.indented[this._line]=!1,this.lineGroups[this._line]=new draw.Group;return this._empty=null==this._content||"text"===this._content.type,this},SocketPaper.prototype.setLeftCenter=function(line,point){return null!=this._content?("text"===this._content.type?(line=this._content.paper._line,this._content.paper.setLeftCenter(line,new draw.Point(point.x+PADDING,point.y)),this.bounds[line].copy(this._content.paper.bounds[line]),this.bounds[line].y-=PADDING,this.bounds[line].width+=2*PADDING,this.bounds[line].x-=PADDING,this.bounds[line].height+=2*PADDING,this.bounds[line].width=Math.max(this.bounds[line].width,20)):this._content.paper.setLeftCenter(line,point),this.lineGroups[line].recompute()):(this.bounds[line].x=point.x,this.bounds[line].y=point.y-this.bounds[line].height/2,this.lineGroups[line].setPosition(new draw.Point(point.x,point.y-this.bounds[line].height/2)))},SocketPaper.prototype.draw=function(ctx){var line,rect;return null!=this._content?("text"===this._content.type&&(line=this._content.paper._line,ctx.strokeStyle="#000",ctx.fillStyle="#fff",ctx.fillRect(this.bounds[line].x,this.bounds[line].y,this.bounds[line].width,this.bounds[line].height),ctx.strokeRect(this.bounds[line].x,this.bounds[line].y,this.bounds[line].width,this.bounds[line].height)),this._content.paper.draw(ctx)):(rect=this.bounds[this._line],ctx.strokeStyle="#000",ctx.fillStyle="#fff",ctx.fillRect(rect.x,rect.y,rect.width,rect.height),ctx.strokeRect(rect.x,rect.y,rect.width,rect.height))},SocketPaper.prototype.translate=function(vector){var line;return null==this._content?this.bounds[this._line].translate(vector):(this._content.paper.translate(vector),"text"===this._content.type?(line=this._content.paper._line,this.bounds[line].copy(this._content.paper.bounds[line]),this.bounds[line].y-=PADDING,this.bounds[line].width+=2*PADDING,this.bounds[line].x-=PADDING,this.bounds[line].height+=2*PADDING,this.bounds[line].width=Math.max(this.bounds[line].width,20)):void 0)},SocketPaper}(IcePaper),CursorTokenPaper=function(_super){function CursorTokenPaper(block){CursorTokenPaper.__super__.constructor.call(this,block),this._rect=new draw.NoRectangle}return __extends(CursorTokenPaper,_super),CursorTokenPaper.prototype.compute=function(state){return this.lineStart=this.lineEnd=state.line,this},CursorTokenPaper.prototype.setRect=function(rect){return this._rect=rect,this.useTop=!1},CursorTokenPaper.prototype.setRectTop=function(rect){return this._rect=rect,this.useTop=!0
},CursorTokenPaper.prototype.finish=function(){},CursorTokenPaper.prototype.draw=function(ctx){var _this=this;return setTimeout(function(){var y;return ctx.strokeStyle="#000",ctx.fillStyle="#FFF",y=_this.useTop?_this._rect.y:_this._rect.bottom(),ctx.beginPath(),ctx.moveTo(_this._rect.x,y),ctx.lineTo(_this._rect.x-5,y+5),ctx.lineTo(_this._rect.x-5,y-5),ctx.lineTo(_this._rect.x,y),ctx.lineTo(_this._rect.x+_this._rect.width,y),ctx.lineTo(_this._rect.x+_this._rect.width+5,y-5),ctx.lineTo(_this._rect.x+_this._rect.width+5,y+5),ctx.lineTo(_this._rect.x+_this._rect.width,y),ctx.stroke(),ctx.fill()},0)},CursorTokenPaper}(IcePaper),IndentPaper=function(_super){function IndentPaper(block){IndentPaper.__super__.constructor.call(this,block),this._lineBlocks={}}return __extends(IndentPaper,_super),IndentPaper.prototype.compute=function(state){var head,i,line,setCursor,_i,_ref,_ref1;for(this.bounds={},this.lineGroups={},this._lineBlocks={},this.indentEnd={},this.group=new draw.Group,this.children=[],this.lineStart=state.line+=1,head=this.block.start.next,"cursor"===head.type&&(head=head.next),"newline"===head.type&&(head=head.next),this.block.start.next===this.block.end&&(head=this.block.end);head!==this.block.end;){switch(head.type){case"blockStart":this.children.push(head.block.paper.compute(state)),this.group.push(head.block.paper.group),head=head.block.end;break;case"cursor":this.children.push(head.paper.compute(state)),this.group.push(head.paper.group);break;case"newline":state.line+=1}head=head.next}if(this.lineEnd=state.line,this.children.length>0)for(i=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(;!(line<=this.children[i].lineEnd);)i+=1;setCursor=!1,null!=this.children[i]&&"cursor"===this.children[i].block.type&&(setCursor=!0,i+=1),this.bounds[line]=this.children[i].bounds[line],this.lineGroups[line]=new draw.Group,this.indentEnd[line]=this.children[i].indentEnd[line],this.lineGroups[line].push(this.children[i].lineGroups[line]),this._lineBlocks[line]=this.children[i],setCursor?this.children[i-1].setRectTop(this.bounds[line]):null!=this.children[i+1]&&"cursor"===this.children[i+1].block.type&&this.children[i+1].setRect(this.bounds[line])}else this.lineGroups[this.lineStart]=new draw.Group,this._lineBlocks[this.lineStart]=null,this.bounds[this.lineStart]=new draw.Rectangle(0,0,EMPTY_INDENT_WIDTH,0);return this},IndentPaper.prototype.finish=function(){var child,_i,_len,_ref,_results;for(this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,Math.max(this.bounds[this.lineStart].width,MIN_INDENT_DROP_WIDTH),10),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.finish());return _results},IndentPaper.prototype.setLeftCenter=function(line,point){return null!=this._lineBlocks[line]?(this._lineBlocks[line].setLeftCenter(line,point),this.lineGroups[line].recompute()):(this.bounds[this.lineStart].clear(),this.bounds[this.lineStart].swallow(point),this.bounds[this.lineStart].width=EMPTY_INDENT_WIDTH)},IndentPaper.prototype.draw=function(ctx){var child,_i,_len,_ref,_results;for(_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.draw(ctx));return _results},IndentPaper.prototype.translate=function(vector){var child,_i,_len,_ref,_results;for(this.point.add(vector),0===this.bounds[this.lineStart].height&&this.bounds[this.lineStart].translate(vector),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.translate(vector));return _results},IndentPaper.prototype.setPosition=function(point){return this.translate(point.from(this.point))},IndentPaper}(IcePaper),SegmentPaper=function(_super){function SegmentPaper(block){SegmentPaper.__super__.constructor.call(this,block),this._lineBlocks={}}return __extends(SegmentPaper,_super),SegmentPaper.prototype.compute=function(state){var head,i,line,running_height,_i,_ref,_ref1;for(this.bounds={},this.lineGroups={},this._lineBlocks={},this.indentEnd={},this.group=new draw.Group,this.children=[],this.lineStart=state.line+=1,head=this.block.start.next,this.block.start.next===this.block.end&&(head=this.block.end),running_height=0;head!==this.block.end;){switch(head.type){case"blockStart":this.children.push(head.block.paper.compute(state)),head.block.paper.translate(new draw.Point(0,running_height)),running_height=head.block.paper.bounds[head.block.paper.lineEnd].bottom(),this.group.push(head.block.paper.group),head=head.block.end;break;case"cursor":this.children.push(head.paper.compute(state)),this.children.length>2?head.paper.setRect(new draw.Rectangle(0,running_height,this.children[this.children.length-2].bounds[this.children[this.children.length-2].lineEnd].width,0)):head.paper.setRect(new draw.Rectangle(0,running_height,DEFAULT_CURSOR_WIDTH,0)),this.group.push(head.paper.group);break;case"newline":state.line+=1}head=head.next}if(this.lineEnd=state.line,0===this.children.length)return this.bounds[state.line]=new draw.Rectangle(0,0,0,0),this;for(i=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(;!(line<=this.children[i].lineEnd&&"cursor"!==this.children[i].block.type);)i+=1;this.bounds[line]=this.children[i].bounds[line],this.lineGroups[line]=new draw.Group,this.indentEnd[line]=this.children[i].indentEnd[line],this.lineGroups[line].push(this.children[i].lineGroups[line]),this._lineBlocks[line]=this.children[i]}return this},SegmentPaper.prototype.prepBounds=function(){var head,i,line,running_height,_i,_ref,_ref1;for(this.bounds={},this.lineGroups={},this._lineBlocks={},this.indentEnd={},this.group=new draw.Group,this.children=[],this.lineStart=1/0,this.lineEnd=0,head=this.block.start.next,this.block.start.next===this.block.end&&(head=this.block.end),running_height=0;head!==this.block.end;){switch(head.type){case"blockStart":this.children.push(head.block.paper),this.lineStart=Math.min(this.lineStart,head.block.paper.lineStart),this.lineEnd=Math.max(this.lineEnd,head.block.paper.lineEnd),head=head.block.end}head=head.next}for(i=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(;!(line<=this.children[i].lineEnd);)i+=1;this.bounds[line]=this.children[i].bounds[line]}return this},SegmentPaper.prototype.getBounds=function(){var bounds,head;for(head=this.block.start.next,this.block.start.next===this.block.end&&(head=this.block.end),bounds=new draw.NoRectangle;head!==this.block.end;){switch(head.type){case"blockStart":bounds.unite(head.block.paper._container.bounds())}head=head.next}return bounds},SegmentPaper.prototype.finish=function(){var child,_i,_len,_ref,_results;for(this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,Math.max(this.bounds[this.lineStart].width,MIN_INDENT_DROP_WIDTH),10),0===this.bounds[this.lineStart].width&&(this.dropArea.width=EMPTY_SEGMENT_DROP_WIDTH),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.finish());return _results},SegmentPaper.prototype.setLeftCenter=function(line,point){return null!=this._lineBlocks[line]?(this._lineBlocks[line].setLeftCenter(line,point),this.lineGroups[line].recompute()):(this.bounds[this.lineStart].clear(),this.bounds[this.lineStart].swallow(point),this.bounds[this.lineStart].width=EMPTY_INDENT_WIDTH)},SegmentPaper.prototype.draw=function(ctx){var child,_i,_len,_ref,_results;for(_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.draw(ctx));return _results},SegmentPaper.prototype.translate=function(vector){var child,_i,_len,_ref,_results;for(this.point.add(vector),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.translate(vector));return _results},SegmentPaper.prototype.setPosition=function(point){return this.translate(point.from(this.point))},SegmentPaper}(IcePaper),TextTokenPaper=function(_super){function TextTokenPaper(block){TextTokenPaper.__super__.constructor.call(this,block),this._line=0}return __extends(TextTokenPaper,_super),TextTokenPaper.prototype.compute=function(state){return this.lineStart=this.lineEnd=this._line=state.line,this.lineGroups={},this.bounds={},this.group=this.lineGroups[this._line]=new draw.Group,this.lineGroups[this._line].push(this._text=new draw.Text(new draw.Point(0,0),this.block.value)),this.bounds[this._line]=this._text.bounds(),this},TextTokenPaper.prototype.draw=function(ctx){return this._text.draw(ctx)},TextTokenPaper.prototype.setLeftCenter=function(line,point){return line===this._line?(this._text.setPosition(new draw.Point(point.x,point.y-this.bounds[this._line].height/2)),this.lineGroups[this._line].recompute()):void 0},TextTokenPaper.prototype.translate=function(vector){return this._text.translate(vector)},TextTokenPaper}(IcePaper),INDENT_SPACES=2,INPUT_LINE_HEIGHT=15,PALETTE_MARGIN=10,exports.Editor=Editor=function(){function Editor(el,paletteBlocks){var child,deleteFromCursor,drag,dragCtx,eventName,getPointFromEvent,getRectFromPoints,highlight,hitTest,hitTestFloating,hitTestFocus,hitTestLasso,hitTestPalette,hitTestRoot,insertHandwrittenBlock,main,mainCtx,moveCursorBefore,moveCursorDown,moveCursorTo,moveCursorUp,offset,palette,paletteBlock,paletteCtx,redrawTextInput,setTextInputAnchor,setTextInputFocus,setTextInputHead,textInputAnchor,textInputHead,textInputSelecting,track,_editedInputLine,_i,_j,_len,_len1,_ref,_ref1,_this=this;for(this.paletteBlocks=paletteBlocks,null==this.paletteBlocks&&(this.paletteBlocks=[]),this.paletteBlocks=function(){var _i,_len,_ref,_results;for(_ref=this.paletteBlocks,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)paletteBlock=_ref[_i],_results.push(paletteBlock.clone());return _results}.call(this),this.tree=null,this.floatingBlocks=[],this.focus=null,this.editedText=null,this.handwritten=!1,this.hiddenInput=null,this.isEditingText=function(){return _this.hiddenInput===document.activeElement},textInputAnchor=textInputHead=null,textInputSelecting=!1,_editedInputLine=-1,this.selection=null,this.lassoSegment=null,this._lassoBounds=null,this.cursor=new CursorToken,this.scrollOffset=new draw.Point(0,0),offset=null,highlight=null,main=document.createElement("canvas"),main.className="canvas",main.height=el.offsetHeight,main.width=el.offsetWidth-PALETTE_WIDTH,palette=document.createElement("canvas"),palette.className="palette",palette.height=el.offsetHeight,palette.width=PALETTE_WIDTH,drag=document.createElement("canvas"),drag.className="drag",drag.height=el.offsetHeight,drag.width=el.offsetWidth-PALETTE_WIDTH,this.hiddenInput=document.createElement("input"),this.hiddenInput.className="hidden_input",track=document.createElement("div"),track.className="trackArea",_ref=[main,palette,drag,track,this.hiddenInput],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],el.appendChild(child);for(mainCtx=main.getContext("2d"),dragCtx=drag.getContext("2d"),paletteCtx=palette.getContext("2d"),draw._setCTX(mainCtx),this.clear=function(){return mainCtx.clearRect(_this.scrollOffset.x,_this.scrollOffset.y,main.width,main.height)},this.redraw=function(){var float,paper,_j,_k,_len1,_len2,_ref1,_ref2,_results;if(_this.clear(),_this.tree.paper.compute({line:0}),_this.tree.paper.finish(),_this.tree.paper.draw(mainCtx),null!=_this.lassoSegment){for(_this.lassoSegment.paper.prepBounds(),_this._lassoBounds=_this.lassoSegment.paper.getBounds(),_ref1=_this.floatingBlocks,_j=0,_len1=_ref1.length;_len1>_j;_j++)float=_ref1[_j],_this.lassoSegment===float.block&&_this._lassoBounds.translate(float.position);_this.lassoSegment!==_this.selection&&(_this._lassoBounds.stroke(mainCtx,"#000"),_this._lassoBounds.fill(mainCtx,"rgba(0, 0, 256, 0.3)"))}for(_ref2=_this.floatingBlocks,_results=[],_k=0,_len2=_ref2.length;_len2>_k;_k++)float=_ref2[_k],paper=float.block.paper,paper.compute({line:0}),paper.translate(float.position),paper.finish(),_results.push(paper.draw(mainCtx));return _results},this.attemptReparse=function(){try{return _this.tree=coffee.parse(_this.getValue()).segment,_this.redraw()}catch(_error){}},this.redrawPalette=function(){var lastBottomEdge,_j,_len1,_ref1,_results;for(lastBottomEdge=0,_ref1=_this.paletteBlocks,_results=[],_j=0,_len1=_ref1.length;_len1>_j;_j++)paletteBlock=_ref1[_j],paletteBlock.paper.compute({line:0}),paletteBlock.paper.translate(new draw.Point(0,lastBottomEdge)),lastBottomEdge=paletteBlock.paper.bounds[paletteBlock.paper.lineEnd].bottom()+PALETTE_MARGIN,paletteBlock.paper.finish(),_results.push(paletteBlock.paper.draw(paletteCtx));return _results},this.redrawPalette(),insertHandwrittenBlock=function(){var newBlock,newSocket;return newBlock=new Block([]),newSocket=new Socket([]),newSocket.handwritten=!0,newBlock.start.insert(newSocket.start),newBlock.end.prev.insert(newSocket.end),"newline"===_this.cursor.next.type||"indentEnd"===_this.cursor.next.type||"segmentEnd"===_this.cursor.next.type?(newBlock._moveTo(_this.cursor.prev.insert(new NewlineToken)),_this.redraw(),setTextInputFocus(newSocket)):"newline"===_this.cursor.prev.type||"segmentStart"===_this.cursor.prev.type?(newBlock._moveTo(_this.cursor.prev),newBlock.end.insert(new NewlineToken),_this.redraw(),setTextInputFocus(newSocket)):void 0},moveCursorTo=function(token){return _this.cursor.remove(),token.insert(_this.cursor)},moveCursorBefore=function(token){return _this.cursor.remove(),token.insertBefore(_this.cursor)},deleteFromCursor=function(){var head,_ref1;for(head=_this.cursor.prev,console.log(head,head.toString({indent:""}));null!==head&&"indentStart"!==head.type&&"blockEnd"!==head.type;)console.log(head,null!=(_ref1=head.block)?"function"==typeof _ref1.toString?_ref1.toString():void 0:void 0),head=head.prev,console.log(head.toString({indent:""}));return console.log(head.toString({indent:""})),"blockEnd"===head.type?(head.block._moveTo(null),_this.redraw()):void 0},moveCursorUp=function(){var head,_ref1;for(head=_this.cursor.prev.prev;null!==head&&"newline"!==(_ref1=head.type)&&"indentEnd"!==_ref1&&"segmentStart"!==_ref1;)head=head.prev;return null!==head?"indentEnd"===head.type?moveCursorBefore(head):moveCursorTo(head):void 0},moveCursorDown=function(){var head,_ref1;for(head=_this.cursor.next.next;null!==head&&"newline"!==(_ref1=head.type)&&"indentEnd"!==_ref1&&"segmentEnd"!==_ref1;)head=head.next;return null!==head?"indentEnd"===head.type||"segmentEnd"===head.type?moveCursorBefore(head):moveCursorTo(head):void 0},_ref1=["input","keydown","keyup","keypress"],_j=0,_len1=_ref1.length;_len1>_j;_j++)eventName=_ref1[_j],this.hiddenInput.addEventListener(eventName,function(){return _this.isEditingText()?redrawTextInput():!0});this.hiddenInput.addEventListener("keydown",function(event){var head,newIndent;if(!_this.isEditingText())return!0;switch(event.keyCode){case 13:return _this.handwritten?insertHandwrittenBlock():(setTextInputFocus(null),_this.hiddenInput.blur(),_this.redraw());case 8:if(_this.handwritten&&0===_this.hiddenInput.value.length)return deleteFromCursor(),setTextInputFocus(null),_this.hiddenInput.blur();break;case 9:if(_this.handwritten){for(head=_this.focus.start.prev.prev;null!==head&&"blockEnd"!==head.type&&"blockStart"!==head.type;)head=head.prev;if("blockStart"!==head.type)return"indentEnd"===head.prev.type?(_this.focus.start.prev.block._moveTo(head.prev.prev.insert(new NewlineToken)),moveCursorTo(_this.focus.start.prev.block.end),_this.redraw(),event.preventDefault(),!1):(newIndent=new Indent([],INDENT_SPACES),head.prev.insert(newIndent.start),head.prev.insert(newIndent.end),_this.focus.start.prev.block._moveTo(newIndent.start.insert(new NewlineToken)),moveCursorTo(_this.focus.start.prev.block.end),_this.redraw(),event.preventDefault(),!1)}break;case 38:return setTextInputFocus(null),_this.hiddenInput.blur(),moveCursorUp(),_this.redraw();case 40:return setTextInputFocus(null),_this.hiddenInput.blur(),moveCursorDown(),_this.redraw()}}),document.body.addEventListener("keydown",function(event){var head,_ref2,_ref3;if("INPUT"!==(_ref2=event.target.tagName)&&"TEXTAREA"!==_ref2){switch(event.keyCode){case 13:_this.isEditingText()||insertHandwrittenBlock();break;case 38:null!=_this.cursor&&moveCursorUp();break;case 40:null!=_this.cursor&&moveCursorDown();break;case 8:null!=_this.cursor&&deleteFromCursor();break;case 37:if(null!=_this.cursor){for(head=_this.cursor;"socketEnd"!==head.type;)head=head.prev;setTextInputFocus(head.socket)}}return 13===(_ref3=event.keyCode)||38===_ref3||40===_ref3||8===_ref3?_this.redraw():void 0}}),hitTest=function(point,root){var head,seek;for(head=root,seek=null;head!==seek;)"blockStart"===head.type&&head.block.paper._container.contains(point)&&(seek=head.block.end),head=head.next;return null!=seek?seek.block:null},hitTestRoot=function(point){return hitTest(point,_this.tree.start)},hitTestFloating=function(point){var float,_k,_len2,_ref2;for(_ref2=_this.floatingBlocks,_k=0,_len2=_ref2.length;_len2>_k;_k++)if(float=_ref2[_k],null!==hitTest(point,float.block.start))return float.block;return null},hitTestFocus=function(point){var head;for(head=_this.tree.start;null!==head;){if("socketStart"===head.type&&("text"===head.next.type||"socketEnd"===head.next.type)&&head.socket.paper.bounds[head.socket.paper._line].contains(point))return head.socket;head=head.next}return null},hitTestLasso=function(point){return null!=_this.lassoSegment&&_this._lassoBounds.contains(point)?_this.lassoSegment:null},hitTestPalette=function(point){var block,_k,_len2,_ref2;for(point=new draw.Point(point.x+PALETTE_WIDTH,point.y),_ref2=_this.paletteBlocks,_k=0,_len2=_ref2.length;_len2>_k;_k++)if(block=_ref2[_k],null!=hitTest(point,block.start))return block;return null},getPointFromEvent=function(event){switch(!1){case null==event.offsetX:return new draw.Point(event.offsetX-PALETTE_WIDTH,event.offsetY+_this.scrollOffset.y);case!event.layerX:return new draw.Point(event.layerX-PALETTE_WIDTH,event.layerY+_this.scrollOffset.y)}},track.addEventListener("mousedown",function(event){var fixedDest,flag,float,i,point,rect,selectionInPalette,_k,_l,_len2,_len3,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8;if(point=getPointFromEvent(event),_this.selection=null!=(_ref2=null!=(_ref3=null!=(_ref4=null!=(_ref5=hitTestFloating(point))?_ref5:hitTestLasso(point))?_ref4:hitTestFocus(point))?_ref3:hitTestRoot(point))?_ref2:hitTestPalette(point),null==_this.selection){if(null!=_this.lassoSegment){for(flag=!1,_ref6=_this.floatingBlocks,_k=0,_len2=_ref6.length;_len2>_k;_k++)if(float=_ref6[_k],float.block===_this.lassoSegment){flag=!0;break}flag||_this.lassoSegment.remove(),_this.lassoSegment=null,_this.redraw()}return _this.lassoAnchor=point}if("socket"===_this.selection.type)return setTextInputFocus(_this.selection),setTimeout(function(){return console.log("setting anchor",_this.focus),setTextInputAnchor(point),redrawTextInput(),textInputSelecting=!0,_this.selection=null},0);for(selectionInPalette=!1,_ref7=_this.selection,__indexOf.call(_this.paletteBlocks,_ref7)>=0&&(point.add(PALETTE_WIDTH,0),selectionInPalette=!0),rect=_this.selection.paper.bounds[_this.selection.paper.lineStart],offset=point.from(new draw.Point(rect.x,rect.y)),selectionInPalette&&(_this.selection=_this.selection.clone()),_ref8=_this.floatingBlocks,i=_l=0,_len3=_ref8.length;_len3>_l;i=++_l)if(float=_ref8[i],float.block===_this.selection){_this.floatingBlocks.splice(i,1);break}return _this.selection._moveTo(null),_this.selection.paper.compute({line:0}),_this.selection.paper.finish(),_this.selection.paper.draw(dragCtx),fixedDest=selectionInPalette?new draw.Point(rect.x-PALETTE_WIDTH,rect.y):new draw.Point(rect.x-_this.scrollOffset.x,rect.y-_this.scrollOffset.y),drag.style.webkitTransform=drag.style.mozTransform=drag.style.transform="translate("+fixedDest.x+"px, "+fixedDest.y+"px)",_this.redraw()}),track.addEventListener("mousemove",function(event){var dest,fixedDest,old_highlight,point;return null!=_this.selection?(point=getPointFromEvent(event),point.add(-_this.scrollOffset.x,-_this.scrollOffset.y),fixedDest=new draw.Point(-offset.x+point.x,-offset.y+point.y),point.translate(_this.scrollOffset),dest=new draw.Point(-offset.x+point.x,-offset.y+point.y),old_highlight=highlight,highlight=_this.tree.find(function(block){var _ref2;return!(null!=(_ref2="function"==typeof block.inSocket?block.inSocket():void 0)?_ref2:!1)&&null!=block.paper.dropArea&&block.paper.dropArea.contains(dest)}),old_highlight!==highlight&&_this.redraw(),null!=highlight&&highlight.paper.dropArea.fill(mainCtx,"#fff"),drag.style.webkitTransform=drag.style.mozTransform=drag.style.transform="translate("+fixedDest.x+"px, "+fixedDest.y+"px)"):void 0}),track.addEventListener("mouseup",function(event){var dest,head,point;if(null!=_this.selection){if(point=getPointFromEvent(event),dest=new draw.Point(-offset.x+point.x,-offset.y+point.y),null!=highlight)switch(highlight.type){case"indent":_this.selection._moveTo(highlight.start.insert(new NewlineToken));break;case"block":_this.selection._moveTo(highlight.end.insert(new NewlineToken));break;case"socket":null!=highlight.content()&&highlight.content().remove(),_this.selection._moveTo(highlight.start);break;default:highlight===_this.tree&&(_this.selection._moveTo(_this.tree.start),_this.selection.end.insert(new NewlineToken))}else point.x>0&&_this.floatingBlocks.push({position:dest,block:_this.selection});if(drag.style.webkitTransform=drag.style.mozTransform=drag.style.transform="translate(0px, 0px)",dragCtx.clearRect(0,0,drag.width,drag.height),null!=highlight){for(head=_this.selection.end;head!==_this.tree.end&&"newline"!==head.type;)head=head.next;head===_this.tree.end?moveCursorBefore(head):moveCursorTo(head)}return _this.selection=null,_this.redraw()}}),getRectFromPoints=function(a,b){return new draw.Rectangle(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.abs(a.x-b.x),Math.abs(a.y-b.y))},track.addEventListener("mousemove",function(event){var point,rect;return null!=_this.lassoAnchor?(point=getPointFromEvent(event),point.translate(_this.scrollOffset),rect=getRectFromPoints(_this.lassoAnchor,point),dragCtx.clearRect(0,0,drag.width,drag.height),dragCtx.strokeStyle="#00f",dragCtx.strokeRect(rect.x,rect.y,rect.width,rect.height)):void 0}),track.addEventListener("mouseup",function(event){var depth,firstLassoed,head,lastLassoed,point,rect,tokensToInclude;if(null!=_this.lassoAnchor){for(point=getPointFromEvent(event),point.translate(_this.scrollOffset),rect=getRectFromPoints(_this.lassoAnchor,point),head=_this.tree.start,firstLassoed=null;head!==_this.tree.end;){if("blockStart"===head.type&&head.block.paper._container.intersects(rect)){firstLassoed=head;break}head=head.next}for(head=_this.tree.end,lastLassoed=null;head!==_this.tree.start;){if("blockEnd"===head.type&&head.block.paper._container.intersects(rect)){lastLassoed=head;break}head=head.prev}if(null!=firstLassoed&&null!=lastLassoed){for(tokensToInclude=[],head=firstLassoed;head!==lastLassoed;){switch(head.type){case"blockStart":case"blockEnd":tokensToInclude.push(head.block.start),tokensToInclude.push(head.block.end);break;case"indentStart":case"indentEnd":tokensToInclude.push(head.indent.start),tokensToInclude.push(head.indent.end);break;case"segmentStart":case"segmentEnd":tokensToInclude.push(head.segment.start),tokensToInclude.push(head.segment.end)}head=head.next}for(head=_this.tree.start;head!==_this.tree.end;){if(__indexOf.call(tokensToInclude,head)>=0){firstLassoed=head;break}head=head.next}for(head=_this.tree.end,lastLassoed=null;head!==_this.tree.start;){if(__indexOf.call(tokensToInclude,head)>=0){lastLassoed=head;break}head=head.prev}if("indentStart"===firstLassoed.type){for(depth=0;depth>0||"blockStart"!==head.type;)"blockStart"===firstLassoed.type?depth-=1:"blockEnd"===firstLassoed.type&&(depth+=1),firstLassoed=firstLassoed.prev;lastLassoed=firstLassoed.block.end}if("indentStart"===firstLassoed.type){for(depth=0;depth>0||"blockEnd"!==head.type;)"blockEnd"===lastLassoed.type?depth-=1:"blockStart"===lastLassoed.type&&(depth+=1);firstLassoed=lastLassoed.block.start}_this.lassoSegment=new Segment([]),firstLassoed.insertBefore(_this.lassoSegment.start),lastLassoed.insert(_this.lassoSegment.end),_this.redraw()}return dragCtx.clearRect(0,0,drag.width,drag.height),null!=_this.lassoSegment&&moveCursorTo(_this.lassoSegment.end),_this.lassoAnchor=null,_this.redraw()}}),redrawTextInput=function(){var end,start;return _this.editedText.value=_this.hiddenInput.value,_this.redraw(),start=_this.editedText.paper.bounds[_editedInputLine].x+mainCtx.measureText(_this.hiddenInput.value.slice(0,_this.hiddenInput.selectionStart)).width,end=_this.editedText.paper.bounds[_editedInputLine].x+mainCtx.measureText(_this.hiddenInput.value.slice(0,_this.hiddenInput.selectionEnd)).width,start===end?mainCtx.strokeRect(start,_this.editedText.paper.bounds[_editedInputLine].y,0,INPUT_LINE_HEIGHT):(mainCtx.fillStyle="rgba(0, 0, 256, 0.3",mainCtx.fillRect(start,_this.editedText.paper.bounds[_editedInputLine].y,end-start,INPUT_LINE_HEIGHT))},setTextInputFocus=function(focus){var depth,head;if(_this.focus=focus,null!==_this.focus){if(_editedInputLine=_this.focus.paper._line,_this.handwritten=_this.focus.handwritten,_this.focus.content()){if("text"!==_this.focus.content().type)throw"Cannot edit occupied socket.";_this.editedText=_this.focus.content()}else _this.editedText=new TextToken(""),_this.focus.start.insert(_this.editedText);for(head=_this.focus.end,depth=0;"newline"!==head.type&&"indentEnd"!==head.type&&"segmentEnd"!==head.type;)head=head.next;return"newline"===head.type?moveCursorTo(head):moveCursorBefore(head),_this.hiddenInput.value=_this.editedText.value,setTimeout(function(){return _this.hiddenInput.focus()},0)}},setTextInputHead=function(point){return textInputHead=Math.round((point.x-_this.focus.paper.bounds[_editedInputLine].x)/mainCtx.measureText(" ").width),_this.hiddenInput.setSelectionRange(Math.min(textInputAnchor,textInputHead),Math.max(textInputAnchor,textInputHead))},setTextInputAnchor=function(point){return textInputAnchor=textInputHead=Math.round((point.x-_this.focus.paper.bounds[_editedInputLine].x)/mainCtx.measureText(" ").width),_this.hiddenInput.setSelectionRange(textInputAnchor,textInputHead)},track.addEventListener("mousemove",function(event){var point;return _this.isEditingText()&&textInputSelecting?(point=getPointFromEvent(event),setTextInputHead(point),redrawTextInput()):void 0}),track.addEventListener("mouseup",function(){return _this.isEditingText()?textInputSelecting=!1:void 0}),track.addEventListener("mousewheel",function(event){return _this.clear(),event.wheelDelta>0?_this.scrollOffset.y>=100&&(_this.scrollOffset.add(0,-100),mainCtx.translate(0,100)):(_this.scrollOffset.add(0,100),mainCtx.translate(0,-100)),_this.redraw()})}return Editor.prototype.setValue=function(value){return this.tree=coffee.parse(value).segment,this.redraw()},Editor.prototype.getValue=function(){return this.tree.toString()},Editor}(),window.onload=function(){var paletteElement;return window.editor=new Editor(document.getElementById("editor"),function(){var _i,_len,_ref,_results;for(_ref=["for i in [1..10]\n  alert 'hello'","alert 'hello'","if a is b\n  alert 'hi'\nelse\n  alert 'bye'","a = b"],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)paletteElement=_ref[_i],_results.push(coffee.parse(paletteElement).next.block);return _results}()),editor.setValue("for i in [1..10]\n  if i % 2 is 0\n    alert i\n    alert 'bye'\n  else\n    alert 'fizz'\n  alert 'buzz'")}}).call(this);