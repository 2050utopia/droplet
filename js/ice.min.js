/*! ice-editor 2013-12-29 */
(function(){var Block,BlockEndToken,BlockPaper,BlockStartToken,IndentEndToken,IndentStartToken,LINE_HEIGHT,NewlineToken,PADDING,RecomputeState,Socket,TextToken,TextTokenPaper,Token,drawLine,indentParse,lispParse,_iter,_iterStack,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};RecomputeState=function(){function RecomputeState(){this.stack={next:null,data:null}}return RecomputeState.prototype.first=function(){return this.stack.data},RecomputeState.prototype.push=function(element){return this.stack={next:this.stack,data:element}},RecomputeState.prototype.pop=function(){var removed;return removed=this.stack,this.stack=this.stack.next,removed},RecomputeState}(),Block=function(){function Block(contents){var head,token,_i,_len;for(this.start=new BlockStartToken(this),head=this.start,_i=0,_len=contents.length;_len>_i;_i++)token=contents[_i],head.next=token.clone(),head.next.previous=head,head=head.next;head.next=this.end,this.end=new BlockEndToken(this),this.paper=new BlockPaper(this)}return Block.prototype.contents=function(){var contents,head;for(contents=[],head=this.start;head!==this.end;)contents.push(head),head=head.next;return contents.push(this.end),contents},Block.prototype.lines=function(){var contents,currentLine,head;for(contents=[],currentLine=[],head=this.start;head!==this.end;)contents.push(head),"newline"===head.type&&(contents.push(currentLine),currentLine=[]),head=head.next;return currentLine.push(this.end),contents.push(currentLine),contents},Block.prototype._moveTo=function(parent){return null!=this.start.prev&&(this.start.prev.next=this.end.next),null!=this.end.next&&(this.end.next.prev=this.start.prev),this.end.next=parent.next,parent.next.prev=this.end,parent.next=this.start,this.start.prev=parent},Block.prototype.recompute=function(){},Block.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);head=head.next}return this},Block.prototype.toString=function(){var string;return string=this.start.toString(),string.slice(0,+(string.length-this.end.toString().length-1)+1||9e9)},Block}(),Token=function(){function Token(){this.prev=this.next=null}return Token.prototype.insert=function(token){return null!=this.next&&(this.next.prev=token),token.prev=this,this.next=token},Token.prototype.recompute=function(state){return null!=this.next?this.next.recompute(state):void 0},Token.prototype.toString=function(){return null!=this.next?this.next.toString():""},Token}(),TextToken=function(_super){function TextToken(value){this.value=value,this.prev=this.next=null,this.paper=new TextTokenPaper(this),this.type="text"}return __extends(TextToken,_super),TextToken.prototype.toString=function(){return this.value+(null!=this.next?this.next.toString():"")},TextToken}(Token),BlockStartToken=function(_super){function BlockStartToken(block){this.block=block,this.prev=this.next=null,this.type="blockStart"}return __extends(BlockStartToken,_super),BlockStartToken.prototype.recompute=function(state){return state.push(),null!=this.next?this.next.recompute(state):void 0},BlockStartToken}(Token),BlockEndToken=function(_super){function BlockEndToken(block){this.block=block,this.prev=this.next=null,this.type="blockEnd"}return __extends(BlockEndToken,_super),BlockEndToken.prototype.recompute=function(){return state.pop(),this.block.recompute(state),null!=this.next?this.next.recompute(state):void 0},BlockEndToken}(Token),NewlineToken=function(_super){function NewlineToken(indent){this.indent=indent,null==this.indent&&(this.indent=""),this.prev=this.next=null,this.type="newline"}return __extends(NewlineToken,_super),NewlineToken.prototype.toString=function(){return"\n"+this.indent+(this.next?this.next.toString():"")},NewlineToken}(Token),IndentStartToken=function(_super){function IndentStartToken(){this.prev=this.Next=null,this.type="indentStart"}return __extends(IndentStartToken,_super),IndentStartToken}(Token),IndentEndToken=function(_super){function IndentEndToken(){this.prev=this.Next=null,this.type="indentEnd"}return __extends(IndentEndToken,_super),IndentEndToken}(Token),Socket=function(_super){function Socket(accepts){this.accepts=accepts,this.value=this.prev=this.next=null,this.type="socket"}return __extends(Socket,_super),Socket.prototype.toString=function(){return(null!=this.value?this.value.toString():"")+(null!=this.next?this.next.toString():"")},Socket}(Token),lispParse=function(str){var block,block_stack,char,currentString,first,head,_i,_len;for(currentString="",first=head=new TextToken(""),block_stack=[],_i=0,_len=str.length;_len>_i;_i++)switch(char=str[_i]){case"(":head=head.insert(new TextToken(currentString)),block_stack.push(block=new Block([])),head=head.insert(block.start),head=head.insert(new TextToken("(")),currentString="";break;case")":head=head.insert(new TextToken(currentString)),head=head.insert(new TextToken(")")),head=head.insert(block_stack.pop().end),currentString="";break;case" ":head=head.insert(new TextToken(currentString)),head=head.insert(new TextToken(" ")),currentString="";break;case"\n":head=head.insert(new TextToken(currentString)),head=head.insert(new NewlineToken),currentString="";break;default:currentString+=char}return head=head.insert(new TextToken(currentString)),first},indentParse=function(str){var block,blockStack,cindent,first,head,indent,indentStack,line,lines,_i,_len;for(lines=str.split("\n"),indent=0,indentStack=[0],blockStack=[],first=head=new TextToken(""),_i=0,_len=lines.length;_len>_i;_i++){for(line=lines[_i],cindent=line.length-line.trim().length,indent>=cindent&&blockStack.length>0&&(head=head.insert(blockStack.pop().end)),head=head.insert(new NewlineToken),head.indent=line.slice(0,cindent),cindent>indent&&(indentStack.push(indent),indent=cindent,head=head.insert(new IndentStartToken));indent>cindent;)indent=indentStack.pop(),head=head.insert(new IndentEndToken),head=head.insert(blockStack.pop().end);blockStack.push(block=new Block([])),head=head.insert(block.start),head=head.insert(new TextToken(line.slice(cindent)))}return first},window.ICE={lispParse:lispParse,indentParse:indentParse},PADDING=5,LINE_HEIGHT=15,TextTokenPaper=function(){function TextTokenPaper(block){this.block=block,this._initd=!1;try{this._init()}catch(_error){}}return TextTokenPaper.prototype._init=function(){return this.initd=!0,this.text=new paper.PointText({point:[0,0],content:this.block.value,font:"Courier New",fillColor:"black"})},TextTokenPaper.prototype.draw=function(state){return this.initd||this._init(),this.text.bounds.point.x=state.point.x,this.text.position.y=state.axis,state.point.x+=this.text.bounds.size.width+PADDING,this.text.bringToFront()},TextTokenPaper}(),BlockPaper=function(){function BlockPaper(block){this.block=block,this.padding=1,this._initd=!1,this._linerect={head:new paper.Point(0,0),tail:new paper.Point(0,0)};try{this._init}catch(_error){}}return BlockPaper.prototype.init=function(state){return this._linerect.head=new paper.Point(state.point.x,state.axis-(LINE_HEIGHT/2+this.padding*PADDING)),this.container=new paper.Path,this.container.strokeColor="black",this.container.fillColor="white",state.point.x+=PADDING},BlockPaper.prototype.line=function(){return console.log("lining with",this._linerect),this.container.insert(0,this._linerect.head),this.container.insert(0,new paper.Point(this._linerect.head.x,this._linerect.tail.y)),this.container.add(new paper.Point(this._linerect.tail.x,this._linerect.head.y)),this.container.add(this._linerect.tail),this._linerect={},this.padding=1},BlockPaper.prototype.mouth=function(state){var corner;return corner=new paper.Point(this._linerect.head.x+PADDING,state.lineStart.y+PADDING),state.point.x+=PADDING,state.mouthStack.push({corner:corner}),state.blockStack.push({type:"mouthStopper"})},BlockPaper.prototype.unmouth=function(state){return console.log(state)},BlockPaper.prototype.finish=function(state){return state.point.x+=PADDING,this._linerect.tail=new paper.Point(state.point.x,state.axis+(LINE_HEIGHT/2+this.padding*PADDING)),this.line(state),this.container.closed=!0},BlockPaper}(),_iter=function(start,end,f){var _results;for(_results=[];start!==end;)f(start),_results.push(start=start.next);return _results},_iterStack=function(blockStack,f,g){var block,i,stopped,_i,_len,_ref,_results;for(stopped=!1,null==f&&(f=function(){}),null==g&&(g=f),_ref=blockStack.slice(0).reverse(),_results=[],i=_i=0,_len=_ref.length;_len>_i;i=++_i)block=_ref[i],"mouthStopper"===block.type?_results.push(stopped=!0):stopped?_results.push(g(block,blockStack.length-i-1)):_results.push(f(block,blockStack.length-i-1));return _results},drawLine=function(start,end,state){var block,i,maxPadding,padding,tempStack,_i,_len,_ref;for(state.lineStart=state.point.clone(),_ref=state.blockStack,i=_i=0,_len=_ref.length;_len>_i;i=++_i)block=_ref[i],"mouthStopper"!==block.type&&(block._linerect.head=state.lineStart.add(i*PADDING,i*PADDING));maxPadding=padding=state.padding,tempStack=state.blockStack.slice(0),_iter(start,end,function(block){switch(block.constructor.name){case"BlockStartToken":padding++,tempStack.push(block.block.paper);break;case"BlockEndToken":padding--,tempStack.pop()}return _iterStack(tempStack,function(block,i){return tempStack.length-i>block.padding?block.padding=tempStack.length-i:void 0}),padding>maxPadding?maxPadding=padding:void 0}),state.axis=state.point.y+maxPadding*PADDING+LINE_HEIGHT/2,state.thick=function(){return maxPadding-state.padding},state.mouthCorner=function(){return state.mouthStack[state.mouthStack.length-1].corner},_iter(start,end,function(block){switch(block.type){case"text":return block.paper.draw(state);case"blockStart":return state.blockStack.push(block.block.paper),block.block.paper.init(state),state.padding++;case"blockEnd":return state.padding--,state.blockStack.pop(),block.block.paper.finish(state);case"indentStart":return state.lastMouthStack.push(state.blockStack.length),state.blockStack[state.blockStack.length-1].mouth(state);case"indentEnd":return state.blockStack.pop(),state.mouthStack.pop(),state.lastMouthStack.pop(),state.blockStack[state.blockStack.length-1].unmouth(state)}}),state.point.y+=LINE_HEIGHT+maxPadding*PADDING*2,state.point.x+=(state.blockStack.length-state.lastMouth()-1)*PADDING,state.lineEnd=state.point.clone(),state.point.x=state.mouthCorner().x,_iterStack(state.blockStack,function(block,i){return console.log(state.lineEnd),block._linerect.tail=state.lineEnd.subtract(new paper.Point(i*PADDING,i*PADDING)),block.line(state)},function(block){return block._linerect.tail=new paper.Point(state.mouthCorner().x,state.lineEnd.y),block.line(state)}),paper.view.draw()},window.onload=function(){var a,lastStart,state;return paper.setup(document.getElementById("canvas")),window.blocks=a=ICE.indentParse("if a is b\n  do a, ->\n    b c\n  do b, ->\n    c d\nelse\n  do c, ->\n    d e"),lastStart=a,state={point:new paper.Point(0,10),axis:null,padding:0,blockStack:[],lastMouthStack:[],lastMouth:function(){var _ref;return null!=(_ref=state.lastMouthStack[state.lastMouthStack.length-1])?_ref:0},mouthStack:[{corner:new paper.Point(0,0)}]},_iter(a,null,function(block){return"NewlineToken"===block.constructor.name?(drawLine(lastStart,block,state),lastStart=block.next):void 0}),drawLine(lastStart,null,state),paper.view.draw()}}).call(this);