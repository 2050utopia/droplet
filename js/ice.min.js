/*! ice-editor 2014-01-21 */
(function(){var Block,BlockEndToken,BlockPaper,BlockStartToken,DROP_AREA_MAX_WIDTH,EMPTY_INDENT_WIDTH,EMPTY_SEGMENT_DROP_WIDTH,Editor,FONT_SIZE,INDENT,IcePaper,Indent,IndentEndToken,IndentPaper,IndentStartToken,MIN_INDENT_DROP_WIDTH,MOUTH_BOTTOM,NewlineToken,PADDING,PALETTE_WHITESPACE,PALETTE_WIDTH,Segment,SegmentEndToken,SegmentPaper,SegmentStartToken,Socket,SocketEndToken,SocketPaper,SocketStartToken,TextToken,TextTokenPaper,Token,exports,out,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};exports={},exports.Block=Block=function(){function Block(contents){var head,token,_i,_len;for(this.start=new BlockStartToken(this),this.end=new BlockEndToken(this),this.type="block",this.color="#ddf",head=this.start,_i=0,_len=contents.length;_len>_i;_i++)token=contents[_i],head=head.append(token.clone());head.append(this.end),this.paper=new BlockPaper(this)}return Block.prototype.embedded=function(){return"socketStart"===this.start.prev.type},Block.prototype.contents=function(){var contents,head;for(contents=[],head=this.start;head!==this.end;)contents.push(head),head=head.next;return contents.push(this.end),contents},Block.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Block([]),clone.color=this.color,head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:cursor=cursor.append(head.clone())}head=head.next}return cursor.append(clone.end),clone},Block.prototype.lines=function(){var contents,currentLine,head;for(contents=[],currentLine=[],head=this.start;head!==this.end;)contents.push(head),"newline"===head.type&&(contents.push(currentLine),currentLine=[]),head=head.next;return currentLine.push(this.end),contents.push(currentLine),contents},Block.prototype._moveTo=function(parent){for(var first,last;null!=this.start.prev&&"segmentStart"===this.start.prev.type&&this.start.prev.segment.end===this.end.next;)console.log("removing a segment"),this.start.prev.segment.remove();if(null!=this.end.next&&null!=this.start.prev){for(last=this.end.next;null!=last&&"segmentEnd"===last.type;)last=last.next;for(first=this.start.prev;null!=first&&"segmentStart"===first.type;)first=first.prev;null==first||"newline"!==first.type||null!=last&&"newline"!==last.type?null==last||"newline"!==last.type||null!=first&&"newline"!==first.type||last.remove():first.remove()}return null!=this.start.prev&&(this.start.prev.next=this.end.next),null!=this.end.next&&(this.end.next.prev=this.start.prev),this.start.prev=this.end.next=null,null!=parent?(this.end.next=parent.next,parent.next.prev=this.end,parent.next=this.start,this.start.prev=parent):void 0},Block.prototype.findBlock=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.findBlock(f);head=head.next}return this},Block.prototype.findSocket=function(f){var head;for(head=this.start.next;head!==this.end;){if("socketStart"===head.type&&f(head.socket))return head.socket.findSocket(f);head=head.next}return null},Block.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return this},Block.prototype.toString=function(){var string;return string=this.start.toString({indent:""}),string.slice(0,+(string.length-this.end.toString({indent:""}).length-1)+1||9e9)},Block}(),exports.Indent=Indent=function(){function Indent(contents,depth){var block,head,_i,_len;for(this.depth=depth,this.start=new IndentStartToken(this),this.end=new IndentEndToken(this),this.type="indent",head=this.start,_i=0,_len=contents.length;_len>_i;_i++)block=contents[_i],head=head.append(block.clone());head.append(this.end),this.paper=new IndentPaper(this)}return Indent.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Indent([],this.depth),head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:cursor=cursor.append(head.clone())}head=head.next}return cursor.append(clone.end),clone},Indent.prototype.embedded=function(){return!1},Indent.prototype.toString=function(state){var string;return string=this.start.toString(state),string.slice(0,string.length-this.end.toString(state).length-1)},Indent.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return this},Indent}(),exports.Segment=Segment=function(){function Segment(contents){var block,head,_i,_len;for(this.start=new SegmentStartToken(this),this.end=new SegmentEndToken(this),this.type="indent",head=this.start,_i=0,_len=contents.length;_len>_i;_i++)block=contents[_i],head=head.append(block.clone());head.append(this.end),this.paper=new SegmentPaper(this)}return Segment.prototype.clone=function(){var block_clone,clone,cursor,head;for(clone=new Segment([]),head=this.start.next,cursor=clone.start;head!==this.end;){switch(head.type){case"blockStart":block_clone=head.block.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.block.end;break;case"socketStart":block_clone=head.socket.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.socket.end;break;case"indentStart":block_clone=head.indent.clone(),block_clone.start.prev=cursor,cursor.next=block_clone.start,cursor=block_clone.end,head=head.indent.end;break;default:cursor=cursor.append(head.clone())}head=head.next}return cursor.append(clone.end),clone},Segment.prototype.embedded=function(){return!1},Segment.prototype.remove=function(){return this.start.remove(),this.end.remove(),this.start.next=this.end,this.end.prev=this.start},Segment.prototype._moveTo=function(parent){for(var first,last;null!=this.start.prev&&"segmentStart"===this.start.prev.type&&this.start.prev.segment.end===this.end.next;)this.start.prev.segment.remove();if(null!=this.end.next&&null!=this.start.prev){for(last=this.end.next;null!=last&&"segmentEnd"===last.type;)last=last.next;for(first=this.start.prev;null!=first&&"segmentStart"===first.type;)first=first.prev;null==first||"newline"!==first.type||null!=last&&"newline"!==last.type?null==last||"newline"!==last.type||null!=first&&"newline"!==first.type||last.remove():first.remove()}return null!=this.start.prev&&(this.start.prev.next=this.end.next),null!=this.end.next&&(this.end.next.prev=this.start.prev),this.start.prev=this.end.next=null,null!=parent?(this.end.next=parent.next,parent.next.prev=this.end,parent.next=this.start,this.start.prev=parent):void 0},Segment.prototype.findBlock=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.findBlock(f);head=head.next}return null},Segment.prototype.findSocket=function(f){var head;for(head=this.start.next;head!==this.end;){if("socketStart"===head.type&&f(head.socket))return head.socket.findSocket(f);head=head.next}return null},Segment.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return f(this)?this:null},Segment.prototype.toString=function(){var start;return start=this.start.toString({indent:""}),start.slice(0,start.length-this.end.toString({indent:""}).length)},Segment}(),exports.Socket=Socket=function(){function Socket(content){this.start=new SocketStartToken(this),this.end=new SocketEndToken(this),null!=content&&null!=content.start?(this.start.next=content.start,content.start.prev=this.start,this.end.prev=content.end,content.end.next=this.end):null!=content?(this.start.next=content,content.prev=this.start,this.end.prev=content,content.next=this.end):(this.start.next=this.end,this.end.prev=this.start),this.type="socket",this.paper=new SocketPaper(this)}return Socket.prototype.clone=function(){return null!=this.content()?new Socket(this.content().clone()):new Socket},Socket.prototype.embedded=function(){return!1},Socket.prototype.content=function(){var unwrap;return unwrap=function(el){switch(el.type){case"blockStart":return el.block;case"segmentStart":return unwrap(el.next);default:return el}},this.start.next!==this.end?unwrap(this.start.next):null},Socket.prototype.findSocket=function(f){var head;for(head=this.start.next;head!==this.end;){if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return this},Socket.prototype.find=function(f){var head;for(head=this.start.next;head!==this.end;){if("blockStart"===head.type&&f(head.block))return head.block.find(f);if("indentStart"===head.type&&f(head.indent))return head.indent.find(f);if("socketStart"===head.type&&f(head.socket))return head.socket.find(f);head=head.next}return this},Socket.prototype.toString=function(){return null!=this.content()?this.content().toString({indent:""}):""},Socket}(),exports.Token=Token=function(){function Token(){this.prev=this.next=null}return Token.prototype.append=function(token){return token.prev=this,this.next=token},Token.prototype.insert=function(token){return null!=this.next&&(token.next=this.next,this.next.prev=token),token.prev=this,this.next=token,this.next},Token.prototype.remove=function(){return null!=this.prev&&(this.prev.next=this.next),null!=this.next&&(this.next.prev=this.prev),this.prev=this.next=null},Token.prototype.toString=function(state){return null!=this.next?this.next.toString(state):""},Token}(),exports.TextToken=TextToken=function(_super){function TextToken(value){this.value=value,this.prev=this.next=null,this.paper=new TextTokenPaper(this),this.type="text"}return __extends(TextToken,_super),TextToken.prototype.clone=function(){return new TextToken(this.value)},TextToken.prototype.toString=function(state){return this.value+(null!=this.next?this.next.toString(state):"")},TextToken}(Token),exports.BlockStartToken=BlockStartToken=function(_super){function BlockStartToken(block){this.block=block,this.prev=this.next=null,this.type="blockStart"}return __extends(BlockStartToken,_super),BlockStartToken}(Token),exports.BlockEndToken=BlockEndToken=function(_super){function BlockEndToken(block){this.block=block,this.prev=this.next=null,this.type="blockEnd"}return __extends(BlockEndToken,_super),BlockEndToken}(Token),exports.NewlineToken=NewlineToken=function(_super){function NewlineToken(){this.prev=this.next=null,this.type="newline"}return __extends(NewlineToken,_super),NewlineToken.prototype.clone=function(){return new NewlineToken},NewlineToken.prototype.toString=function(state){return"\n"+state.indent+(this.next?this.next.toString(state):"")},NewlineToken}(Token),exports.IndentStartToken=IndentStartToken=function(_super){function IndentStartToken(indent){this.indent=indent,this.prev=this.next=null,this.type="indentStart"}return __extends(IndentStartToken,_super),IndentStartToken.prototype.toString=function(state){return state.indent+=function(){var _i,_ref,_results;for(_results=[],_i=1,_ref=this.indent.depth;_ref>=1?_ref>=_i:_i>=_ref;_ref>=1?_i++:_i--)_results.push(" ");return _results}.call(this).join(""),this.next?this.next.toString(state):""},IndentStartToken}(Token),exports.IndentEndToken=IndentEndToken=function(_super){function IndentEndToken(indent){this.indent=indent,this.prev=this.next=null,this.type="indentEnd"}return __extends(IndentEndToken,_super),IndentEndToken.prototype.toString=function(state){return state.indent=state.indent.slice(0,-this.indent.depth),this.next?this.next.toString(state):""},IndentEndToken}(Token),exports.SocketStartToken=SocketStartToken=function(_super){function SocketStartToken(socket){this.socket=socket,this.prev=this.next=null,this.type="socketStart"}return __extends(SocketStartToken,_super),SocketStartToken}(Token),exports.SocketEndToken=SocketEndToken=function(_super){function SocketEndToken(socket){this.socket=socket,this.prev=this.next=null,this.type="socketEnd"}return __extends(SocketEndToken,_super),SocketEndToken}(Token),exports.SegmentStartToken=SegmentStartToken=function(_super){function SegmentStartToken(segment){this.segment=segment,this.prev=this.next=null,this.type="segmentStart"}return __extends(SegmentStartToken,_super),SegmentStartToken}(Token),exports.SegmentEndToken=SegmentEndToken=function(_super){function SegmentEndToken(segment){this.segment=segment,this.prev=this.next=null,this.type="segmentEnd"}return __extends(SegmentEndToken,_super),SegmentEndToken}(Token),exports.lispParse=function(str){var block,block_stack,char,currentString,first,head,socket,socket_stack,_i,_len;for(currentString="",first=head=new TextToken(""),block_stack=[],socket_stack=[],_i=0,_len=str.length;_len>_i;_i++)switch(char=str[_i]){case"(":head=head.append(new TextToken(currentString)),block_stack.push(block=new Block([])),socket_stack.push(socket=new Socket(block)),head=head.append(socket.start),head=head.append(block.start),head=head.append(new TextToken("(")),currentString="";break;case")":head=head.append(new TextToken(currentString)),head=head.append(new TextToken(")")),head=head.append(block_stack.pop().end),head=head.append(socket_stack.pop().end),currentString="";break;case" ":head=head.append(new TextToken(currentString)),head=head.append(new TextToken(" ")),currentString="";break;case"\n":head=head.append(new TextToken(currentString)),head=head.append(new NewlineToken),currentString="";break;default:currentString+=char}return head=head.append(new TextToken(currentString)),first},exports.indentParse=function(str){var block,char,currentString,depth_stack,first,head,indent,line,popped,socket,stack,_i,_j,_len,_len1,_ref,_ref1;for(head=first=new TextToken(""),stack=[],depth_stack=[0],_ref=str.split("\n"),_i=0,_len=_ref.length;_len>_i;_i++){for(line=_ref[_i],indent=line.length-line.trimLeft().length,indent>_.last(depth_stack)&&(head=head.append(new Indent([],indent-_.last(depth_stack)).start),stack.push(head.indent),depth_stack.push(indent));indent<_.last(depth_stack);)head=head.append(stack.pop().end),depth_stack.pop();for(head=head.append(new NewlineToken),currentString="",_ref1=line.trimLeft(),_j=0,_len1=_ref1.length;_len1>_j;_j++)switch(char=_ref1[_j]){case"(":currentString.length>0&&(head=head.append(new TextToken(currentString))),stack.length>0&&"block"===_.last(stack).type&&(stack.push(socket=new Socket(block)),head=head.append(socket.start)),stack.push(block=new Block([])),head=head.append(block.start),head=head.append(new TextToken("(")),currentString="";break;case")":for(currentString.length>0&&(head=head.append(new TextToken(currentString))),popped={};"block"!==popped.type;)popped=stack.pop(),"block"===popped.type&&(head=head.append(new TextToken(")"))),head=head.append(popped.end),"indentEnd"===head.type&&depth_stack.pop();stack.length>0&&"socket"===_.last(stack).type&&(head=head.append(stack.pop().end)),currentString="";break;case" ":currentString.length>0&&(head=head.append(new TextToken(currentString))),head=head.append(new TextToken(" ")),currentString="";break;default:currentString+=char}currentString.length>0&&(head=head.append(new TextToken(currentString)))}for(;stack.length>0;)head=head.append(stack.pop().end);return first.next.next},window.ICE=exports,PADDING=3,INDENT=10,MOUTH_BOTTOM=50,DROP_AREA_MAX_WIDTH=50,FONT_SIZE=15,EMPTY_INDENT_WIDTH=50,PALETTE_WIDTH=300,PALETTE_WHITESPACE=10,MIN_INDENT_DROP_WIDTH=20,EMPTY_SEGMENT_DROP_WIDTH=100,window.RUN_PAPER_TESTS=!1,window.PERFORMANCE_TEST=!1,IcePaper=function(){function IcePaper(block){this.block=block,this.point=new draw.Point(0,0),this.group=new draw.Group,this.bounds={},this.lineGroups={},this.children=[],this.lineStart=this.lineEnd=0}return IcePaper.prototype.compute=function(){return this},IcePaper.prototype.finish=function(){var child,_i,_len,_ref,_results;for(_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.finish());return _results},IcePaper.prototype.draw=function(){},IcePaper.prototype.setLeftCenter=function(){},IcePaper.prototype.translate=function(vector){return this.point.translate(vector),this.group.translate(vector)},IcePaper.prototype.position=function(point){return this.translate(this.point.from(point))},IcePaper}(),BlockPaper=function(_super){function BlockPaper(block){BlockPaper.__super__.constructor.call(this,block),this._lineChildren={},this.indented={},this.indentEnd={}}return __extends(BlockPaper,_super),BlockPaper.prototype.compute=function(state){var axis,head,height,i,indent,line,top,_i,_ref,_ref1;for(this.indented={},this.indentEnd={},this._pathBits={},this.bounds={},this.lineGroups={},this.children=[],this.lineStart=state.line,head=this.block.start.next;head!==this.block.end;){switch(head.type){case"text":this.children.push(head.paper.compute(state)),this.group.push(head.paper.group);break;case"blockStart":this.children.push(head.block.paper.compute(state)),this.group.push(head.block.paper.group),head=head.block.end;break;case"indentStart":indent=head.indent.paper.compute(state),this.children.push(indent),this.group.push(indent.group),head=head.indent.end;break;case"socketStart":this.children.push(head.socket.paper.compute(state)),this.group.push(head.socket.paper.group),head=head.socket.end;break;case"newline":state.line+=1}head=head.next}for(this.lineEnd=state.line,i=0,top=0,axis=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(this._lineChildren[line]=[],this._pathBits[line]={left:[],right:[]},this.lineGroups[line]=new draw.Group,this.bounds[line]=new draw.NoRectangle;i<this.children.length&&line>this.children[i].lineEnd;)i+=1;for(;i<this.children.length&&line>=this.children[i].lineStart&&line<=this.children[i].lineEnd;)this._lineChildren[line].push(this.children[i]),i+=1;i-=1,height=this._computeHeight(line),axis=top+height/2,this.setLeftCenter(line,new draw.Point(0,axis)),top+=this.bounds[line].height}return this},BlockPaper.prototype._computeHeight=function(line){var child,height,_heightModifier,_i,_len,_ref;for(height=0,_heightModifier=0,_ref=this._lineChildren[line],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],height="indent"===child.block.type&&line===child.lineEnd?Math.max(height,child.bounds[line].height+10):Math.max(height,child.bounds[line].height);return(this.indented[line]||this._lineChildren[line].length>0&&"indent"===this._lineChildren[line][0].block.type)&&(height-=2*PADDING),height+2*PADDING},BlockPaper.prototype.setLeftCenter=function(line,point){var child,cursor,i,indentChild,topPoint,_bottomModifier,_i,_len,_ref;for(cursor=point.clone(),cursor.add(PADDING,0),this.lineGroups[line].empty(),this._pathBits[line].left.length=0,this._pathBits[line].right.length=0,this.bounds[line].clear(),this.bounds[line].swallow(point),_bottomModifier=0,topPoint=null,this.indented[line]=this.indentEnd[line]=!1,indentChild=null,_ref=this._lineChildren[line],i=_i=0,_len=_ref.length;_len>_i;i=++_i)child=_ref[i],0===i&&"indent"===child.block.type?(this.indented[line]=!0,this.indentEnd[line]=line===child.lineEnd||child.indentEnd[line],cursor.add(INDENT,0),indentChild=child,child.setLeftCenter(line,new draw.Point(cursor.x,cursor.y-this._computeHeight(line)/2+child.bounds[line].height/2)),0===child.bounds[line].height?(this._pathBits[line].right.push(topPoint=new draw.Point(child.bounds[line].x,child.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(child.bounds[line].x,child.bounds[line].y+10)),this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].y+10)),this._lineChildren[line].length>1&&this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].y-5-PADDING))):(this._pathBits[line].right.push(topPoint=new draw.Point(child.bounds[line].x,child.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(child.bounds[line].x,child.bounds[line].bottom())),line===child.lineEnd&&this._lineChildren[line].length>1&&(this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].bottom())),this._pathBits[line].right.push(new draw.Point(child.bounds[line].right(),child.bounds[line].y)))),child.lineEnd===line&&(_bottomModifier+=INDENT)):(this.indented[line]=this.indented[line]||(null!=child.indented?child.indented[line]:!1),this.indentEnd[line]=this.indentEnd[line]||(null!=child.indentEnd?child.indentEnd[line]:!1),null!=child.indentEnd&&child.indentEnd[line]?child.setLeftCenter(line,new draw.Point(cursor.x,cursor.y-this._computeHeight(line)/2+child.bounds[line].height/2)):child.setLeftCenter(line,cursor)),this.lineGroups[line].push(child.lineGroups[line]),this.bounds[line].unite(child.bounds[line]),cursor.add(child.bounds[line].width,0);return this.indented[line]||(this.bounds[line].width+=PADDING,this.bounds[line].y-=PADDING,this.bounds[line].height+=2*PADDING),null!=topPoint&&(topPoint.y=this.bounds[line].y),this._pathBits[line].left.push(new draw.Point(this.bounds[line].x,this.bounds[line].y)),this._pathBits[line].left.push(new draw.Point(this.bounds[line].x,this.bounds[line].bottom()+_bottomModifier)),!this.indented[line]||"indent"===this._lineChildren[line][0].block.type&&this._lineChildren[line][0].lineEnd===line?"indent"===this._lineChildren[line][0].block.type&&this._lineChildren[line][0].lineEnd===line?(this._lineChildren[line].length>1?(this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom()+_bottomModifier))):(this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom())),this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom()+_bottomModifier))),this.bounds[line].height+=10):(this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(this.bounds[line].right(),this.bounds[line].bottom()+_bottomModifier))):(this._pathBits[line].right.push(new draw.Point(this.bounds[line].x+INDENT+PADDING,this.bounds[line].y)),this._pathBits[line].right.push(new draw.Point(this.bounds[line].x+INDENT+PADDING,this.bounds[line].bottom())))},BlockPaper.prototype.finish=function(){var bit,child,line,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2,_results;this._container=new draw.Path;for(line in this._pathBits){for(_ref=this._pathBits[line].left,_i=0,_len=_ref.length;_len>_i;_i++)bit=_ref[_i],this._container.unshift(bit);for(_ref1=this._pathBits[line].right,_j=0,_len1=_ref1.length;_len1>_j;_j++)bit=_ref1[_j],this._container.push(bit)}for(this._container.style.strokeColor="#000",this._container.style.fillColor=this.block.color,this.dropArea=new draw.Rectangle(this.bounds[this.lineEnd].x,this.bounds[this.lineEnd].bottom()-5,this.bounds[this.lineEnd].width,10),_ref2=this.children,_results=[],_k=0,_len2=_ref2.length;_len2>_k;_k++)child=_ref2[_k],_results.push(child.finish());return _results},BlockPaper.prototype.draw=function(ctx){var child,_i,_len,_ref,_results;for(this._container.draw(ctx),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.draw(ctx));return _results},BlockPaper.prototype.translate=function(vector){var bit,child,line,point,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2,_ref3,_results;this.point.translate(vector);for(line in this.bounds)this.lineGroups[line].translate(vector),this.bounds[line].translate(vector);_ref=this._pathBits;for(line in _ref){for(bit=_ref[line],_ref1=bit.left,_i=0,_len=_ref1.length;_len>_i;_i++)point=_ref1[_i],point.translate(vector);for(_ref2=bit.right,_j=0,_len1=_ref2.length;_len1>_j;_j++)point=_ref2[_j],point.translate(vector)}for(_ref3=this.children,_results=[],_k=0,_len2=_ref3.length;_len2>_k;_k++)child=_ref3[_k],_results.push(child.translate(vector));return _results},BlockPaper}(IcePaper),SocketPaper=function(_super){function SocketPaper(block){SocketPaper.__super__.constructor.call(this,block),this._empty=!1,this._content=null,this._line=0,this.indented={},this.children=[]}return __extends(SocketPaper,_super),SocketPaper.prototype.compute=function(state){var contentPaper,line;if(this.bounds={},this.lineGroups={},this.group=new draw.Group,this.dropArea=null,null!=(this._content=this.block.content())){(contentPaper=this._content.paper).compute(state);for(line in contentPaper.bounds)"text"===this._content.type?(this._line=state.line,this.bounds[line]=new draw.NoRectangle,this.bounds[line].copy(contentPaper.bounds[line]),this.bounds[line].y-=PADDING,this.bounds[line].width+=2*PADDING,this.bounds[line].x-=PADDING,this.bounds[line].height+=2*PADDING,this.bounds[line].width=Math.max(this.bounds[line].width,20),this.dropArea=this.bounds[line]):this.bounds[line]=contentPaper.bounds[line],this.lineGroups[line]=contentPaper.lineGroups[line];this.indented=this._content.paper.indented,this.indentEnd=this._content.paper.indentEnd,this.group=contentPaper.group,this.children=[this._content.paper],this.lineStart=contentPaper.lineStart,this.lineEnd=contentPaper.lineEnd}else this.dropArea=this.bounds[state.line]=new draw.Rectangle(0,0,20,20),this.lineStart=this.lineEnd=this._line=state.line,this.children=[],this.indented={},this.indented[this._line]=!1,this.lineGroups[this._line]=new draw.Group;return this._empty=null==this._content||"text"===this._content.type,this},SocketPaper.prototype.setLeftCenter=function(line,point){return null!=this._content?("text"===this._content.type?(line=this._content.paper._line,this._content.paper.setLeftCenter(line,new draw.Point(point.x+PADDING,point.y)),this.bounds[line].copy(this._content.paper.bounds[line]),this.bounds[line].y-=PADDING,this.bounds[line].width+=2*PADDING,this.bounds[line].x-=PADDING,this.bounds[line].height+=2*PADDING,this.bounds[line].width=Math.max(this.bounds[line].width,20)):this._content.paper.setLeftCenter(line,point),this.lineGroups[line].recompute()):(this.bounds[line].x=point.x,this.bounds[line].y=point.y-this.bounds[line].height/2,this.lineGroups[line].setPosition(new draw.Point(point.x,point.y-this.bounds[line].height/2)))},SocketPaper.prototype.draw=function(ctx){var line,rect;return null!=this._content?("text"===this._content.type&&(line=this._content.paper._line,ctx.strokeStyle="#000",ctx.fillStyle="#fff",ctx.fillRect(this.bounds[line].x,this.bounds[line].y,this.bounds[line].width,this.bounds[line].height),ctx.strokeRect(this.bounds[line].x,this.bounds[line].y,this.bounds[line].width,this.bounds[line].height)),this._content.paper.draw(ctx)):(rect=this.bounds[this._line],ctx.strokeStyle="#000",ctx.fillStyle="#fff",ctx.fillRect(rect.x,rect.y,rect.width,rect.height),ctx.strokeRect(rect.x,rect.y,rect.width,rect.height))},SocketPaper.prototype.translate=function(vector){var line;return null==this._content?this.bounds[this._line].translate(vector):(this._content.paper.translate(vector),"text"===this._content.type?(line=this._content.paper._line,this.bounds[line].copy(this._content.paper.bounds[line]),this.bounds[line].y-=PADDING,this.bounds[line].width+=2*PADDING,this.bounds[line].x-=PADDING,this.bounds[line].height+=2*PADDING,this.bounds[line].width=Math.max(this.bounds[line].width,20)):void 0)},SocketPaper}(IcePaper),IndentPaper=function(_super){function IndentPaper(block){IndentPaper.__super__.constructor.call(this,block),this._lineBlocks={}}return __extends(IndentPaper,_super),IndentPaper.prototype.compute=function(state){var head,i,line,_i,_ref,_ref1;for(this.bounds={},this.lineGroups={},this._lineBlocks={},this.indentEnd={},this.group=new draw.Group,this.children=[],this.lineStart=state.line+=1,head=this.block.start.next.next,this.block.start.next===this.block.end&&(head=this.block.end);head!==this.block.end;){switch(head.type){case"blockStart":this.children.push(head.block.paper.compute(state)),this.group.push(head.block.paper.group),head=head.block.end;break;case"newline":state.line+=1}head=head.next}if(this.lineEnd=state.line,this.children.length>0)for(i=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(;!(line<=this.children[i].lineEnd);)i+=1;this.bounds[line]=this.children[i].bounds[line],this.lineGroups[line]=new draw.Group,this.indentEnd[line]=this.children[i].indentEnd[line],this.lineGroups[line].push(this.children[i].lineGroups[line]),this._lineBlocks[line]=this.children[i]}else this.lineGroups[this.lineStart]=new draw.Group,this._lineBlocks[this.lineStart]=null,this.bounds[this.lineStart]=new draw.Rectangle(0,0,EMPTY_INDENT_WIDTH,0);return this},IndentPaper.prototype.finish=function(){var child,_i,_len,_ref,_results;for(this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,Math.max(this.bounds[this.lineStart].width,MIN_INDENT_DROP_WIDTH),10),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.finish());return _results},IndentPaper.prototype.setLeftCenter=function(line,point){return null!=this._lineBlocks[line]?(this._lineBlocks[line].setLeftCenter(line,point),this.lineGroups[line].recompute()):(this.bounds[this.lineStart].clear(),this.bounds[this.lineStart].swallow(point),this.bounds[this.lineStart].width=EMPTY_INDENT_WIDTH)},IndentPaper.prototype.draw=function(ctx){var child,_i,_len,_ref,_results;for(_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.draw(ctx));return _results},IndentPaper.prototype.translate=function(vector){var child,_i,_len,_ref,_results;for(this.point.add(vector),0===this.bounds[this.lineStart].height&&this.bounds[this.lineStart].translate(vector),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.translate(vector));return _results},IndentPaper.prototype.setPosition=function(point){return this.translate(point.from(this.point))},IndentPaper}(IcePaper),SegmentPaper=function(_super){function SegmentPaper(block){SegmentPaper.__super__.constructor.call(this,block),this._lineBlocks={}}return __extends(SegmentPaper,_super),SegmentPaper.prototype.compute=function(state){var head,i,line,running_height,_i,_ref,_ref1;for(this.bounds={},this.lineGroups={},this._lineBlocks={},this.indentEnd={},this.group=new draw.Group,this.children=[],this.lineStart=state.line+=1,head=this.block.start.next,this.block.start.next===this.block.end&&(head=this.block.end),running_height=0;head!==this.block.end;){switch(head.type){case"blockStart":this.children.push(head.block.paper.compute(state)),head.block.paper.translate(new draw.Point(0,running_height)),running_height=head.block.paper.bounds[head.block.paper.lineEnd].bottom(),this.group.push(head.block.paper.group),head=head.block.end;
break;case"newline":state.line+=1}head=head.next}if(this.lineEnd=state.line,0===this.children.length)return this.bounds[state.line]=new draw.Rectangle(0,0,0,0),this;for(i=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(;!(line<=this.children[i].lineEnd);)i+=1;this.bounds[line]=this.children[i].bounds[line],this.lineGroups[line]=new draw.Group,this.indentEnd[line]=this.children[i].indentEnd[line],this.lineGroups[line].push(this.children[i].lineGroups[line]),this._lineBlocks[line]=this.children[i]}return this},SegmentPaper.prototype.prepBounds=function(){var head,i,line,running_height,_i,_ref,_ref1;for(this.bounds={},this.lineGroups={},this._lineBlocks={},this.indentEnd={},this.group=new draw.Group,this.children=[],this.lineStart=1/0,this.lineEnd=0,head=this.block.start.next,this.block.start.next===this.block.end&&(head=this.block.end),running_height=0;head!==this.block.end;){switch(head.type){case"blockStart":this.children.push(head.block.paper),this.lineStart=Math.min(this.lineStart,head.block.paper.lineStart),this.lineEnd=Math.max(this.lineEnd,head.block.paper.lineEnd),head=head.block.end}head=head.next}for(i=0,line=_i=_ref=this.lineStart,_ref1=this.lineEnd;_ref1>=_ref?_ref1>=_i:_i>=_ref1;line=_ref1>=_ref?++_i:--_i){for(;!(line<=this.children[i].lineEnd);)i+=1;this.bounds[line]=this.children[i].bounds[line]}return this},SegmentPaper.prototype.getBounds=function(){var bounds,head;for(head=this.block.start.next,this.block.start.next===this.block.end&&(head=this.block.end),bounds=new draw.NoRectangle;head!==this.block.end;){switch(head.type){case"blockStart":bounds.unite(head.block.paper._container.bounds())}head=head.next}return bounds},SegmentPaper.prototype.finish=function(){var child,_i,_len,_ref,_results;for(this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,Math.max(this.bounds[this.lineStart].width,MIN_INDENT_DROP_WIDTH),10),0===this.bounds[this.lineStart].width&&(this.dropArea.width=EMPTY_SEGMENT_DROP_WIDTH),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.finish());return _results},SegmentPaper.prototype.setLeftCenter=function(line,point){return null!=this._lineBlocks[line]?(this._lineBlocks[line].setLeftCenter(line,point),this.lineGroups[line].recompute()):(this.bounds[this.lineStart].clear(),this.bounds[this.lineStart].swallow(point),this.bounds[this.lineStart].width=EMPTY_INDENT_WIDTH)},SegmentPaper.prototype.draw=function(ctx){var child,_i,_len,_ref,_results;for(_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.draw(ctx));return _results},SegmentPaper.prototype.translate=function(vector){var child,_i,_len,_ref,_results;for(this.point.add(vector),_ref=this.children,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],_results.push(child.translate(vector));return _results},SegmentPaper.prototype.setPosition=function(point){return this.translate(point.from(this.point))},SegmentPaper}(IcePaper),TextTokenPaper=function(_super){function TextTokenPaper(block){TextTokenPaper.__super__.constructor.call(this,block),this._line=0}return __extends(TextTokenPaper,_super),TextTokenPaper.prototype.compute=function(state){return this.lineStart=this.lineEnd=this._line=state.line,this.lineGroups={},this.bounds={},this.group=this.lineGroups[this._line]=new draw.Group,this.lineGroups[this._line].push(this._text=new draw.Text(new draw.Point(0,0),this.block.value)),this.bounds[this._line]=this._text.bounds(),this},TextTokenPaper.prototype.draw=function(ctx){return this._text.draw(ctx)},TextTokenPaper.prototype.setLeftCenter=function(line,point){return line===this._line?(this._text.setPosition(new draw.Point(point.x,point.y-this.bounds[this._line].height/2)),this.lineGroups[this._line].recompute()):void 0},TextTokenPaper.prototype.translate=function(vector){return this._text.translate(vector)},TextTokenPaper}(IcePaper),out=null,exports.Editor=Editor=function(){function Editor(el){var anchor,block,canvas,clear,ctx,div,dragCanvas,dragCtx,fastDraw,floating_blocks,focus,head,highlight,input,lassoAnchor,lassoBounds,lassoHead,lassoSegment,offset,paletteCanvas,paletteCtx,palette_blocks,redraw,running_height,scrollOffset,selection,tree,_i,_len;for(canvas=document.createElement("canvas"),canvas.className="canvas",canvas.height=el.offsetHeight,canvas.width=el.offsetWidth-PALETTE_WIDTH,paletteCanvas=document.createElement("canvas"),paletteCanvas.className="palette",paletteCanvas.height=el.offsetHeight,paletteCanvas.width=PALETTE_WIDTH,dragCanvas=document.createElement("canvas"),dragCanvas.className="drag",dragCanvas.height=el.offsetHeight,dragCanvas.width=el.offsetWidth-PALETTE_WIDTH,div=document.createElement("div"),div.className="trackArea",el.appendChild(canvas),el.appendChild(dragCanvas),el.appendChild(paletteCanvas),el.appendChild(div),ctx=canvas.getContext("2d"),dragCtx=dragCanvas.getContext("2d"),paletteCtx=paletteCanvas.getContext("2d"),draw._setCTX(ctx),tree=coffee.parse("window.onload = ->\n  if document.getElementsByClassName('test').length > 0\n    for [1..10]\n      document.body.appendChild document.createElement 'script'\n    alert 'found a test element'\n  document.getElementsByTagName('button').onclick = ->\n    alert 'somebody clicked a button'"),scrollOffset=new draw.Point(0,0),highlight=null,selection=null,offset=null,input=null,focus=null,anchor=head=null,lassoAnchor=null,lassoHead=null,lassoSegment=null,lassoBounds=null,floating_blocks=[],clear=function(){return ctx.clearRect(scrollOffset.x,scrollOffset.y,canvas.width,canvas.height)},redraw=function(){var block,_i,_len;for(clear(),tree.segment.paper.compute({line:0}),tree.segment.paper.finish(),tree.segment.paper.draw(ctx),out.value=tree.segment.toString({indent:""}),null!=lassoSegment&&lassoSegment.paper.prepBounds(),_i=0,_len=floating_blocks.length;_len>_i;_i++)block=floating_blocks[_i],block.block.paper.compute({line:0}),block.block.paper.translate(block.position),block.block.paper.finish(),block.block.paper.draw(ctx);return null!=lassoSegment&&lassoSegment!==selection?((lassoBounds=lassoSegment.paper.getBounds()).stroke(ctx,"#000"),lassoBounds.fill(ctx,"rgba(0, 0, 256, 0.3)")):void 0},fastDraw=function(){var block,_i,_len;for(clear(),tree.segment.paper.draw(ctx),_i=0,_len=floating_blocks.length;_len>_i;_i++)block=floating_blocks[_i],block.block.paper.draw(ctx);return null!=lassoSegment&&lassoSegment!==selection?(lassoBounds.stroke(ctx,"#000"),lassoBounds.fill(ctx,"rgba(0, 0, 256, 0.3)")):void 0},redraw(),div.addEventListener("touchstart",div.onmousedown=function(event){var block,bounds,cloneLater,i,line,point,shiftedPoint,start,text,_i,_j,_len,_len1;if(point=null!=event.offsetX?new draw.Point(event.offsetX,event.offsetY):new draw.Point(event.layerX,event.layerY),point.add(-PALETTE_WIDTH,0),point.translate(scrollOffset),focus=tree.segment.findSocket(function(block){return block.paper._empty&&block.paper.bounds[block.paper._line].contains(point)}),null!=focus)null!=focus.content()?text=focus.content():focus.start.insert(text=new TextToken("")),null!=input&&input.parentNode.removeChild(input),document.body.appendChild(input=document.createElement("input")),input.className="hidden_input",line=focus.paper._line,input.value=focus.content().value,anchor=head=Math.round((start=point.x-focus.paper.bounds[focus.paper._line].x)/ctx.measureText(" ").width),redraw(),input.addEventListener("input",input.onkeydown=input.onkeyup=input.onkeypress=function(){var end,old_bounds;return text.value=this.value,text.paper.compute({line:line}),focus.paper.compute({line:line}),old_bounds=tree.segment.paper.bounds[line].y,tree.segment.paper.setLeftCenter(line,new draw.Point(0,tree.segment.paper.bounds[line].y+tree.segment.paper.bounds[line].height/2)),tree.segment.paper.bounds[line].y!==old_bounds&&tree.segment.paper.setLeftCenter(line,new draw.Point(0,tree.segment.paper.bounds[line].y+tree.segment.paper.bounds[line].height/2-1)),tree.segment.paper.finish(),fastDraw(),out.value=tree.segment.toString({indent:""}),start=text.paper.bounds[line].x+ctx.measureText(this.value.slice(0,this.selectionStart)).width,end=text.paper.bounds[line].x+ctx.measureText(this.value.slice(0,this.selectionEnd)).width,start===end?ctx.strokeRect(start,text.paper.bounds[line].y,0,15):(ctx.fillStyle="rgba(0, 0, 256, 0.3)",ctx.fillRect(start,text.paper.bounds[line].y,end-start,15))}),setTimeout(function(){return input.focus(),input.setSelectionRange(anchor,anchor),input.dispatchEvent(new CustomEvent("input"))},0);else{if(null!=lassoSegment&&lassoBounds.contains(point)?selection=lassoSegment:(null!=lassoSegment&&(lassoSegment.remove(),lassoSegment=null),selection=tree.segment.findBlock(function(block){return block.paper._container.contains(point)})),cloneLater=!1,null==selection){for(selection=null,i=_i=0,_len=floating_blocks.length;_len>_i;i=++_i){if(block=floating_blocks[i],block.block.findBlock(function(x){return x.paper._container.contains(point)}).paper._container.contains(point)){floating_blocks.splice(i,1),selection=block.block;break}selection=null}if(null==selection)for(shiftedPoint=new draw.Point(point.x+PALETTE_WIDTH,point.y),shiftedPoint.add(-scrollOffset.x,-scrollOffset.y),_j=0,_len1=palette_blocks.length;_len1>_j;_j++){if(block=palette_blocks[_j],null!=block.findBlock(function(x){return x.paper._container.contains(shiftedPoint)})){selection=block,cloneLater=!0;break}selection=null}}null!=selection?(null!=selection.start.prev&&"newline"===selection.start.prev.type&&selection.start.prev.remove(),bounds=selection.paper.bounds[selection.paper.lineStart],offset=cloneLater?shiftedPoint.from(new draw.Point(bounds.x,bounds.y)):point.from(new draw.Point(bounds.x,bounds.y)),cloneLater?selection=selection.clone():selection._moveTo(null),redraw(),selection.paper.compute({line:0}),selection.paper.finish(),selection.paper.draw(dragCtx),selection===lassoSegment&&(lassoSegment.paper.prepBounds(),(lassoBounds=lassoSegment.paper.getBounds()).stroke(dragCtx,"#000"),lassoBounds.fill(dragCtx,"rgba(0, 0, 256, 0.3)")),div.onmousemove(event)):(lassoAnchor=lassoHead=point,dragCanvas.style.webkitTransform="translate(0px, 0px)",dragCanvas.style.mozTransform="translate(0px, 0px)",dragCanvas.style.transform="translate(0px, 0px)")}return redraw()}),div.addEventListener("touchmove",div.onmousemove=function(event){var bounds,corner,dest,end,line,old_highlight,point,scrollDest,size,start,text;return point=null!=event.offsetX?new draw.Point(event.offsetX,event.offsetY):new draw.Point(event.layerX,event.layerY),point.add(-PALETTE_WIDTH,0),null!=selection?(scrollDest=new draw.Point(-offset.x+point.x,-offset.y+point.y),point.translate(scrollOffset),dest=new draw.Point(-offset.x+point.x,-offset.y+point.y),old_highlight=highlight,highlight=tree.segment.find(function(block){var _ref;return"socketStart"!==(null!=(_ref=block.start.prev)?_ref.type:void 0)&&null!=block.paper.dropArea&&block.paper.dropArea.contains(dest)}),(highlight!==old_highlight||window.PERFORMANCE_TEST)&&(fastDraw(),null!=highlight&&highlight.paper.dropArea.fill(ctx,"#fff")),dragCanvas.style.webkitTransform="translate("+scrollDest.x+"px, "+scrollDest.y+"px)",dragCanvas.style.mozTransform="translate("+scrollDest.x+"px, "+scrollDest.y+"px)",dragCanvas.style.transform="translate("+scrollDest.x+"px, "+scrollDest.y+"px)",event.preventDefault()):null!=focus&&null!=anchor?(text=focus.content(),line=text.paper._line,head=Math.round((point.x-text.paper.bounds[focus.paper._line].x)/ctx.measureText(" ").width),bounds=text.paper.bounds[line],ctx.clearRect(bounds.x,bounds.y,bounds.width,bounds.height),text.paper.draw(ctx),start=text.paper.bounds[line].x+ctx.measureText(text.value.slice(0,head)).width,end=text.paper.bounds[line].x+ctx.measureText(text.value.slice(0,anchor)).width,start===end?ctx.strokeRect(start,text.paper.bounds[line].y,0,15):(ctx.fillStyle="rgba(0, 0, 256, 0.3)",ctx.fillRect(start,text.paper.bounds[line].y,end-start,15))):null!=lassoAnchor?(dragCtx.clearRect(0,0,dragCanvas.width,dragCanvas.height),dragCtx.strokeStyle="#00f",lassoHead=point,corner={x:Math.min(lassoAnchor.x,point.x),y:Math.min(lassoAnchor.y,point.y)},size={width:Math.abs(lassoAnchor.x-point.x),height:Math.abs(lassoAnchor.y-point.y)},dragCtx.strokeRect(corner.x,corner.y,size.width,size.height)):void 0}),div.addEventListener("touchend",div.onmouseup=function(event){var corner,dest,firstLassoed,lassoRect,lastLassoed,point,size,stack,_head,_ref,_stack;if(null!=selection)if(null!=highlight){switch(highlight.type){case"indent":selection._moveTo(highlight.start.insert(new NewlineToken));break;case"block":selection._moveTo(highlight.end.insert(new NewlineToken));break;case"socket":null!=highlight.content()&&highlight.content().remove(),selection._moveTo(highlight.start)}highlight===tree.segment&&selection._moveTo(highlight.start),redraw()}else point=null!=event.offsetX?new draw.Point(event.offsetX,event.offsetY):new draw.Point(event.layerX,event.layerY),point.add(-PALETTE_WIDTH,0),point.translate(scrollOffset),dest=new draw.Point(-offset.x+point.x,-offset.y+point.y),dest.x>0&&(selection.paper.compute({line:0}),selection.paper.translate(dest),selection.paper.finish(),selection.paper.draw(ctx),floating_blocks.push({block:selection,position:dest}));else if(null!=focus)input.setSelectionRange(Math.min(anchor,head),Math.max(anchor,head)),anchor=head=null;else if(null!=lassoAnchor){for(corner={x:Math.min(lassoAnchor.x,lassoHead.x),y:Math.min(lassoAnchor.y,lassoHead.y)},size={width:Math.abs(lassoAnchor.x-lassoHead.x),height:Math.abs(lassoAnchor.y-lassoHead.y)},lassoRect=new draw.Rectangle(corner.x,corner.y,size.width,size.height),firstLassoed=null,head=tree.segment.start;head!==tree.segment.end;){if("blockStart"===head.type&&head.block.paper._container.intersects(lassoRect)){firstLassoed=head.block;break}head=head.next}for(lastLassoed=null,head=tree.segment.end;head!==tree.segment.start;){if("blockEnd"===head.type&&head.block.paper._container.intersects(lassoRect)){lastLassoed=head.block;break}head=head.prev}if(null!=firstLassoed&&null!=lastLassoed){for(stack=[firstLassoed],head=firstLassoed.start.next;head!==lastLassoed.end;){switch(head.type){case"blockStart":stack.push(head.block);break;case"segmentStart":stack.push(head.segment);break;case"indentStart":stack.push(head.indent);break;case"blockEnd":stack.length>0?stack.pop():firstLassoed=head.block;break;case"segmentEnd":stack.length>0?stack.pop():firstLassoed=head.segment;break;case"indentEnd":if(stack.length>0)stack.pop();else for(console.log(head.indent,stack),firstLassoed=head.indent,_head=head.indent.start,_stack=[];null!==_head;){if("blockEnd"===_head.type)_stack.push(_head.block);else if("blockStart"===_head.type){if(console.log(_head.block.toString(),stack),!(_stack.length>0)){stack.unshift(_head.block),firstLassoed=_head.block;break}_stack.pop()}_head=_head.prev}}head=head.next}if("indent"===stack[0].type)for(head=stack[0].end,_stack=[];null!==head;){if("blockStart"===head.type)console.log("discards",head.block.toString()),_stack.push(head.block);else if("blockEnd"===head.type){if(console.log(head.block.toString(),stack),!(_stack.length>0)){_ref=head.block,__indexOf.call(stack,_ref)<0&&(firstLassoed=head.block),stack[0]=head.block;break}_stack.pop()}head=head.next}lastLassoed=stack[0],lassoSegment=new Segment([]),firstLassoed.start.prev.insert(lassoSegment.start),lastLassoed.end.insert(lassoSegment.end)}}return dragCtx.clearRect(0,0,canvas.width,canvas.height),selection=null,lassoAnchor=null,redraw()}),div.addEventListener("mousewheel",function(event){return scrollOffset.y>0||event.deltaY>0?(ctx.translate(0,-event.deltaY),scrollOffset.add(0,event.deltaY),fastDraw(),event.preventDefault(),!1):!0}),out.onkeyup=function(){var e;try{return tree=coffee.parse(out.value),redraw()}catch(_error){return e=_error,ctx.fillStyle="#f00",ctx.fillText(e.message,0,0)}},palette_blocks=[coffee.parse("a = b").segment,coffee.parse("alert 'hi'").segment,coffee.parse("for i in [1..10]\n  alert 'good'").segment,coffee.parse("return 0").segment],running_height=0,_i=0,_len=palette_blocks.length;_len>_i;_i++)block=palette_blocks[_i],block.paper.compute({line:0}),block.paper.translate(new draw.Point(0,running_height)),block.paper.finish(),running_height=block.paper.bounds[block.paper.lineEnd].bottom()+PALETTE_WHITESPACE,block.paper.draw(paletteCtx)}return Editor}(),window.onload=function(){return window.RUN_PAPER_TESTS?(out=document.getElementById("out"),new Editor(document.getElementById("editor"))):void 0}}).call(this);