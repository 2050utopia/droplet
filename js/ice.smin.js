(function(){var t,e,n,i,s,r,o,l,h,u,d,a,c,p,f,w,y,v,m,b,x,g,k,S,E,_,P,B,C,T,O,I,R,A,M,D,z,L,N,W,V,X,F,H,Y={}.hasOwnProperty,j=function(t,e){for(var n in e){if(Y.call(e,n))t[n]=e[n]}function i(){this.constructor=t}i.prototype=e.prototype;t.prototype=new i;t.__super__=e.prototype;return t},U=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++){if(e in this&&this[e]===t)return e}return-1};H={};H.Block=t=function(){function t(t){var s,r,o,l;this.start=new n(this);this.end=new e(this);this.type="block";this.color="#ddf";this.selected=false;s=this.start;for(o=0,l=t.length;o<l;o++){r=t[o];s=s.append(r.clone())}s.append(this.end);this.view=new i(this)}t.prototype.clone=function(){var e,n,i,s;n=new t([]);n.color=this.color;s=this.start.next;i=n.start;while(s!==this.end){switch(s.type){case"blockStart":e=s.block.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.block.end;break;case"socketStart":e=s.socket.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.socket.end;break;case"indentStart":e=s.indent.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.indent.end;break;default:if(s.type!=="cursorToken"){i=i.append(s.clone())}}s=s.next}i.append(n.end);return n};t.prototype.inSocket=function(){var t;t=this.start.prev;while(t!=null&&t.type==="segmentStart"){t=t.prev}return t!=null&&t.type==="socketStart"};t.prototype.moveTo=function(t){var e,n,i;while(this.start.prev!=null&&this.start.prev.type==="segmentStart"&&this.start.prev.segment.end===this.end.next){this.start.prev.segment.remove()}if(this.end.next!=null&&this.start.prev!=null){n=this.end.next;while(n!=null&&(n.type==="segmentEnd"||n.type==="cursor")){n=n.next}e=this.start.prev;while(e!=null&&(e.type==="segmentStart"||e.type==="cursor")){e=e.prev}if(e!=null&&e.type==="newline"&&(n==null||n.type==="newline"||n.type==="indentEnd")&&!(((i=e.prev)!=null?i.type:void 0)==="indentStart"&&n.type==="indentEnd")){e.remove()}else if(n!=null&&n.type==="newline"&&(e==null||e.type==="newline")){n.remove()}}if(this.start.prev!=null){this.start.prev.next=this.end.next}if(this.end.next!=null){this.end.next.prev=this.start.prev}this.start.prev=this.end.next=null;if(t!=null){this.end.next=t.next;t.next.prev=this.end;t.next=this.start;return this.start.prev=t}};t.prototype.find=function(t){var e;e=this.start.next;while(e!==this.end){if(e.type==="blockStart"&&t(e.block)){return e.block.find(t)}else if(e.type==="indentStart"&&t(e.indent)){return e.indent.find(t)}else if(e.type==="socketStart"&&t(e.socket)){return e.socket.find(t)}e=e.next}if(t(this)){return this}else{return null}};t.prototype.toString=function(){var t;t=this.start.toString({indent:""});return t.slice(0,+(t.length-this.end.toString({indent:""}).length-1)+1||9e9)};return t}();H.Indent=m=function(){function t(t,e){var n,i,s,r;this.depth=e;this.start=new x(this);this.end=new b(this);this.type="indent";i=this.start;for(s=0,r=t.length;s<r;s++){n=t[s];i=i.append(n.clone())}i.append(this.end);this.view=new g(this)}t.prototype.clone=function(){var e,n,i,s;n=new t([],this.depth);s=this.start.next;i=n.start;while(s!==this.end){switch(s.type){case"blockStart":e=s.block.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.block.end;break;case"socketStart":e=s.socket.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.socket.end;break;case"indentStart":e=s.indent.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.indent.end;break;default:if(s.type!=="cursorToken"){i=i.append(s.clone())}}s=s.next}i.append(n.end);return n};t.prototype.find=function(t){var e;e=this.start.next;while(e!==this.end){if(e.type==="blockStart"&&t(e.block)){return e.block.find(t)}else if(e.type==="indentStart"&&t(e.indent)){return e.indent.find(t)}else if(e.type==="socketStart"&&t(e.socket)){return e.socket.find(t)}e=e.next}if(t(this)){return this}else{return null}};t.prototype.toString=function(t){var e;e=this.start.toString(t);return e.slice(0,e.length-this.end.toString(t).length-1)};return t}();H.Segment=C=function(){function t(t){var e,n,i,s;this.start=new O(this);this.end=new T(this);this.type="segment";n=this.start;for(i=0,s=t.length;i<s;i++){e=t[i];n=n.append(e.clone())}n.append(this.end);this.view=new I(this)}t.prototype.clone=function(){var e,n,i,s;n=new t([]);s=this.start.next;i=n.start;while(s!==this.end){switch(s.type){case"blockStart":e=s.block.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.block.end;break;case"socketStart":e=s.socket.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.socket.end;break;case"indentStart":e=s.indent.clone();e.start.prev=i;i.next=e.start;i=e.end;s=s.indent.end;break;default:if(s.type!=="cursorToken"){i=i.append(s.clone())}}s=s.next}i.append(n.end);return n};t.prototype.remove=function(){this.start.remove();this.end.remove();this.start.next=this.end;return this.end.prev=this.start};t.prototype.moveTo=function(t){var e,n,i;while(this.start.prev!=null&&this.start.prev.type==="segmentStart"&&this.start.prev.segment.end===this.end.next){this.start.prev.segment.remove()}if(this.end.next!=null&&this.start.prev!=null){n=this.end.next;while(n!=null&&(n.type==="segmentEnd"||n.type==="cursor")){n=n.next}e=this.start.prev;while(e!=null&&(e.type==="segmentStart"||e.type==="cursor")){e=e.prev}if(e!=null&&e.type==="newline"&&(n==null||n.type==="newline"||n.type==="indentEnd")&&!(((i=e.prev)!=null?i.type:void 0)==="indentStart"&&n.type==="indentEnd")){e.remove()}else if(n!=null&&n.type==="newline"&&(e==null||e.type==="newline")){n.remove()}}if(this.start.prev!=null){this.start.prev.next=this.end.next}if(this.end.next!=null){this.end.next.prev=this.start.prev}this.start.prev=this.end.next=null;if(t!=null){this.end.next=t.next;t.next.prev=this.end;t.next=this.start;return this.start.prev=t}};t.prototype.find=function(t){var e;e=this.start.next;while(e!==this.end){if(e.type==="blockStart"&&t(e.block)){return e.block.find(t)}else if(e.type==="indentStart"&&t(e.indent)){return e.indent.find(t)}else if(e.type==="socketStart"&&t(e.socket)){return e.socket.find(t)}e=e.next}if(t(this)){return this}else{return null}};t.prototype.toString=function(){var t;t=this.start.toString({indent:""});return t.slice(0,t.length-this.end.toString({indent:""}).length)};return t}();H.Socket=R=function(){function t(t){this.start=new M(this);this.end=new A(this);if(t!=null&&t.start!=null){this.start.next=t.start;t.start.prev=this.start;this.end.prev=t.end;t.end.next=this.end}else if(t!=null){this.start.next=t;t.prev=this.start;this.end.prev=t;t.next=this.end}else{this.start.next=this.end;this.end.prev=this.start}this.type="socket";this.handwritten=false;this.view=new D(this)}t.prototype.clone=function(){if(this.content()!=null){return new t(this.content().clone())}else{return new t}};t.prototype.content=function(){var t;t=function(e){switch(e.type){case"blockStart":return e.block;case"segmentStart":return t(e.next);default:return e}};if(this.start.next!==this.end){return t(this.start.next)}else{return null}};t.prototype.find=function(t){var e;e=this.start.next;while(e!==this.end){if(e.type==="blockStart"&&t(e.block)){return e.block.find(t)}else if(e.type==="indentStart"&&t(e.indent)){return e.indent.find(t)}else if(e.type==="socketStart"&&t(e.socket)){return e.socket.find(t)}e=e.next}if(t(this)){return this}else{return null}};return t}();H.Token=F=function(){function t(){this.prev=this.next=null}t.prototype.append=function(t){t.prev=this;return this.next=t};t.prototype.insert=function(t){if(this.next!=null){t.next=this.next;this.next.prev=t}t.prev=this;this.next=t;return this.next};t.prototype.insertBefore=function(t){if(this.prev!=null){t.prev=this.prev;this.prev.next=t}t.next=this;this.prev=t;return this.prev};t.prototype.remove=function(){if(this.prev!=null){this.prev.next=this.next}if(this.next!=null){this.next.prev=this.prev}return this.prev=this.next=null};t.prototype.toString=function(t){if(this.next!=null){return this.next.toString(t)}else{return""}};return t}();H.CursorToken=r=function(t){j(e,t);function e(){this.prev=this.next=null;this.view=new o(this);this.type="cursor"}e.prototype.clone=function(){return new e};return e}(F);H.TextToken=V=function(t){j(e,t);function e(t){this.value=t;this.prev=this.next=null;this.view=new X(this);this.type="text"}e.prototype.clone=function(){return new e(this.value)};e.prototype.toString=function(t){return this.value+(this.next!=null?this.next.toString(t):"")};return e}(F);H.BlockStartToken=n=function(t){j(e,t);function e(t){this.block=t;this.prev=this.next=null;this.type="blockStart"}return e}(F);H.BlockEndToken=e=function(t){j(e,t);function e(t){this.block=t;this.prev=this.next=null;this.type="blockEnd"}return e}(F);H.SocketStartToken=M=function(t){j(e,t);function e(t){this.socket=t;this.prev=this.next=null;this.type="socketStart"}return e}(F);H.SocketEndToken=A=function(t){j(e,t);function e(t){this.socket=t;this.prev=this.next=null;this.type="socketEnd"}return e}(F);H.SegmentStartToken=O=function(t){j(e,t);function e(t){this.segment=t;this.prev=this.next=null;this.type="segmentStart"}return e}(F);H.SegmentEndToken=T=function(t){j(e,t);function e(t){this.segment=t;this.prev=this.next=null;this.type="segmentEnd"}return e}(F);H.IndentStartToken=x=function(t){j(e,t);function e(t){this.indent=t;this.prev=this.next=null;this.type="indentStart"}e.prototype.toString=function(t){t.indent+=function(){var t,e,n;n=[];for(t=1,e=this.indent.depth;1<=e?t<=e:t>=e;1<=e?t++:t--){n.push(" ")}return n}.call(this).join("");if(this.next){return this.next.toString(t)}else{return""}};return e}(F);H.IndentEndToken=b=function(t){j(e,t);function e(t){this.indent=t;this.prev=this.next=null;this.type="indentEnd"}e.prototype.toString=function(t){t.indent=t.indent.slice(0,-this.indent.depth);if(this.next){return this.next.toString(t)}else{return""}};return e}(F);H.NewlineToken=S=function(t){j(e,t);function e(){this.prev=this.next=null;this.type="newline"}e.prototype.clone=function(){return new e};e.prototype.toString=function(t){return"\n"+t.indent+(this.next?this.next.toString(t):"")};return e}(F);window.ICE=H;E=5;f=10;W=10;c=15;u=c+E*2;d=20;l=c+E*2;h=50;k=100;N=15;z=5;L=10;s=function(){function t(t){this.x=t.x;this.y=t.y}return t}();B=function(){function t(t,e){this.left=t;this.right=e}return t}();v=function(){function t(t){this.block=t;this.children=[];this.lineStart=this.lineEnd=null;this.lineChildren={};this.dimensions={};this.cursors=[];this.indented={};this.indentEndsOn={};this.indentStartsOn={};this.pathWaypoints={};this.bounds={}}t.prototype.computeChildren=function(t){var e,n,i,s,r,o,l,h,u,d,a,c,p,f,w,y,v,m,b,x,g,k,S,E,_,P,B,C,T,O;this.children=[];this.lineStart=this.lineEnd=null;this.lineChildren={};this.dimensions={};this.indented={};this.indentEndsOn={};this.indentStartsOn={};this.pathWaypoints={};this.bounds={};this.cursors=[];this.lineStart=t;e=this.block.start.next;while(e!==this.block.end){switch(e.type){case"blockStart":t=e.block.view.computeChildren(t);this.children.push(e.block.view);for(i=y=g=e.block.view.lineStart,k=e.block.view.lineEnd;g<=k?y<=k:y>=k;i=g<=k?++y:--y){if((s=this.lineChildren)[i]==null){s[i]=[]}this.lineChildren[i].push(e.block.view);(r=this.indented)[i]||(r[i]=e.block.view.indented[i]);(h=this.indentEndsOn)[i]||(h[i]=e.block.view.indentEndsOn[i])}e=e.block.end;break;case"indentStart":t=e.indent.view.computeChildren(t);this.children.push(e.indent.view);for(i=v=S=e.indent.view.lineStart,E=e.indent.view.lineEnd;S<=E?v<=E:v>=E;i=S<=E?++v:--v){if((u=this.lineChildren)[i]==null){u[i]=[]}this.lineChildren[i].push(e.indent.view);this.indented[i]=true}this.indentEndsOn[e.indent.view.lineEnd]=true;this.indentStartsOn[e.indent.view.lineStart]=true;e=e.indent.end;break;case"socketStart":t=e.socket.view.computeChildren(t);this.children.push(e.socket.view);for(i=m=_=e.socket.view.lineStart,P=e.socket.view.lineEnd;_<=P?m<=P:m>=P;i=_<=P?++m:--m){if((d=this.lineChildren)[i]==null){d[i]=[]}this.lineChildren[i].push(e.socket.view);(a=this.indented)[i]||(a[i]=e.socket.view.indented[i]);(c=this.indentEndsOn)[i]||(c[i]=e.socket.view.indentEndsOn[i])}e=e.socket.end;break;case"segmentStart":t=e.segment.view.computeChildren(t);this.children.push(e.segment.view);for(i=b=B=e.segment.view.lineStart,C=e.segment.view.lineEnd;B<=C?b<=C:b>=C;i=B<=C?++b:--b){if((p=this.lineChildren)[i]==null){p[i]=[]}this.lineChildren[i].push(e.segment.view);(f=this.indented)[i]||(f[i]=e.segment.view.indented[i]);(w=this.indentEndsOn)[i]||(w[i]=e.segment.view.indentEndsOn[i])}e=e.segment.end;break;case"text":e.view.computeChildren(t);this.children.push(e.view);if((o=this.lineChildren)[t]==null){o[t]=[]}this.lineChildren[t].push(e.view);break;case"cursor":this.cursors.push({token:e,line:t});break;case"newline":t+=1}e=e.next}this.lineEnd=t;for(n=x=T=this.lineStart,O=this.lineEnd;T<=O?x<=O:x>=O;n=T<=O?++x:--x){if((l=this.lineChildren)[n]==null){l[n]=[]}}return t};t.prototype.computeDimensions=function(){var t,e,n,i;i=this.children;for(e=0,n=i.length;e<n;e++){t=i[e];t.computeDimensions()}return this.dimensions};t.prototype.computeBoundingBox=function(t,e){var n,i,s,r;r=this.lineChildren[t];for(i=0,s=r.length;i<s;i++){n=r[i];n.computeBoundingBox(t,e)}return this.bounds[t]=new draw.NoRectangle};t.prototype.computePath=function(){var t,e,n,i;i=this.children;for(e=0,n=i.length;e<n;e++){t=i[e];t.computePath()}return this.bounds};t.prototype.drawPath=function(t){var e,n,i,s,r;s=this.children;r=[];for(n=0,i=s.length;n<i;n++){e=s[n];r.push(e.drawPath(t))}return r};t.prototype.drawCursor=function(t){var e,n,i,s,r,o,l,h,u,d;h=this.children;for(s=0,o=h.length;s<o;s++){e=h[s];e.drawCursor(t)}u=this.cursors;d=[];for(r=0,l=u.length;r<l;r++){n=u[r];if(n.token.prev.type==="newline"||n.token.prev.type==="segmentStart"){i=this.bounds[n.line].y}else{i=this.bounds[n.line].bottom()}n.token.view.point.y=i;t.fillStyle="#000";t.strokeSTyle="#000";t.beginPath();if(this.bounds[n.line].x>=5){t.moveTo(this.bounds[n.line].x,i);t.lineTo(this.bounds[n.line].x-5,i-5);t.lineTo(this.bounds[n.line].x-5,i+5)}else{t.moveTo(this.bounds[n.line].x,i);t.lineTo(this.bounds[n.line].x+5,i-5);t.lineTo(this.bounds[n.line].x+5,i+5)}t.stroke();d.push(t.fill())}return d};t.prototype.draw=function(t){this.drawPath(t);return this.drawCursor(t)};t.prototype.computeBoundingBoxes=function(){var t,e,n,i,r;t=new draw.Point(0,0);for(e=n=i=this.lineStart,r=this.lineEnd;i<=r?n<=r:n>=r;e=i<=r?++n:--n){this.computeBoundingBox(e,new s(t));t.y+=this.dimensions[e].height}return this.bounds};t.prototype.getBounds=function(){var t,e,n,i,s;t=new draw.NoRectangle;for(e=n=i=this.lineStart,s=this.lineEnd;i<=s?n<=s:n>=s;e=i<=s?++n:--n){t.unite(this.bounds[e])}return t};t.prototype.compute=function(t){if(t==null){t=0}this.computeChildren(t);this.computeDimensions();this.computeBoundingBoxes();return this.computePath()};t.prototype.translate=function(t){var e,n,i,s,r,o,l,h;o=this.bounds;for(i in o){e=o[i];e.translate(t)}l=this.children;h=[];for(s=0,r=l.length;s<r;s++){n=l[s];h.push(n.translate(t))}return h};return t}();i=function(t){j(e,t);function e(t){e.__super__.constructor.call(this,t);this.path=null}e.prototype.computeDimensions=function(){var t,n,i,s,r,o,l,h,u,d,a;e.__super__.computeDimensions.apply(this,arguments);a=[];for(i=r=h=this.lineStart,u=this.lineEnd;h<=u?r<=u:r>=u;i=h<=u?++r:--r){s=E;n=2*E;d=this.lineChildren[i];for(o=0,l=d.length;o<l;o++){t=d[o];if(t.block.type==="indent"){s+=t.dimensions[i].width+f;n=Math.max(n,t.dimensions[i].height+(t.lineEnd===i?W:0))}else if(t.indented[i]){s+=t.dimensions[i].width+E;n=Math.max(n,t.dimensions[i].height)}else{s+=t.dimensions[i].width+E;n=Math.max(n,t.dimensions[i].height+2*E)}}a.push(this.dimensions[i]=new draw.Size(s,n))}return a};e.prototype.computeBoundingBox=function(t,e){var n,i,r,o,l,h,u,d;n=e.y+this.dimensions[t].height/2;r=e.x;this.bounds[t]=new draw.Rectangle(e.x,e.y,this.dimensions[t].width,this.dimensions[t].height);d=this.lineChildren[t];for(h=0,u=d.length;h<u;h++){i=d[h];if(i.block.type==="indent"){r+=f;i.computeBoundingBox(t,new s(new draw.Point(r,e.y)))}else{r+=E;i.computeBoundingBox(t,new s(new draw.Point(r,n-i.dimensions[t].height/2)))}r+=i.dimensions[t].width}if(this.lineChildren[t].length>0&&!(this.lineChildren[t][0].indented[t]||this.lineChildren[t][0].block.type==="indent")){return this.pathWaypoints[t]=new B([new draw.Point(this.bounds[t].x,this.bounds[t].y),new draw.Point(this.bounds[t].x,this.bounds[t].bottom())],[new draw.Point(this.bounds[t].right(),this.bounds[t].y),new draw.Point(this.bounds[t].right(),this.bounds[t].bottom())])}else if(this.lineChildren[t].length>0){if(t===this.lineChildren[t][0].lineEnd&&this.lineChildren[t][0].block.type==="indent"){o=this.lineChildren[t][0];l=this.lineChildren[t][0].block.type==="indent"?f:E;if(this.lineChildren[t].length===1){return this.pathWaypoints[t]=new B([new draw.Point(this.bounds[t].x,this.bounds[t].y),new draw.Point(this.bounds[t].x,this.bounds[t].bottom())],[new draw.Point(this.bounds[t].x+l,this.bounds[t].y),new draw.Point(this.bounds[t].x+l,o.bounds[t].bottom()),new draw.Point(o.bounds[t].right(),o.bounds[t].bottom()),new draw.Point(this.bounds[t].right(),o.bounds[t].bottom()),new draw.Point(this.bounds[t].right(),this.bounds[t].bottom())])}else{return this.pathWaypoints[t]=new B([new draw.Point(this.bounds[t].x,this.bounds[t].y),new draw.Point(this.bounds[t].x,this.bounds[t].bottom())],[new draw.Point(this.bounds[t].x+l,this.bounds[t].y),new draw.Point(this.bounds[t].x+l,o.bounds[t].bottom()),new draw.Point(o.bounds[t].right(),o.bounds[t].bottom()),new draw.Point(o.bounds[t].right(),this.bounds[t].y),new draw.Point(this.bounds[t].right(),this.bounds[t].y),new draw.Point(this.bounds[t].right(),this.bounds[t].bottom())])}}else{return this.pathWaypoints[t]=new B([new draw.Point(this.bounds[t].x,this.bounds[t].y),new draw.Point(this.bounds[t].x,this.bounds[t].bottom())],[new draw.Point(this.bounds[t].x+f,this.bounds[t].y),new draw.Point(this.bounds[t].x+f,this.bounds[t].bottom())])}}};e.prototype.computePath=function(){var t,n,i,s,r,o,l,h,u,d,a,c,p;e.__super__.computePath.apply(this,arguments);this.path=new draw.Path;this.dropArea=new draw.Rectangle(this.bounds[this.lineEnd].x,this.bounds[this.lineEnd].bottom()-5,this.bounds[this.lineEnd].width,10);if(!((u=this.block.inSocket())!=null?u:false)){this.path.push(new draw.Point(this.bounds[this.lineStart].x+L,this.bounds[this.lineStart].y));this.path.push(new draw.Point(this.bounds[this.lineStart].x+L+N/8,this.bounds[this.lineStart].y+z));this.path.push(new draw.Point(this.bounds[this.lineStart].x+L+N*7/8,this.bounds[this.lineStart].y+z));this.path.push(new draw.Point(this.bounds[this.lineStart].x+L+N,this.bounds[this.lineStart].y))}d=this.pathWaypoints;for(n in d){s=d[n];if(this.indentStartsOn[n]){t=new draw.Point(this.bounds[n].x+f+L+N,this.bounds[n].y);if(this.path._points.length>0&&t.y!==this.path._points[this.path._points.length-1].y){this.path.push(new draw.Point(this.path._points[this.path._points.length-1].x,t.y))}this.path.push(t);this.path.push(new draw.Point(this.bounds[n].x+f+L+N*7/8,this.bounds[n].y+z));this.path.push(new draw.Point(this.bounds[n].x+f+L+N/8,this.bounds[n].y+z));this.path.push(new draw.Point(this.bounds[n].x+f+L,this.bounds[n].y))}a=s.left;for(r=0,l=a.length;r<l;r++){i=a[r];if(this.path._points.length>0&&i.x!==this.path._points[0].x){this.path.unshift(new draw.Point(i.x,this.path._points[0].y))}this.path.unshift(i)}c=s.right;for(o=0,h=c.length;o<h;o++){i=c[o];if(this.path._points.length>0&&i.y!==this.path._points[this.path._points.length-1].y){this.path.push(new draw.Point(this.path._points[this.path._points.length-1].x,i.y))}this.path.push(i)}}if(!((p=this.block.inSocket())!=null?p:false)){this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+L,this.bounds[this.lineEnd].bottom()));this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+L+N/8,this.bounds[this.lineEnd].bottom()+z));this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+L+N*7/8,this.bounds[this.lineEnd].bottom()+z));this.path.unshift(new draw.Point(this.bounds[this.lineEnd].x+L+N,this.bounds[this.lineEnd].bottom()))}this.path.style.fillColor=this.block.color;return this.path.style.strokeColor="#000"};e.prototype.drawPath=function(t){if(this.path._points.length===0){debugger}this.path.draw(t);return e.__super__.drawPath.apply(this,arguments)};e.prototype.translate=function(t){this.path.translate(t);return e.__super__.translate.apply(this,arguments)};return e}(v);X=function(t){j(e,t);function e(t){e.__super__.constructor.call(this,t);this.textElement=null}e.prototype.computeChildren=function(t){return this.lineStart=this.lineEnd=t};e.prototype.computeDimensions=function(){this.textElement=new draw.Text(new draw.Point(0,0),this.block.value);this.dimensions[this.lineStart]=new draw.Size(this.textElement.bounds().width,this.textElement.bounds().height);return this.dimesions};e.prototype.computeBoundingBox=function(t,e){if(t===this.lineStart){this.bounds[t]=new draw.Rectangle(e.x,e.y,this.dimensions[t].width,this.dimensions[t].height);return this.textElement.setPosition(new draw.Point(e.x,e.y))}};e.prototype.computePath=function(){};e.prototype.drawPath=function(t){return this.textElement.draw(t)};e.prototype.translate=function(t){this.textElement.translate(t);return e.__super__.translate.apply(this,arguments)};return e}(v);g=function(t){j(e,t);function e(t){e.__super__.constructor.call(this,t)}e.prototype.computeChildren=function(t){e.__super__.computeChildren.apply(this,arguments);this.lineStart+=1;return this.lineEnd};e.prototype.computeDimensions=function(){var t,n,i,s,r,o,u,d,a,c,p;e.__super__.computeDimensions.apply(this,arguments);if(this.lineEnd>=this.lineStart){p=[];for(i=r=d=this.lineStart,a=this.lineEnd;d<=a?r<=a:r>=a;i=d<=a?++r:--r){n=s=0;c=this.lineChildren[i];for(o=0,u=c.length;o<u;o++){t=c[o];s+=t.dimensions[i].width;n=Math.max(n,t.dimensions[i].height)}n=Math.max(n,l);s=Math.max(s,h);p.push(this.dimensions[i]=new draw.Size(s,n))}return p}};e.prototype.computeBoundingBox=function(t,e){var n,i,r,o,l,h,u;i=e.x;r=e.y;this.bounds[t]=new draw.Rectangle(e.x,e.y,this.dimensions[t].width,this.dimensions[t].height);h=this.lineChildren[t];u=[];for(o=0,l=h.length;o<l;o++){n=h[o];n.computeBoundingBox(t,new s(new draw.Point(i,r)));u.push(i+=n.dimensions[t].width)}return u};e.prototype.computePath=function(){this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,this.bounds[this.lineStart].width,10);return e.__super__.computePath.apply(this,arguments)};return e}(v);D=function(t){j(e,t);function e(t){e.__super__.constructor.call(this,t)}e.prototype.computeDimensions=function(){var t,n,i,s;e.__super__.computeDimensions.apply(this,arguments);if((t=this.block.content())!=null){switch(this.block.content().type){case"block":s=t.view.dimensions;for(n in s){i=s[n];this.dimensions[n]=new draw.Size(i.width,i.height)}break;case"text":this.dimensions[t.view.lineStart]=new draw.Size(t.view.dimensions[t.view.lineStart].width+2*E,t.view.dimensions[t.view.lineStart].height+2*E);this.dimensions[t.view.lineStart].width=Math.max(this.dimensions[t.view.lineStart].width,d)}}else{this.dimensions[this.lineStart]=new draw.Size(d,u)}return this.dimensions};e.prototype.computeBoundingBox=function(t,e){this.bounds[t]=new draw.Rectangle(e.x,e.y,this.dimensions[t].width,this.dimensions[t].height);if(this.lineChildren[t].length===0){}else if(this.lineChildren[t].length>1){throw"Error: more than one child inside a socket"}else if(this.block.content().type==="text"){return this.lineChildren[t][0].computeBoundingBox(t,new s(new draw.Point(e.x+E,e.y+E)))}else{return this.lineChildren[t][0].computeBoundingBox(t,e)}};e.prototype.computePath=function(){var t;if(((t=this.block.content())!=null?t.type:void 0)!=="block"){(this.dropArea=new draw.Rectangle).copy(this.bounds[this.lineStart])}return e.__super__.computePath.apply(this,arguments)};e.prototype.drawPath=function(t){if(this.block.content()==null||this.block.content().type==="text"){this.bounds[this.lineStart].stroke(t,"#000");this.bounds[this.lineStart].fill(t,"#FFF")}return e.__super__.drawPath.apply(this,arguments)};return e}(v);I=function(t){j(e,t);function e(t){e.__super__.constructor.call(this,t)}e.prototype.computeDimensions=function(){var t,n,i,s,r,o,l,h,u,d,a;e.__super__.computeDimensions.apply(this,arguments);a=[];for(i=r=h=this.lineStart,u=this.lineEnd;h<=u?r<=u:r>=u;i=h<=u?++r:--r){n=s=0;d=this.lineChildren[i];for(o=0,l=d.length;o<l;o++){t=d[o];s+=t.dimensions[i].width;n=Math.max(n,t.dimensions[i].height)}a.push(this.dimensions[i]=new draw.Size(s,n))}return a};e.prototype.computeBoundingBox=function(t,e){var n,i,r,o,l,h,u;i=e.x;r=e.y;this.bounds[t]=new draw.Rectangle(e.x,e.y,this.dimensions[t].width,this.dimensions[t].height);h=this.lineChildren[t];u=[];for(o=0,l=h.length;o<l;o++){n=h[o];n.computeBoundingBox(t,new s(new draw.Point(i,r)));u.push(i+=n.dimensions[t].width)}return u};e.prototype.drawPath=function(){this.dropArea=new draw.Rectangle(this.bounds[this.lineStart].x,this.bounds[this.lineStart].y-5,Math.max(this.bounds[this.lineStart].width,k),10);return e.__super__.drawPath.apply(this,arguments)};return e}(v);o=function(){function t(t){this.block=t;this.point=new draw.Point(0,0)}return t}();p=2;w=15;_=10;P=300;H.IceEditorChangeEvent=y=function(){function t(t,e){this.block=t;this.target=e}return t}();H.Editor=a=function(){function e(e,n){var i,s,o,l,h,u,d,a,c,f,v,b,x,g,k,E,B,T,O,I,A,M,D,z,L,N,W,X,F,H,Y,j,q,G,J,K,Q,Z,$,te,ee,ne,ie=this;this.paletteBlocks=n;if(this.paletteBlocks==null){this.paletteBlocks=[]}this.paletteBlocks=function(){var t,e,n,i;n=this.paletteBlocks;i=[];for(t=0,e=n.length;t<e;t++){L=n[t];i.push(L.clone())}return i}.call(this);this.tree=null;this.floatingBlocks=[];this.focus=null;this.editedText=null;this.handwritten=false;this.hiddenInput=null;this.isEditingText=function(){return ie.hiddenInput===document.activeElement};j=q=null;G=false;K=-1;this.selection=null;this.lassoSegment=null;this._lassoBounds=null;this.cursor=new r;this.scrollOffset=new draw.Point(0,0);D=null;a=null;E=document.createElement("canvas");E.className="canvas";E.height=e.offsetHeight;E.width=e.offsetWidth-P;z=document.createElement("canvas");z.className="palette";z.height=e.offsetHeight;z.width=P;o=document.createElement("canvas");o.className="drag";o.height=e.offsetHeight;o.width=e.offsetWidth-P;this.hiddenInput=document.createElement("input");this.hiddenInput.className="hidden_input";J=document.createElement("div");J.className="trackArea";ee=[E,z,o,J,this.hiddenInput];for(Q=0,$=ee.length;Q<$;Q++){i=ee[Q];e.appendChild(i)}B=E.getContext("2d");l=o.getContext("2d");N=z.getContext("2d");draw._setCTX(B);this.clear=function(){return B.clearRect(ie.scrollOffset.x,ie.scrollOffset.y,E.width,E.height)};this.redraw=function(){var t,e,n,i,s,r,o,l,h;ie.clear();ie.tree.view.compute();ie.tree.view.draw(B);if(ie.lassoSegment!=null){ie._lassoBounds=ie.lassoSegment.view.getBounds();o=ie.floatingBlocks;for(n=0,s=o.length;n<s;n++){t=o[n];if(ie.lassoSegment===t.block){ie._lassoBounds.translate(t.position)}}if(ie.lassoSegment!==ie.selection){ie._lassoBounds.stroke(B,"#000");ie._lassoBounds.fill(B,"rgba(0, 0, 256, 0.3)")}}l=ie.floatingBlocks;h=[];for(i=0,r=l.length;i<r;i++){t=l[i];e=t.block.view;e.compute();e.translate(t.position);h.push(e.draw(B))}return h};this.attemptReparse=function(){try{ie.tree=coffee.parse(ie.getValue()).segment;return ie.redraw()}catch(t){}};T=function(t,e){t.moveTo(e);if(ie.onChange!=null){return ie.onChange(new y(t,e))}};this.redrawPalette=function(){var t,e,n,i,s;t=0;i=ie.paletteBlocks;s=[];for(e=0,n=i.length;e<n;e++){L=i[e];L.view.compute();L.view.translate(new draw.Point(0,t));t=L.view.bounds[L.view.lineEnd].bottom()+_;s.push(L.view.draw(N))}return s};this.redrawPalette();k=function(){var e,n;e=new t([]);n=new R([]);n.handwritten=true;e.start.insert(n.start);e.end.prev.insert(n.end);if(ie.cursor.next.type==="newline"||ie.cursor.next.type==="indentEnd"||ie.cursor.next.type==="segmentEnd"){if(ie.cursor.next.type==="indentEnd"&&ie.cursor.prev.type==="newline"){T(e,ie.cursor.prev)}else{T(e,ie.cursor.prev.insert(new S))}ie.redraw();H(n)}else if(ie.cursor.prev.type==="newline"||ie.cursor.prev.type==="segmentStart"){T(e,ie.cursor.prev);e.end.insert(new S);ie.redraw();H(n)}return X()};X=function(){ie.redraw();if(ie.cursor.view.point.y<ie.scrollOffset.y){B.translate(0,ie.scrollOffset.y-ie.cursor.view.point.y);ie.scrollOffset.y=ie.cursor.view.point.y;return ie.redraw()}else if(ie.cursor.view.point.y>ie.scrollOffset.y+E.height){B.translate(0,ie.scrollOffset.y+E.height-ie.cursor.view.point.y);ie.scrollOffset.y=ie.cursor.view.point.y-E.height;return ie.redraw()}};A=function(t){ie.cursor.remove();t.insert(ie.cursor);return X()};O=function(t){ie.cursor.remove();t.insertBefore(ie.cursor);return X()};s=function(){var t;t=ie.cursor.prev;while(t!==null&&t.type!=="indentStart"&&t.type!=="blockEnd"){t=t.prev}if(t.type==="blockEnd"){T(t.block,null);ie.redraw()}return X()};M=function(){var t,e;t=ie.cursor.prev.prev;while(t!==null&&!((e=t.type)==="newline"||e==="indentEnd"||e==="segmentStart")){t=t.prev}if(t===null){return}if(t.type==="indentEnd"){return O(t)}else{return A(t)}};I=function(){var t,e;t=ie.cursor.next.next;while(t!==null&&!((e=t.type)==="newline"||e==="indentEnd"||e==="segmentEnd")){t=t.next}if(t===null){return}if(t.type==="indentEnd"||t.type==="segmentEnd"){return O(t)}else{return A(t)}};ne=["input","keydown","keyup","keypress"];for(Z=0,te=ne.length;Z<te;Z++){h=ne[Z];this.hiddenInput.addEventListener(h,function(t){if(!ie.isEditingText()){return true}return W()})}this.hiddenInput.addEventListener("keydown",function(t){var e,n;if(!ie.isEditingText()){return true}switch(t.keyCode){case 13:if(ie.handwritten){return k()}else{H(null);ie.hiddenInput.blur();return ie.redraw()}break;case 8:if(ie.handwritten&&ie.hiddenInput.value.length===0){s();H(null);return ie.hiddenInput.blur()}break;case 9:if(ie.handwritten){e=ie.focus.start.prev.prev;while(e!==null&&e.type!=="blockEnd"&&e.type!=="blockStart"){e=e.prev}if(e.type==="blockStart"){}else if(e.prev.type==="indentEnd"){T(ie.focus.start.prev.block,e.prev.prev.insert(new S));A(ie.focus.start.prev.block.end);ie.redraw();t.preventDefault();return false}else{n=new m([],p);e.prev.insert(n.start);e.prev.insert(n.end);T(ie.focus.start.prev.block,n.start.insert(new S));A(ie.focus.start.prev.block.end);ie.redraw();t.preventDefault();return false}}break;case 38:H(null);ie.hiddenInput.blur();M();return ie.redraw();case 40:H(null);ie.hiddenInput.blur();I();return ie.redraw()}});this.hiddenInput.addEventListener("blur",function(t){console.log("blurred");if(t.target!==document.activeElement){return H(null)}});document.body.addEventListener("keydown",function(t){var e,n,i;if((n=t.target.tagName)==="INPUT"||n==="TEXTAREA"){return}switch(t.keyCode){case 13:if(!ie.isEditingText()){k()}break;case 38:if(ie.cursor!=null){M()}break;case 40:if(ie.cursor!=null){I()}break;case 8:if(ie.cursor!=null){s()}break;case 37:if(ie.cursor!=null){e=ie.cursor;while(e.type!=="socketEnd"){e=e.prev}H(e.socket)}}if((i=t.keyCode)===13||i===38||i===40||i===8){return ie.redraw()}});c=function(t,e){var n,i;n=e;i=null;while(n!==i){if(n.type==="blockStart"&&n.block.view.path.contains(t)){i=n.block.end}n=n.next}if(i!=null){return i.block}else{return null}};g=function(t){return c(t,ie.tree.start)};f=function(t){var e,n,i,s;s=ie.floatingBlocks;for(n=0,i=s.length;n<i;n++){e=s[n];if(c(t,e.block.start)!==null){return e.block}}return null};v=function(t){var e;e=ie.tree.start;while(e!==null){if(e.type==="socketStart"&&(e.next.type==="text"||e.next.type==="socketEnd")&&e.socket.view.bounds[e.socket.view.lineStart].contains(t)){return e.socket}e=e.next}return null};b=function(t){if(ie.lassoSegment!=null&&ie._lassoBounds.contains(t)){return ie.lassoSegment}else{return null}};x=function(t){var e,n,i,s;t=new draw.Point(t.x+P,t.y);s=ie.paletteBlocks;for(n=0,i=s.length;n<i;n++){e=s[n];if(c(t,e.start)!=null){return e}}return null};u=function(t){switch(false){case t.offsetX==null:return new draw.Point(t.offsetX-P,t.offsetY+ie.scrollOffset.y);case!t.layerX:return new draw.Point(t.layerX-P,t.layerY+ie.scrollOffset.y)
}};J.addEventListener("mousedown",function(t){var e,n,i,s,r,h,d,a,c,p,w,y,m,k,S,E,_,B,C,O;if(t.button!==0){return}ie.hiddenInput.blur();d=u(t);ie.selection=(k=(S=(E=(_=f(d))!=null?_:b(d))!=null?E:v(d))!=null?S:g(d))!=null?k:x(d);if(ie.selection==null){if(ie.lassoSegment!=null){n=false;B=ie.floatingBlocks;for(p=0,y=B.length;p<y;p++){i=B[p];if(i.block===ie.lassoSegment){n=true;break}}if(!n){ie.lassoSegment.remove()}ie.lassoSegment=null;ie.redraw()}return ie.lassoAnchor=d}else if(ie.selection.type==="socket"){H(ie.selection);ie.selection=null;return setTimeout(function(){F(d);W();return G=true},0)}else{c=false;s=ie.selection.start;while(s!==ie.selection.end){h=s.next;if(s.type==="cursor"){s.remove()}s=h}if(C=ie.selection,U.call(ie.paletteBlocks,C)>=0){d.add(P,0);c=true}a=ie.selection.view.bounds[ie.selection.view.lineStart];D=d.from(new draw.Point(a.x,a.y));if(c){ie.selection=ie.selection.clone()}O=ie.floatingBlocks;for(r=w=0,m=O.length;w<m;r=++w){i=O[r];if(i.block===ie.selection){ie.floatingBlocks.splice(r,1);break}}T(ie.selection,null);ie.selection.view.compute();ie.selection.view.draw(l);if(c){e=new draw.Point(a.x-P,a.y)}else{e=new draw.Point(a.x-ie.scrollOffset.x,a.y-ie.scrollOffset.y)}o.style.webkitTransform=o.style.mozTransform=o.style.transform="translate("+e.x+"px, "+e.y+"px)";return ie.redraw()}});J.addEventListener("mousemove",function(t){var e,n,i,s;if(ie.selection!=null){s=u(t);s.add(-ie.scrollOffset.x,-ie.scrollOffset.y);n=new draw.Point(-D.x+s.x,-D.y+s.y);s.translate(ie.scrollOffset);e=new draw.Point(-D.x+s.x,-D.y+s.y);i=a;a=ie.tree.find(function(t){var n;return!((n=typeof t.inSocket==="function"?t.inSocket():void 0)!=null?n:false)&&t.view.dropArea!=null&&t.view.dropArea.contains(e)});if(i!==a){ie.redraw()}if(a!=null){a.view.dropArea.fill(B,"#fff")}return o.style.webkitTransform=o.style.mozTransform=o.style.transform="translate("+n.x+"px, "+n.y+"px)"}});J.addEventListener("mouseup",function(t){var e,n,i;if(ie.selection!=null){i=u(t);e=new draw.Point(-D.x+i.x,-D.y+i.y);if(a!=null){switch(a.type){case"indent":n=a.end.prev;while(n.type==="segmentEnd"||n.type==="segmentStart"||n.type==="cursor"){n=n.prev}if(n.type==="newline"){T(ie.selection,a.start.next)}else{T(ie.selection,a.start.insert(new S))}break;case"block":T(ie.selection,a.end.insert(new S));break;case"socket":if(a.content()!=null){a.content().remove()}T(ie.selection,a.start);break;default:if(a===ie.tree){T(ie.selection,ie.tree.start);if(ie.selection.end.next!==ie.tree.end){ie.selection.end.insert(new S)}}}}else{if(i.x>0){ie.floatingBlocks.push({position:e,block:ie.selection})}}o.style.webkitTransform=o.style.mozTransform=o.style.transform="translate(0px, 0px)";l.clearRect(0,0,o.width,o.height);if(a!=null){n=ie.selection.end;while(n!==ie.tree.end&&n.type!=="newline"){n=n.next}if(n===ie.tree.end){O(n)}else{A(n)}}ie.selection=null;return ie.redraw()}});d=function(t,e){return new draw.Rectangle(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.abs(t.x-e.x),Math.abs(t.y-e.y))};J.addEventListener("mousemove",function(t){var e,n;if(ie.lassoAnchor!=null){e=u(t);e.add(-ie.scrollOffset.x,-ie.scrollOffset.y);n=d(new draw.Point(ie.lassoAnchor.x-ie.scrollOffset.x,ie.lassoAnchor.y-ie.scrollOffset.y),e);l.clearRect(0,0,o.width,o.height);l.strokeStyle="#00f";return l.strokeRect(n.x,n.y,n.width,n.height)}});J.addEventListener("mouseup",function(t){var e,n,i,s,r,h,a;if(ie.lassoAnchor!=null){r=u(t);h=d(ie.lassoAnchor,r);i=ie.tree.start;n=null;while(i!==ie.tree.end){if(i.type==="blockStart"&&i.block.view.path.intersects(h)){n=i;break}i=i.next}i=ie.tree.end;s=null;while(i!==ie.tree.start){if(i.type==="blockEnd"&&i.block.view.path.intersects(h)){s=i;break}i=i.prev}if(n!=null&&s!=null){a=[];i=n;while(i!==s){switch(i.type){case"blockStart":case"blockEnd":a.push(i.block.start);a.push(i.block.end);break;case"indentStart":case"indentEnd":a.push(i.indent.start);a.push(i.indent.end);break;case"segmentStart":case"segmentEnd":a.push(i.segment.start);a.push(i.segment.end)}i=i.next}i=ie.tree.start;while(i!==ie.tree.end){if(U.call(a,i)>=0){n=i;break}i=i.next}i=ie.tree.end;s=null;while(i!==ie.tree.start){if(U.call(a,i)>=0){s=i;break}i=i.prev}if(n.type==="indentStart"){e=0;while(e>0||i.type!=="blockStart"){if(n.type==="blockStart"){e-=1}else if(n.type==="blockEnd"){e+=1}n=n.prev}s=n.block.end}if(n.type==="indentStart"){e=0;while(e>0||i.type!=="blockEnd"){if(s.type==="blockEnd"){e-=1}else if(s.type==="blockStart"){e+=1}}n=s.block.start}ie.lassoSegment=new C([]);n.insertBefore(ie.lassoSegment.start);s.insert(ie.lassoSegment.end);ie.redraw()}l.clearRect(0,0,o.width,o.height);if(ie.lassoSegment!=null){A(ie.lassoSegment.end)}ie.lassoAnchor=null;return ie.redraw()}});W=function(){var t,e;ie.editedText.value=ie.hiddenInput.value;ie.redraw();e=ie.editedText.view.bounds[K].x+B.measureText(ie.hiddenInput.value.slice(0,ie.hiddenInput.selectionStart)).width;t=ie.editedText.view.bounds[K].x+B.measureText(ie.hiddenInput.value.slice(0,ie.hiddenInput.selectionEnd)).width;if(e===t){return B.strokeRect(e,ie.editedText.view.bounds[K].y,0,w)}else{B.fillStyle="rgba(0, 0, 256, 0.3";return B.fillRect(e,ie.editedText.view.bounds[K].y,t-e,w)}};H=function(t){var e,n;ie.focus=t;if(ie.onChange!=null){ie.onChange(new y(ie.focus,ie.focus))}if(ie.focus===null){return}K=ie.focus.view.lineStart;ie.handwritten=ie.focus.handwritten;if(!ie.focus.content()){ie.editedText=new V("");ie.focus.start.insert(ie.editedText)}else if(ie.focus.content().type==="text"){ie.editedText=ie.focus.content()}else{throw"Cannot edit occupied socket."}n=ie.focus.end;e=0;while(n.type!=="newline"&&n.type!=="indentEnd"&&n.type!=="segmentEnd"){n=n.next}if(n.type==="newline"){A(n)}else{O(n)}ie.hiddenInput.value=ie.editedText.value;return setTimeout(function(){return ie.hiddenInput.focus()},0)};Y=function(t){q=Math.round((t.x-ie.focus.view.bounds[K].x)/B.measureText(" ").width);return ie.hiddenInput.setSelectionRange(Math.min(j,q),Math.max(j,q))};F=function(t){j=q=Math.round((t.x-ie.focus.view.bounds[K].x)/B.measureText(" ").width);return ie.hiddenInput.setSelectionRange(j,q)};J.addEventListener("mousemove",function(t){var e;if(ie.isEditingText()&&G){e=u(t);Y(e);return W()}});J.addEventListener("mouseup",function(t){if(ie.isEditingText()){return G=false}});J.addEventListener("mousewheel",function(t){ie.clear();if(t.wheelDelta>0){if(ie.scrollOffset.y>=100){ie.scrollOffset.add(0,-100);B.translate(0,100)}else{B.translate(0,ie.scrollOffset.y);ie.scrollOffset.y=0}}else{ie.scrollOffset.add(0,100);B.translate(0,-100)}return ie.redraw()})}e.prototype.setValue=function(t){this.tree=coffee.parse(t).segment;return this.redraw()};e.prototype.getValue=function(){return this.tree.toString()};return e}();window.onload=function(){var t;window.editor=new a(document.getElementById("editor"),function(){var e,n,i,s;i=["for i in [1..10]\n  alert 'hello'","alert 'hello'","if a is b\n  alert 'hi'\nelse\n  alert 'bye'","a = b"];s=[];for(e=0,n=i.length;e<n;e++){t=i[e];s.push(coffee.parse(t).next.block)}return s}());editor.setValue("for i in [1..10]\n  if i % 2 is 0\n    alert i\n    alert 'bye'\n  else\n    alert 'fizz'\n  alert 'buzz'");editor.onChange=function(){return document.getElementById("out").value=editor.getValue()};return document.getElementById("out").addEventListener("input",function(){try{return editor.setValue(this.value)}catch(t){}})}}).call(this);