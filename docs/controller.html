<!DOCTYPE html>

<html>
<head>
  <title>controller.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="coffee.html">
                coffee.coffee
              </a>
            
              
              <a class="source" href="controller.html">
                controller.coffee
              </a>
            
              
              <a class="source" href="draw.html">
                draw.coffee
              </a>
            
              
              <a class="source" href="main.html">
                main.coffee
              </a>
            
              
              <a class="source" href="model.html">
                model.coffee
              </a>
            
              
              <a class="source" href="requirejs_config.html">
                requirejs_config.coffee
              </a>
            
              
              <a class="source" href="view.html">
                view.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>controller.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>ICE Editor Controller</p>
<p>Copyright (c) 2014 Anthony Bau.</p>
<p>MIT License</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
define [<span class="hljs-string">'ice-coffee'</span>, <span class="hljs-string">'ice-draw'</span>, <span class="hljs-string">'ice-model'</span>], <span class="hljs-function"><span class="hljs-params">(coffee, draw, model)</span> -&gt;</span>
  
  PADDING = <span class="hljs-number">5</span>
  INDENT_SPACES = <span class="hljs-number">2</span>
  INPUT_LINE_HEIGHT = <span class="hljs-number">15</span>
  PALETTE_MARGIN = <span class="hljs-number">10</span>
  PALETTE_WIDTH = <span class="hljs-number">300</span>
  MIN_DRAG_DISTANCE = <span class="hljs-number">5</span>
  FONT_SIZE = <span class="hljs-number">15</span>
  ANIMATION_FRAME_RATE = <span class="hljs-number">50</span> <span class="hljs-comment"># FPS</span>
  SCROLL_INTERVAL = <span class="hljs-number">50</span>

  <span class="hljs-built_in">exports</span> = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Convenience functions for interacting with the DOM,
used in the freeze/melt animations to find destination positions
of text elements. Hidden.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-title">findPosTop</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    top = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>
      top += obj.offsetTop
      <span class="hljs-keyword">unless</span> (obj = obj.offsetParent)? <span class="hljs-keyword">then</span> <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">return</span> top

  <span class="hljs-function"><span class="hljs-title">findPosLeft</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
    left = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>
      left += obj.offsetLeft
      <span class="hljs-keyword">unless</span> (obj = obj.offsetParent)? <span class="hljs-keyword">then</span> <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">return</span> left</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="animatedcolor">AnimatedColor</h2>
<p>Later on, we will need this simple class for color interpolation during freeze/melt animation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimatedColor</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@start</span>, <span class="hljs-property">@end</span>, <span class="hljs-property">@time</span>)</span> -&gt;</span>
      <span class="hljs-property">@currentRGB</span> = [
        parseInt(<span class="hljs-property">@start</span>[<span class="hljs-number">1.</span>.<span class="hljs-number">.3</span>], <span class="hljs-number">16</span>)
        parseInt(<span class="hljs-property">@start</span>[<span class="hljs-number">3.</span>.<span class="hljs-number">.5</span>], <span class="hljs-number">16</span>)
        parseInt(<span class="hljs-property">@start</span>[<span class="hljs-number">5.</span>.<span class="hljs-number">.7</span>], <span class="hljs-number">16</span>)
      ]

      <span class="hljs-property">@step</span> = [
        (parseInt(<span class="hljs-property">@end</span>[<span class="hljs-number">1.</span>.<span class="hljs-number">.3</span>], <span class="hljs-number">16</span>) - <span class="hljs-property">@currentRGB</span>[<span class="hljs-number">0</span>]) / <span class="hljs-property">@time</span>
        (parseInt(<span class="hljs-property">@end</span>[<span class="hljs-number">3.</span>.<span class="hljs-number">.5</span>], <span class="hljs-number">16</span>) - <span class="hljs-property">@currentRGB</span>[<span class="hljs-number">1</span>]) / <span class="hljs-property">@time</span>
        (parseInt(<span class="hljs-property">@end</span>[<span class="hljs-number">5.</span>.<span class="hljs-number">.7</span>], <span class="hljs-number">16</span>) - <span class="hljs-property">@currentRGB</span>[<span class="hljs-number">2</span>]) / <span class="hljs-property">@time</span>
      ]

    <span class="hljs-attribute">advance</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">for</span> item, i <span class="hljs-keyword">in</span> <span class="hljs-property">@currentRGB</span>
        <span class="hljs-property">@currentRGB</span>[i] += <span class="hljs-property">@step</span>[i]

      <span class="hljs-keyword">return</span> <span class="hljs-string">"rgb(<span class="hljs-subst">#{Math.round(<span class="hljs-property">@currentRGB</span>[<span class="hljs-number">0</span>])}</span>,<span class="hljs-subst">#{Math.round(<span class="hljs-property">@currentRGB</span>[<span class="hljs-number">1</span>])}</span>,<span class="hljs-subst">#{Math.round(<span class="hljs-property">@currentRGB</span>[<span class="hljs-number">2</span>])}</span>)"</span>

  <span class="hljs-built_in">exports</span>.IceEditorChangeEvent = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IceEditorChangeEvent</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@block</span>, <span class="hljs-property">@target</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h1 id="the-editor-class">The Editor class</h1>
<p>This class contains all the controller functions for ICE Editor.
Call:
  new Editor(DOMElement, palette)
to initialize an ICE editor in an element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-built_in">exports</span>.Editor = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Editor</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(wrapper, <span class="hljs-property">@paletteBlocks</span>)</span> -&gt;</span>
      <span class="hljs-property">@aceEl</span> = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>; <span class="hljs-property">@aceEl</span>.className = <span class="hljs-string">'ice_ace'</span>
      wrapper.appendChild <span class="hljs-property">@aceEl</span>
      
      <span class="hljs-property">@ace</span> = ace.edit <span class="hljs-property">@aceEl</span>
      <span class="hljs-property">@ace</span>.setTheme <span class="hljs-string">'ace/theme/chrome'</span>
      <span class="hljs-property">@ace</span>.getSession().setMode <span class="hljs-string">'ace/mode/coffee'</span>
      <span class="hljs-property">@ace</span>.getSession().setTabSize <span class="hljs-number">2</span>
      <span class="hljs-property">@ace</span>.setFontSize <span class="hljs-number">15</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>@ace.renderer.setShowGutter false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-property">@el</span> = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>; <span class="hljs-property">@el</span>.className = <span class="hljs-string">'ice_editor'</span>
      wrapper.appendChild <span class="hljs-property">@el</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="field-declaration">Field declaration</h2>
<p>(useful to have all in one place)</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>If we did not recieve palette blocks in the constructor, we have no palette.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@paletteBlocks</span> ?= []</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>We discard the blocks we are fed, preferring to clone them
to be as unintrusive as possible (also to get blocks unattached to any
token stream)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@paletteBlocks</span> = (paletteBlock.clone() <span class="hljs-keyword">for</span> paletteBlock <span class="hljs-keyword">in</span> <span class="hljs-property">@paletteBlocks</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>MODEL instances (program state)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@tree</span> = <span class="hljs-literal">null</span> <span class="hljs-comment"># The root tree</span>
      <span class="hljs-property">@floatingBlocks</span> = [] <span class="hljs-comment"># The other root blocks that are not attached to the root tree</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>TEXT INPUT interactive fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@focus</span> = <span class="hljs-literal">null</span> <span class="hljs-comment"># The focused empty socket, if such thing exists.</span>
      <span class="hljs-property">@editedText</span> = <span class="hljs-literal">null</span> <span class="hljs-comment"># The focused textToken, if such thing exists (associated with @focus).</span>
      <span class="hljs-property">@handwritten</span> = <span class="hljs-literal">false</span> <span class="hljs-comment"># Are we editing a handwritten line?</span>
      <span class="hljs-property">@hiddenInput</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@ephemeralOldFocusValue</span> = <span class="hljs-literal">null</span>

      <span class="hljs-property">@isEditingText</span> =<span class="hljs-function"> =&gt;</span> <span class="hljs-property">@focus</span>? <span class="hljs-keyword">and</span> <span class="hljs-property">@hiddenInput</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">document</span>.activeElement

      textInputAnchor = textInputHead = <span class="hljs-literal">null</span> <span class="hljs-comment"># The selection anchor and head in the input</span>

      textInputSelecting = <span class="hljs-literal">false</span>

      _editedInputLine = -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>NORMAL DRAG interactive fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@selection</span> = <span class="hljs-literal">null</span> <span class="hljs-comment"># The currently-dragged set of blocks</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>LASSO SELECT interactive fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@lassoSegment</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@_lassoBounds</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>CURSOR interactive fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@cursor</span> = <span class="hljs-keyword">new</span> model.CursorToken()</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>UNDO STACK</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@undoStack</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Scroll offset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@scrollOffset</span> = <span class="hljs-keyword">new</span> draw.Point <span class="hljs-number">0</span>, <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Touchscreen scrolling fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@touchScrollAnchor</span> = <span class="hljs-literal">null</span>

      offset = <span class="hljs-literal">null</span>
      highlight = <span class="hljs-literal">null</span>

      <span class="hljs-property">@currentlyAnimating</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="dom-setup">DOM SETUP</h2>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>The main canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@main</span> = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>; <span class="hljs-property">@main</span>.className = <span class="hljs-string">'canvas'</span>
      <span class="hljs-property">@main</span>.height = <span class="hljs-property">@el</span>.offsetHeight
      <span class="hljs-property">@main</span>.width = <span class="hljs-property">@el</span>.offsetWidth - PALETTE_WIDTH</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>The palette canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@palette</span> = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>; <span class="hljs-property">@palette</span>.className = <span class="hljs-string">'palette'</span>
      <span class="hljs-property">@palette</span>.height = <span class="hljs-property">@el</span>.offsetHeight
      <span class="hljs-property">@palette</span>.width = PALETTE_WIDTH</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>The drag canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      drag = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>; drag.className = <span class="hljs-string">'drag'</span>
      drag.style.opacity = <span class="hljs-number">0.85</span>
      drag.height = <span class="hljs-property">@el</span>.offsetHeight
      drag.width = <span class="hljs-property">@el</span>.offsetWidth - PALETTE_WIDTH</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>The hidden input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@hiddenInput</span> = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'input'</span>; <span class="hljs-property">@hiddenInput</span>.className = <span class="hljs-string">'hidden_input'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The mouse tracking div</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      track = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>; track.className = <span class="hljs-string">'trackArea'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Append the children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> [<span class="hljs-property">@main</span>, <span class="hljs-property">@palette</span>, drag, track, <span class="hljs-property">@hiddenInput</span>]
        <span class="hljs-property">@el</span>.appendChild child</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Get the contexts from each canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@mainCtx</span> = <span class="hljs-property">@main</span>.getContext <span class="hljs-string">'2d'</span>
      <span class="hljs-property">@dragCtx</span> = drag.getContext <span class="hljs-string">'2d'</span>
      <span class="hljs-property">@paletteCtx</span> = <span class="hljs-property">@palette</span>.getContext <span class="hljs-string">'2d'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>The main context will be used for draw.js’s text measurements (this is a bit of a hack)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      draw._setCTX <span class="hljs-property">@mainCtx</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="convenience-functions">Convenience Functions</h2>
<p>General-purpose methods that call the view (rendering functions)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      
      <span class="hljs-property">@clear</span> =<span class="hljs-function"> =&gt;</span>
        <span class="hljs-property">@mainCtx</span>.clearRect <span class="hljs-property">@scrollOffset</span>.x, <span class="hljs-property">@scrollOffset</span>.y, <span class="hljs-property">@main</span>.width, <span class="hljs-property">@main</span>.height</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="redraw">Redraw</h2>
<p>redraw does three main things: redraws the root tree (@tree)
redraws any floating blocks (@floatingBlocks), and draws the bounding rectangle
of any lassoed segments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@redraw</span> =<span class="hljs-function"> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Clear the main canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@clear</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Compute the root tree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@tree</span>.view.compute()</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Draw it on the main context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@tree</span>.view.draw <span class="hljs-property">@mainCtx</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Alert the lasso segment, if it exists, to recompute its bounds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-property">@lassoSegment</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Get those compute bounds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@_lassoBounds</span> = <span class="hljs-property">@lassoSegment</span>.view.getBounds()

          <span class="hljs-keyword">for</span> float <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span>
            <span class="hljs-keyword">if</span> <span class="hljs-property">@lassoSegment</span> <span class="hljs-keyword">is</span> float.block
              <span class="hljs-property">@_lassoBounds</span>.translate float.position</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Unless we’re already drawing it on the drag canvas, draw the lasso segment borders on the main canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">unless</span> <span class="hljs-property">@lassoSegment</span> <span class="hljs-keyword">is</span> <span class="hljs-property">@selection</span>
            <span class="hljs-property">@_lassoBounds</span>.stroke <span class="hljs-property">@mainCtx</span>, <span class="hljs-string">'#000'</span>
            <span class="hljs-property">@_lassoBounds</span>.fill <span class="hljs-property">@mainCtx</span>, <span class="hljs-string">'rgba(0, 0, 256, 0.3)'</span>

        <span class="hljs-keyword">for</span> float <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span>
          view = float.block.view</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Recompute this floating block’s coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          view.compute()
          view.translate float.position</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Draw it on the main context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          view.draw <span class="hljs-property">@mainCtx</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="attemptreparse">attemptReparse</h2>
<p>This will be triggered by most cursor operations. It finds all handwritten blocks that do not contain the cursor,
and attempts to replace them with the true-blockified representation of them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@attemptReparse</span> =<span class="hljs-function"> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Set up our linked-list parsing state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = <span class="hljs-property">@tree</span>.start; stack = []</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>This will ultimately contain a list of blocks not to parse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        excludes = []</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>This will ultimately contain all non-reparsed handwritten lines.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        reparseQueue = []

        <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>.end
          <span class="hljs-keyword">switch</span> head.type
            <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">then</span> stack.push head.block
            <span class="hljs-keyword">when</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">then</span> stack.push head.indent
            <span class="hljs-keyword">when</span> <span class="hljs-string">'socketStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If we have just encountered the socket associated with a 
handwritten block, push that handwritten block to the list of things that we may need
to reparse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> head.socket.handwritten <span class="hljs-keyword">and</span> stack[stack.length - <span class="hljs-number">1</span>].type <span class="hljs-keyword">is</span> <span class="hljs-string">'block'</span> <span class="hljs-keyword">and</span> head.socket <span class="hljs-keyword">isnt</span> <span class="hljs-property">@focus</span>
                reparseQueue.push stack[stack.length - <span class="hljs-number">1</span>]

              stack.push head.socket
            <span class="hljs-keyword">when</span> <span class="hljs-string">'cursor'</span>
              excludes.push element <span class="hljs-keyword">for</span> element <span class="hljs-keyword">in</span> stack
            <span class="hljs-keyword">when</span> <span class="hljs-string">'blockEnd'</span>, <span class="hljs-string">'socketEnd'</span>, <span class="hljs-string">'indentEnd'</span> <span class="hljs-keyword">then</span> stack.pop()

          head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>We have now assembled all the blocks that contain the cursor (at some level),
and also all the handwritten blocks. We will reparse all the handwritten blocks
that do not contain the cursor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">for</span> handwrittenBlock <span class="hljs-keyword">in</span> reparseQueue
          <span class="hljs-keyword">unless</span> handwrittenBlock <span class="hljs-keyword">in</span> excludes</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>To replace a block, we record its parent,
splice it out, and splice the replacement in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">try</span>
              parent = handwrittenBlock.start.prev
              newBlock = (coffee.parse handwrittenBlock.toString()).segment</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Unfortunately moveTo handles whitepsace for us,
which we do not want to do, so we must splice the block out ourselves.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              handwrittenBlock.start.prev.append handwrittenBlock.end.next

              handwrittenBlock.start.prev = <span class="hljs-literal">null</span>; handwrittenBlock.end.next = <span class="hljs-literal">null</span>
              
              newBlock.moveTo parent</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Elminate gratuitous Segment wrapper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              newBlock.remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>We have done some modifications, so we must redraw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@redraw</span>()

      <span class="hljs-function"><span class="hljs-title">moveBlockTo</span> = <span class="hljs-params">(block, target)</span> =&gt;</span>
        parent = block.start.prev
        <span class="hljs-keyword">while</span> parent? <span class="hljs-keyword">and</span> (parent.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">or</span> (parent.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">and</span> parent.segment <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>) <span class="hljs-keyword">or</span> parent.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span>) <span class="hljs-keyword">then</span> parent = parent.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Check to see if this is a floating block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> float <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span>
          <span class="hljs-keyword">if</span> block <span class="hljs-keyword">is</span> float.block
            <span class="hljs-property">@undoStack</span>.push
              <span class="hljs-attribute">type</span>: <span class="hljs-string">'floatingBlockMove'</span>
              <span class="hljs-attribute">block</span>: block
              <span class="hljs-attribute">position</span>: float.position

          block.moveTo target
          <span class="hljs-keyword">if</span> <span class="hljs-property">@onChange</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@onChange</span> <span class="hljs-keyword">new</span> IceEditorChangeEvent block, target

          <span class="hljs-keyword">return</span>
        
        <span class="hljs-property">@undoStack</span>.push
          <span class="hljs-attribute">type</span>: <span class="hljs-string">'blockMove'</span>
          <span class="hljs-attribute">block</span>: block
          <span class="hljs-attribute">target</span>: <span class="hljs-keyword">if</span> parent? <span class="hljs-keyword">then</span> (<span class="hljs-keyword">switch</span> parent.type
            <span class="hljs-keyword">when</span> <span class="hljs-string">'indentStart'</span>, <span class="hljs-string">'indentEnd'</span> <span class="hljs-keyword">then</span> parent.indent
            <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span>, <span class="hljs-string">'blockEnd'</span> <span class="hljs-keyword">then</span> parent.block
            <span class="hljs-keyword">when</span> <span class="hljs-string">'socketStart'</span>, <span class="hljs-string">'socketEnd'</span> <span class="hljs-keyword">then</span> parent.socket
            <span class="hljs-keyword">when</span> <span class="hljs-string">'segmentStart'</span>, <span class="hljs-string">'segmentEnd'</span> <span class="hljs-keyword">then</span> parent.segment
            <span class="hljs-keyword">else</span> parent) <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
        
        block.moveTo target
        <span class="hljs-keyword">if</span> <span class="hljs-property">@onChange</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@onChange</span> <span class="hljs-keyword">new</span> IceEditorChangeEvent block, target

      <span class="hljs-property">@undo</span> =<span class="hljs-function"> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>If the undo stack is empty, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">unless</span> <span class="hljs-property">@undoStack</span>.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Otherwise, pop from the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        operation = lastOperation = <span class="hljs-property">@undoStack</span>.pop()
        
        <span class="hljs-keyword">if</span> operation.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockMove'</span>
          <span class="hljs-keyword">for</span> float, i <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span>
            <span class="hljs-keyword">if</span> operation.block <span class="hljs-keyword">is</span> float.block
              <span class="hljs-property">@floatingBlocks</span>.splice i, <span class="hljs-number">1</span>

          <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># (this is for a wanted do-while syntax)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>If we have reached the end of the stack (this will rarely occur),
give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">unless</span> operation? <span class="hljs-keyword">then</span> <span class="hljs-keyword">break</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Simulate dropping the block into its target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> operation.target? <span class="hljs-keyword">then</span> <span class="hljs-keyword">switch</span> operation.target.type
              <span class="hljs-keyword">when</span> <span class="hljs-string">'indent'</span>
                head = operation.target.end.prev
                <span class="hljs-keyword">while</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentEnd'</span> <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span> <span class="hljs-keyword">then</span> head = head.prev

                <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>There’s already a newline here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  operation.block.moveTo operation.target.start.next
                <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>An insert drop signifies that we want to drop the block at the start of the indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  operation.block.moveTo operation.target.start.insert <span class="hljs-keyword">new</span> model.NewlineToken()

              <span class="hljs-keyword">when</span> <span class="hljs-string">'block'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>A block drop signifies that we want to drop the block after (the end of) the block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                operation.block.moveTo operation.target.end.insert <span class="hljs-keyword">new</span> model.NewlineToken()

              <span class="hljs-keyword">when</span> <span class="hljs-string">'socket'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Remove any previously occupying block or text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> operation.target.content()? <span class="hljs-keyword">then</span> operation.target.content().remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Insert</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                operation.block.moveTo operation.target.start
              
              <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> operation.target <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>We can also drop on the root tree (insert at the start of the program)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  operation.block.moveTo <span class="hljs-property">@tree</span>.start</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Don’t insert a newline if it would create an empty line at the end of the file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  <span class="hljs-keyword">unless</span> operation.block.end.next <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.end
                    operation.block.end.insert <span class="hljs-keyword">new</span> model.NewlineToken()
            <span class="hljs-keyword">else</span>
              operation.block.moveTo operation.target</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>We are done if we have actually reversed a block move,
or if we are in a different operation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> operation.type <span class="hljs-keyword">is</span> <span class="hljs-string">'floatingBlockMove'</span>
              operation.block.moveTo <span class="hljs-literal">null</span>

              <span class="hljs-property">@floatingBlocks</span>.push
                <span class="hljs-attribute">position</span>: operation.position
                <span class="hljs-attribute">block</span>: operation.block

            <span class="hljs-keyword">if</span> operation.target? <span class="hljs-keyword">or</span> operation.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'blockMove'</span> <span class="hljs-keyword">or</span> operation.block <span class="hljs-keyword">isnt</span> lastOperation.block <span class="hljs-keyword">then</span> <span class="hljs-keyword">break</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Otherwise, advance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            operation = <span class="hljs-property">@undoStack</span>.pop()

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> operation.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketTextChange'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Change the text of the desired socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          operation.socket.content().value = operation.value

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> operation.type <span class="hljs-keyword">is</span> <span class="hljs-string">'floatingBlockMove'</span>
          <span class="hljs-keyword">for</span> float, i <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span>
            <span class="hljs-keyword">if</span> operation.block <span class="hljs-keyword">is</span> float.block
              <span class="hljs-property">@floatingBlocks</span>.splice i, <span class="hljs-number">1</span>

          operation.block.moveTo <span class="hljs-literal">null</span>

          <span class="hljs-property">@floatingBlocks</span>.push
            <span class="hljs-attribute">position</span>: operation.position
            <span class="hljs-attribute">block</span>: operation.block

        <span class="hljs-property">@redraw</span>()

        <span class="hljs-keyword">if</span> <span class="hljs-property">@onChange</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@onChange</span> <span class="hljs-keyword">new</span> IceEditorChangeEvent operation.block, operation.target</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>The redrawPalette function ought to be called only once in the current code structure.
If we want to scroll the palette later on, then this will be called to do so.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@redrawPalette</span> =<span class="hljs-function"> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>We need to keep track of the bottom edge of the last element,
so we know where to put the top of the next one (there will be a margin of PALETTE_MARGIN between them)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        lastBottomEdge = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> paletteBlock <span class="hljs-keyword">in</span> <span class="hljs-property">@paletteBlocks</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Compute the coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          paletteBlock.view.compute()</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Translate it into position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          paletteBlock.view.translate <span class="hljs-keyword">new</span> draw.Point <span class="hljs-number">0</span>, lastBottomEdge</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Increment the running height count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          lastBottomEdge = paletteBlock.view.bounds[paletteBlock.view.lineEnd].bottom() + PALETTE_MARGIN <span class="hljs-comment"># Add margin</span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Finish and draw the palette block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          paletteBlock.view.draw <span class="hljs-property">@paletteCtx</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>(call it right away)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@redrawPalette</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <h2 id="cursor-operations">Cursor operations</h2>
<p>Functions that manipulate the cursor. The cursor is a normal ICE editor model token
that is rendered specially in the View.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-function"><span class="hljs-title">insertHandwrittenBlock</span> = =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Create the new block and socket for a new handwritten line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        newBlock = <span class="hljs-keyword">new</span> model.Block []; newSocket = <span class="hljs-keyword">new</span> model.Socket []
        newSocket.handwritten = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Put the new socket into the new block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        newBlock.start.insert newSocket.start; newBlock.end.prev.insert newSocket.end</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Move it to where the cursor should be</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>.next.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@cursor</span>.next.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@cursor</span>.next.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentEnd'</span>
          <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>.next.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@cursor</span>.prev.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>
            moveBlockTo newBlock, <span class="hljs-property">@cursor</span>.prev
          <span class="hljs-keyword">else</span>
            moveBlockTo newBlock, <span class="hljs-property">@cursor</span>.prev.insert <span class="hljs-keyword">new</span> model.NewlineToken()

          <span class="hljs-property">@redraw</span>()
          setTextInputFocus newSocket

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>.prev.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@cursor</span>.prev <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.start

          moveBlockTo newBlock, <span class="hljs-property">@cursor</span>.prev

          newBlock.end.insert <span class="hljs-keyword">new</span> model.NewlineToken()

          <span class="hljs-property">@redraw</span>()
          setTextInputFocus newSocket

        scrollCursorIntoView()

      <span class="hljs-function"><span class="hljs-title">scrollCursorIntoView</span> = =&gt;</span>
        <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>If the cursor has scrolled out of view, scroll it back into view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>.view.point.y &lt; <span class="hljs-property">@scrollOffset</span>.y
          <span class="hljs-property">@mainCtx</span>.translate <span class="hljs-number">0</span>, <span class="hljs-property">@scrollOffset</span>.y - <span class="hljs-property">@cursor</span>.view.point.y
          <span class="hljs-property">@scrollOffset</span>.y = <span class="hljs-property">@cursor</span>.view.point.y

          <span class="hljs-property">@redraw</span>()
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>.view.point.y &gt; (<span class="hljs-property">@scrollOffset</span>.y + <span class="hljs-property">@main</span>.height)
          <span class="hljs-property">@mainCtx</span>.translate <span class="hljs-number">0</span>, (<span class="hljs-property">@scrollOffset</span>.y + <span class="hljs-property">@main</span>.height) - <span class="hljs-property">@cursor</span>.view.point.y
          <span class="hljs-property">@scrollOffset</span>.y = <span class="hljs-property">@cursor</span>.view.point.y - <span class="hljs-property">@main</span>.height

          <span class="hljs-property">@redraw</span>()

      <span class="hljs-function"><span class="hljs-title">moveCursorTo</span> = <span class="hljs-params">(token)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Splice out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@cursor</span>.remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Find the newline or end markup after the given token.
Special case: we can also focus the very start of the tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = token
        <span class="hljs-keyword">unless</span> head <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.start
          <span class="hljs-keyword">until</span> (<span class="hljs-keyword">not</span> head?) <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'newline'</span>, <span class="hljs-string">'indentEnd'</span>, <span class="hljs-string">'segmentEnd'</span>] <span class="hljs-keyword">then</span> head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>If there is no place to put the cursor, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">unless</span> head? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Splice in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">or</span> head <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.start
          head.insert <span class="hljs-property">@cursor</span>
        <span class="hljs-keyword">else</span>
          head.insertBefore <span class="hljs-property">@cursor</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>We have moved the cursor, so it might now be possible
to reparse some handwritten blocks. Try it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@attemptReparse</span>()

        scrollCursorIntoView()
      
      <span class="hljs-function"><span class="hljs-title">moveCursorBefore</span> = <span class="hljs-params">(token)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Splice out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@cursor</span>.remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Splice in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        token.insertBefore <span class="hljs-property">@cursor</span></pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>We have moved the cursor, so it might now be possible
to reparse some handwritten blocks. Try it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@attemptReparse</span>()

        scrollCursorIntoView()


      <span class="hljs-function"><span class="hljs-title">deleteFromCursor</span> = =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Seek the block that we want to delete (i.e. the block that ends first before the cursor, if such thing exists)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = <span class="hljs-property">@cursor</span>.prev
        <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'blockEnd'</span>
          head = head.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>If there is no block before the cursor, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>If there is a block before us, delete it and redraw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockEnd'</span>
          moveBlockTo head.block, <span class="hljs-literal">null</span>; <span class="hljs-property">@redraw</span>()

        <span class="hljs-built_in">console</span>.log head.type</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>If there is an indent before us and the indent is empty, delete it and redraw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>First, we must check to make sure that the indent is actually empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          nextVisibleElement = head.next
          <span class="hljs-keyword">while</span> nextVisibleElement.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'newline'</span>, <span class="hljs-string">'cursor'</span>, <span class="hljs-string">'segmentStart'</span>, <span class="hljs-string">'segmentEnd'</span>]
            nextVisibleElement = nextVisibleElement.next

          <span class="hljs-built_in">console</span>.log nextVisibleElement</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>If the indent is indeed empty, delete it.
Remember, though, that the cursor is currently inside this indent, so we need to move it out first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> nextVisibleElement <span class="hljs-keyword">is</span> head.indent.end
            moveCursorDown()
            head.prev.append head.indent.end.next
            <span class="hljs-property">@redraw</span>()

        scrollCursorIntoView()</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>TODO the following are known not to be able to navigate to the end of an indent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-title">moveCursorUp</span> = =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Seek newline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = <span class="hljs-property">@cursor</span>.prev.prev
        <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (head.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'newline'</span>, <span class="hljs-string">'indentEnd'</span>] <span class="hljs-keyword">or</span> head <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.start)
          head = head.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>If head is null, we are at the beginning of the file.
So, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span>
          moveCursorBefore head
        <span class="hljs-keyword">else</span>
          moveCursorTo head</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Make sure that we’re not inside a block only.
This requires finding the immediate parent of the cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = <span class="hljs-property">@cursor</span>; depth = <span class="hljs-number">0</span>
        <span class="hljs-keyword">until</span> (head.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'blockEnd'</span>, <span class="hljs-string">'indentEnd'</span>] <span class="hljs-keyword">or</span> head <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.end) <span class="hljs-keyword">and</span> depth <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
          <span class="hljs-keyword">switch</span> head.type
            <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span>, <span class="hljs-string">'indentStart'</span>, <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">then</span> depth += <span class="hljs-number">1</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'blockEnd'</span>, <span class="hljs-string">'indentEnd'</span>, <span class="hljs-string">'socketEnd'</span> <span class="hljs-keyword">then</span> depth -= <span class="hljs-number">1</span>
          head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>If we’re in a bad place, then move us further.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockEnd'</span> <span class="hljs-keyword">then</span> moveCursorUp()

      <span class="hljs-function"><span class="hljs-title">moveCursorDown</span> = =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Seek newline or newline-like character.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = <span class="hljs-property">@cursor</span>.next.next
        <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (head.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'newline'</span>, <span class="hljs-string">'indentEnd'</span>] <span class="hljs-keyword">or</span> head <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.end)
          head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>If head is null, we are at the end of the file.
So, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span> <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentEnd'</span>
          moveCursorBefore head
        <span class="hljs-keyword">else</span>
          moveCursorTo head</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Make sure that we’re not inside a block only.
This requires finding the immediate parent of the cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = <span class="hljs-property">@cursor</span>; depth = <span class="hljs-number">0</span>
        <span class="hljs-keyword">until</span> (head.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'blockEnd'</span>, <span class="hljs-string">'indentEnd'</span>] <span class="hljs-keyword">or</span> head <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.end) <span class="hljs-keyword">and</span> depth <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
          <span class="hljs-keyword">switch</span> head.type
            <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span>, <span class="hljs-string">'indentStart'</span>, <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">then</span> depth += <span class="hljs-number">1</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'blockEnd'</span>, <span class="hljs-string">'indentEnd'</span>, <span class="hljs-string">'socketEnd'</span> <span class="hljs-keyword">then</span> depth -= <span class="hljs-number">1</span>
          head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>If we’re in a bad place, then move us further.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockEnd'</span> <span class="hljs-keyword">then</span> moveCursorDown()</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <h2 id="hidden-input-events">Hidden Input events</h2>

            </div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>For normal text input, we use the “input”, “keydownhtml event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> eventName <span class="hljs-keyword">in</span> [<span class="hljs-string">'input'</span>, <span class="hljs-string">'keydown'</span>, <span class="hljs-string">'keyup'</span>, <span class="hljs-string">'keypress'</span>]
        <span class="hljs-property">@hiddenInput</span>.addEventListener eventName, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>If we haven’t focused anything, this input does nothing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">unless</span> <span class="hljs-property">@isEditingText</span>() <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

          redrawTextInput()</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>For keyboard shortcuts, we use the “keydown” html event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@hiddenInput</span>.addEventListener <span class="hljs-string">'keydown'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>If we’re not actually editing an input, this isn’t our responsibility,
so return immediately.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">unless</span> <span class="hljs-property">@isEditingText</span>() <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Otherwise, see if we want to make a keyboard shortcut.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">switch</span> event.keyCode
          <span class="hljs-keyword">when</span> <span class="hljs-number">13</span>
            <span class="hljs-keyword">if</span> <span class="hljs-property">@handwritten</span> <span class="hljs-keyword">then</span> insertHandwrittenBlock()
            <span class="hljs-keyword">else</span> setTextInputFocus <span class="hljs-literal">null</span>; <span class="hljs-property">@hiddenInput</span>.blur(); <span class="hljs-property">@redraw</span>()
          <span class="hljs-keyword">when</span> <span class="hljs-number">8</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@handwritten</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@hiddenInput</span>.value.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
            deleteFromCursor(); setTextInputFocus <span class="hljs-literal">null</span>; <span class="hljs-property">@hiddenInput</span>.blur()
          <span class="hljs-keyword">when</span> <span class="hljs-number">9</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@handwritten</span></pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Seek the block right before this handwritten block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = <span class="hljs-property">@focus</span>.start.prev.prev
            head = head.prev <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'blockEnd'</span> <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'blockStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>If we have found a wrapping (parent) block, then we can’t do an indent, so give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Otherwise, see if the last child of this block is an indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.prev.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Note that it is guaranteed that a handwritten block satisfies @focus.start.prev.block is (the wrapping block)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              moveBlockTo <span class="hljs-property">@focus</span>.start.prev.block, head.prev.prev.insert <span class="hljs-keyword">new</span> model.NewlineToken() <span class="hljs-comment"># Move the block we're editing into the indent</span></pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Move the cursor into its proper position (after this block)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              moveCursorTo <span class="hljs-property">@focus</span>.start.prev.block.end

              <span class="hljs-property">@redraw</span>()
              event.preventDefault(); <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>We have found a block we want to move into, but there’s no indent here, so create one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Create and insert a new indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              newIndent = <span class="hljs-keyword">new</span> model.Indent [], INDENT_SPACES
              head.prev.insert newIndent.start; head.prev.insert newIndent.end</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Move the block we’re editing into this new indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              moveBlockTo <span class="hljs-property">@focus</span>.start.prev.block, newIndent.start.insert <span class="hljs-keyword">new</span> model.NewlineToken()</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Move the cursor into its proper position (after this block)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              moveCursorTo <span class="hljs-property">@focus</span>.start.prev.block.end

              <span class="hljs-property">@redraw</span>()
              event.preventDefault(); <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
          <span class="hljs-keyword">when</span> <span class="hljs-number">38</span> <span class="hljs-keyword">then</span> setTextInputFocus <span class="hljs-literal">null</span>; <span class="hljs-property">@hiddenInput</span>.blur(); moveCursorUp(); <span class="hljs-property">@redraw</span>()
          <span class="hljs-keyword">when</span> <span class="hljs-number">40</span> <span class="hljs-keyword">then</span> setTextInputFocus <span class="hljs-literal">null</span>; <span class="hljs-property">@hiddenInput</span>.blur(); moveCursorDown(); <span class="hljs-property">@redraw</span>()
          <span class="hljs-keyword">when</span> <span class="hljs-number">37</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@hiddenInput</span>.selectionStart <span class="hljs-keyword">is</span> <span class="hljs-property">@hiddenInput</span>.selectionEnd <span class="hljs-keyword">and</span> <span class="hljs-property">@hiddenInput</span>.selectionStart <span class="hljs-keyword">is</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Pressing the left-arrow at the leftmost end of a socket brings us to the previous socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = <span class="hljs-property">@focus</span>.start
            <span class="hljs-keyword">until</span> <span class="hljs-keyword">not</span> head? <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketEnd'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (head.socket.content()?.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'block'</span>, <span class="hljs-string">'socket'</span>])
              head = head.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>If we have reached the beginning of the file, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">unless</span> head? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

            setTextInputFocus head.socket
          <span class="hljs-keyword">when</span> <span class="hljs-number">39</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@hiddenInput</span>.selectionStart <span class="hljs-keyword">is</span> <span class="hljs-property">@hiddenInput</span>.selectionEnd <span class="hljs-keyword">and</span> <span class="hljs-property">@hiddenInput</span>.selectionStart <span class="hljs-keyword">is</span> <span class="hljs-property">@hiddenInput</span>.value.length</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Pressing right left-arrow at the rightmost end of a socket brings us to the next socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = <span class="hljs-property">@focus</span>.end
            <span class="hljs-keyword">until</span> <span class="hljs-keyword">not</span> head? <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (head.socket.content()?.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'block'</span>, <span class="hljs-string">'socket'</span>])
              head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>If we have reached the end of the file, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">unless</span> head? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

            setTextInputFocus head.socket</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>When we blur the hidden input, also blur the canvas text focus</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@hiddenInput</span>.addEventListener <span class="hljs-string">'blur'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>If we have actually blurred (as opposed to simply unfocused the browser window)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> event.target <span class="hljs-keyword">isnt</span> <span class="hljs-built_in">document</span>.activeElement <span class="hljs-keyword">then</span> setTextInputFocus <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Bind keyboard shortcut events to the document</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-built_in">document</span>.body.addEventListener <span class="hljs-string">'keydown'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Keyboard shortcuts don’t apply if they were executed in a text input area</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> event.target.tagName <span class="hljs-keyword">in</span> [<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>] <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
        
        <span class="hljs-keyword">switch</span> event.keyCode
          <span class="hljs-keyword">when</span> <span class="hljs-number">13</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@isEditingText</span>() <span class="hljs-keyword">then</span> insertHandwrittenBlock()
          <span class="hljs-keyword">when</span> <span class="hljs-number">38</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>? <span class="hljs-keyword">then</span> moveCursorUp()
          <span class="hljs-keyword">when</span> <span class="hljs-number">40</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>? <span class="hljs-keyword">then</span> moveCursorDown()
          <span class="hljs-keyword">when</span> <span class="hljs-number">8</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>? <span class="hljs-keyword">then</span> deleteFromCursor()
          <span class="hljs-keyword">when</span> <span class="hljs-number">37</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>?
            head = <span class="hljs-property">@cursor</span>
            
            <span class="hljs-keyword">until</span> <span class="hljs-keyword">not</span> head? <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketEnd'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (head.socket.content()?.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'block'</span>, <span class="hljs-string">'socket'</span>])
              head = head.prev
            
            <span class="hljs-keyword">unless</span> head? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

            setTextInputFocus head.socket
          <span class="hljs-keyword">when</span> <span class="hljs-number">39</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@cursor</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Pressing the left-arrow at the rightmost end of a socket brings us to the next socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = <span class="hljs-property">@cursor</span>
            <span class="hljs-keyword">until</span> <span class="hljs-keyword">not</span> head? <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (head.socket.content()?.type <span class="hljs-keyword">in</span> [<span class="hljs-string">'block'</span>, <span class="hljs-string">'socket'</span>])
              head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>If we have reached the beginning of the file, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">unless</span> head? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

            setTextInputFocus head.socket</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>If we manipulated the root tree, redraw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> event.keyCode <span class="hljs-keyword">in</span> [<span class="hljs-number">13</span>, <span class="hljs-number">38</span>, <span class="hljs-number">40</span>, <span class="hljs-number">8</span>] <span class="hljs-keyword">then</span> <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>If we caught the keypress, prevent default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> event.keyCode <span class="hljs-keyword">in</span> [<span class="hljs-number">13</span>, <span class="hljs-number">38</span>, <span class="hljs-number">40</span>, <span class="hljs-number">8</span>, <span class="hljs-number">37</span>] <span class="hljs-keyword">then</span> event.preventDefault()</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Hit-testing functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-function"><span class="hljs-title">hitTest</span> = <span class="hljs-params">(point, root)</span> =&gt;</span>
        head = root; seek = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> seek
          <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">and</span> head.block.view.path.contains point
            seek = head.block.end
          head = head.next
        
        <span class="hljs-keyword">if</span> seek? <span class="hljs-keyword">then</span> seek.block <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

      <span class="hljs-function"><span class="hljs-title">hitTestRoot</span> = <span class="hljs-params">(point)</span> =&gt;</span> hitTest point, <span class="hljs-property">@tree</span>.start
      
      <span class="hljs-function"><span class="hljs-title">hitTestFloating</span> = <span class="hljs-params">(point)</span> =&gt;</span>
        <span class="hljs-keyword">for</span> float <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span> <span class="hljs-keyword">by</span> -<span class="hljs-number">1</span>
          <span class="hljs-keyword">if</span> hitTest(point, float.block.start) <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> float.block
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
      
      <span class="hljs-function"><span class="hljs-title">hitTestFocus</span> = <span class="hljs-params">(point)</span> =&gt;</span>
        head = <span class="hljs-property">@tree</span>.start
        <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
          <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span>
              (head.next.type <span class="hljs-keyword">is</span> <span class="hljs-string">'text'</span> <span class="hljs-keyword">or</span> head.next.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketEnd'</span>) <span class="hljs-keyword">and</span>
              head.socket.view.bounds[head.socket.view.lineStart].contains point
            <span class="hljs-keyword">return</span> head.socket
          head = head.next

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
      
      <span class="hljs-function"><span class="hljs-title">hitTestLasso</span> = <span class="hljs-params">(point)</span> =&gt;</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@lassoSegment</span>? <span class="hljs-keyword">and</span> <span class="hljs-property">@_lassoBounds</span>.contains point <span class="hljs-keyword">then</span> <span class="hljs-property">@lassoSegment</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

      <span class="hljs-function"><span class="hljs-title">hitTestPalette</span> = <span class="hljs-params">(point)</span> =&gt;</span>
        point = <span class="hljs-keyword">new</span> draw.Point point.x + PALETTE_WIDTH, point.y - <span class="hljs-property">@scrollOffset</span>.y
        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> <span class="hljs-property">@paletteBlocks</span>
          <span class="hljs-keyword">if</span> hitTest(point, block.start)? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> block
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <h2 id="the-mousedown-event">The mousedown event</h2>

            </div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <h3 id="getpointfromevent">getPointFromEvent</h3>
<p>This is a conveneince function, which will contain compatability layers for getting
the offset coordinates of a mouse click point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-function"><span class="hljs-title">getPointFromEvent</span> = <span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-keyword">switch</span>
          <span class="hljs-keyword">when</span> event.offsetX? <span class="hljs-keyword">then</span> <span class="hljs-keyword">new</span> draw.Point event.offsetX - PALETTE_WIDTH, event.offsetY + <span class="hljs-property">@scrollOffset</span>.y
          <span class="hljs-keyword">when</span> event.layerX <span class="hljs-keyword">then</span> <span class="hljs-keyword">new</span> draw.Point event.layerX - PALETTE_WIDTH, event.layerY + <span class="hljs-property">@scrollOffset</span>.y
      
      <span class="hljs-function"><span class="hljs-title">performNormalMouseDown</span> = <span class="hljs-params">(point, isTouchEvent)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>See what we picked up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@ephemeralSelection</span> = hitTestFloating(point) ?
          hitTestLasso(point) ?
          hitTestFocus(point) ?
          hitTestRoot(point) ?
          hitTestPalette(point)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@ephemeralSelection</span>?
          <span class="hljs-keyword">if</span> isTouchEvent
            <span class="hljs-property">@touchScrollAnchor</span> = point

          <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>If we haven’t clicked on any clickable element, then LASSO SELECT, indicated by (@lassoAnchor?)</p>

            </div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>If there is already a selection, remove it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-property">@lassoSegment</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>First, check to see if the block is floating</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              flag = <span class="hljs-literal">false</span>
              <span class="hljs-keyword">for</span> float <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span>
                <span class="hljs-keyword">if</span> float.block <span class="hljs-keyword">is</span> <span class="hljs-property">@lassoSegment</span>
                  flag = <span class="hljs-literal">true</span>
                  <span class="hljs-keyword">break</span></pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Don’t remove the segment if it’s floating, because it still needs to hold those blocks together</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">unless</span> flag
                <span class="hljs-property">@lassoSegment</span>.remove()

              <span class="hljs-property">@lassoSegment</span> = <span class="hljs-literal">null</span>
              <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Set the lasso anchor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@lassoAnchor</span> = point

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@ephemeralSelection</span>.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socket'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>If we have clicked on a socket, then TEXT INPUT, indicated by (@isEditingText())</p>

            </div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Set the text input up for editing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          setTextInputFocus <span class="hljs-property">@ephemeralSelection</span></pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Don’t actually drag anything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@ephemeralSelection</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>We must set a timeout for the following, because until
A render has passed, the hidden input is not actually focused.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          setTimeout (<span class="hljs-function">=&gt;</span>
            setTextInputAnchor point
            redrawTextInput()</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>While the mouse is down, we are trying to select text in the input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            textInputSelecting = <span class="hljs-literal">true</span>), <span class="hljs-number">0</span>

        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>If we have clicked on a block or segment, then NORMAL DRAG, indicated by (@ephemeralSelection?)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          
          <span class="hljs-keyword">if</span> <span class="hljs-property">@ephemeralSelection</span> <span class="hljs-keyword">in</span> <span class="hljs-property">@paletteBlocks</span>
            <span class="hljs-property">@ephemeralPoint</span> = <span class="hljs-keyword">new</span> draw.Point point.x - <span class="hljs-property">@scrollOffset</span>.x, point.y - <span class="hljs-property">@scrollOffset</span>.y
          <span class="hljs-keyword">else</span>
            <span class="hljs-property">@ephemeralPoint</span> = <span class="hljs-keyword">new</span> draw.Point point.x, point.y</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Move the cursor to the place we just clicked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          moveCursorTo <span class="hljs-property">@ephemeralSelection</span>.end
    
      track.addEventListener <span class="hljs-string">'mousedown'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Only capture left-click</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">unless</span> event.button <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Forcefully blur the hidden input if it is focused, removing
the focus from any sockets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@hiddenInput</span>.blur()

        performNormalMouseDown getPointFromEvent(event), <span class="hljs-literal">false</span>
      
      track.addEventListener <span class="hljs-string">'touchstart'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        event.preventDefault()

        <span class="hljs-property">@hiddenInput</span>.blur()</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Track events do not contain offsetX/layerX properties,
so we must set them manually.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        event.changedTouches[<span class="hljs-number">0</span>].offsetX = event.changedTouches[<span class="hljs-number">0</span>].clientX - findPosLeft(track)
        event.changedTouches[<span class="hljs-number">0</span>].offsetY = event.changedTouches[<span class="hljs-number">0</span>].clientY - findPosTop(track)

        <span class="hljs-built_in">console</span>.log event.changedTouches[<span class="hljs-number">0</span>].clientX, findPosLeft(track)
        <span class="hljs-built_in">console</span>.log event.changedTouches[<span class="hljs-number">0</span>].clientY, findPosTop(track)

        performNormalMouseDown getPointFromEvent(event.changedTouches[<span class="hljs-number">0</span>]), <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <h2 id="mouse-events-for-normal-drag">Mouse events for NORMAL DRAG</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>      
      <span class="hljs-function"><span class="hljs-title">performNormalMouseMove</span> = <span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@ephemeralSelection</span>?
          point = getPointFromEvent event
          
          <span class="hljs-keyword">if</span> point.from(<span class="hljs-property">@ephemeralPoint</span>).magnitude() &gt; MIN_DRAG_DISTANCE</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>Move the ephemeral selection into the selection position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@selection</span> = <span class="hljs-property">@ephemeralSelection</span>
            <span class="hljs-property">@ephemeralSelection</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Check to make sure that the selection doesn’t contain a cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = <span class="hljs-property">@selection</span>.start
            <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@selection</span>.end
              next_head = head.next
              <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span> <span class="hljs-keyword">then</span> head.remove() <span class="hljs-comment"># If there is, remove it</span>
              head = next_head</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>If we clicked something in the palette, we need to compute offset etc. with a point that has been computed
with offset to the palette.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-property">@selection</span> <span class="hljs-keyword">in</span> <span class="hljs-property">@paletteBlocks</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@ephemeralPoint</span>.add PALETTE_WIDTH, <span class="hljs-number">0</span>; selectionInPalette = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Compute the offset of the selection position from the mouse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rect = <span class="hljs-property">@selection</span>.view.bounds[<span class="hljs-property">@selection</span>.view.lineStart]
            offset = <span class="hljs-property">@ephemeralPoint</span>.from <span class="hljs-keyword">new</span> draw.Point rect.x, rect.y</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>If we have clicked something in the palette, the clone first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> selectionInPalette <span class="hljs-keyword">then</span> <span class="hljs-property">@selection</span> = <span class="hljs-property">@selection</span>.clone()</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Move it to nowhere</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            moveBlockTo <span class="hljs-property">@selection</span>, <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>If we have clicked something floating, then delete it from the list of floating blocks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> float, i <span class="hljs-keyword">in</span> <span class="hljs-property">@floatingBlocks</span>
              <span class="hljs-keyword">if</span> float.block <span class="hljs-keyword">is</span> <span class="hljs-property">@selection</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@floatingBlocks</span>.splice i, <span class="hljs-number">1</span>; <span class="hljs-keyword">break</span></pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Draw it in the drag canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@selection</span>.view.compute()
            <span class="hljs-property">@selection</span>.view.draw <span class="hljs-property">@dragCtx</span></pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>CSS-transform the drag canvas to where it ought to be</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> selectionInPalette</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>If we picked up from the palette, then rect.x is actually relative to the palette</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              fixedDest = <span class="hljs-keyword">new</span> draw.Point rect.x - PALETTE_WIDTH, rect.y
            <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Otherwise, do as we would with mousemove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              fixedDest = <span class="hljs-keyword">new</span> draw.Point rect.x - <span class="hljs-property">@scrollOffset</span>.x, rect.y - <span class="hljs-property">@scrollOffset</span>.y

            drag.style.webkitTransform =
              drag.style.mozTransform =
              drag.style.transform = <span class="hljs-string">"translate(<span class="hljs-subst">#{fixedDest.x}</span>px, <span class="hljs-subst">#{fixedDest.y}</span>px)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Redraw the main canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@redraw</span>()

        <span class="hljs-keyword">if</span> <span class="hljs-property">@selection</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Determine the position of the mouse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          point = getPointFromEvent event

          point.add -<span class="hljs-property">@scrollOffset</span>.x, -<span class="hljs-property">@scrollOffset</span>.y</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>First we find the highlighted area</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          fixedDest = <span class="hljs-keyword">new</span> draw.Point -offset.x + point.x, -offset.y + point.y <span class="hljs-comment"># Where do we position things exactly in relation to the canvas?</span>

          point.translate <span class="hljs-property">@scrollOffset</span>
          dest = <span class="hljs-keyword">new</span> draw.Point -offset.x + point.x, -offset.y + point.y <span class="hljs-comment"># Where do we position things as related to the way we draw the root tree?</span>

          old_highlight = highlight

          highlight = <span class="hljs-property">@tree</span>.find <span class="hljs-function"><span class="hljs-params">(block)</span> -&gt;</span>
            (<span class="hljs-keyword">not</span> (block.inSocket?() ? <span class="hljs-literal">false</span>)) <span class="hljs-keyword">and</span> block.view.dropArea? <span class="hljs-keyword">and</span> block.view.dropArea.contains dest</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>If highlight changed, redraw</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> old_highlight <span class="hljs-keyword">isnt</span> highlight <span class="hljs-keyword">then</span> <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Highlight the highlight</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> highlight? <span class="hljs-keyword">then</span> highlight.view.dropHighlightReigon.fill <span class="hljs-property">@mainCtx</span>, <span class="hljs-string">'#fff'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>CSS-transform the drag canvas to where it ought to be</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          drag.style.webkitTransform =
            drag.style.mozTransform =
            drag.style.transform = <span class="hljs-string">"translate(<span class="hljs-subst">#{fixedDest.x}</span>px, <span class="hljs-subst">#{fixedDest.y}</span>px)"</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@touchScrollAnchor</span>?
          <span class="hljs-property">@scrollOffset</span>.x = <span class="hljs-property">@touchScrollAnchor</span>.from(point).x</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Bind this mousemove function to mousemove. We need to add some
wrapper functions for touchmove, since multitouch works slightly differently
from mouse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      track.addEventListener <span class="hljs-string">'mousemove'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> -&gt;</span>
        performNormalMouseMove event

      track.addEventListener <span class="hljs-string">'touchmove'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Touchmove has a particularly inconvenient default (scrolling),
so we want to prevent this here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        event.preventDefault()

        <span class="hljs-keyword">unless</span> event.changedTouches.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

        event.changedTouches[<span class="hljs-number">0</span>].offsetX = event.changedTouches[<span class="hljs-number">0</span>].clientX - findPosLeft(track)
        event.changedTouches[<span class="hljs-number">0</span>].offsetY = event.changedTouches[<span class="hljs-number">0</span>].clientY - findPosTop(track)

        performNormalMouseMove event.changedTouches[<span class="hljs-number">0</span>]

      
      <span class="hljs-function"><span class="hljs-title">performNormalMouseUp</span> = <span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@ephemeralSelection</span>?
          <span class="hljs-property">@ephemeralSelection</span> = <span class="hljs-literal">null</span>
          <span class="hljs-property">@ephemeralPoint</span> = <span class="hljs-literal">null</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@selection</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>Determine the position of the mouse and the place we want to render the block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          point = getPointFromEvent event
          dest = <span class="hljs-keyword">new</span> draw.Point -offset.x + point.x, -offset.y + point.y

          <span class="hljs-keyword">if</span> highlight?</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>Drop areas signify different things depending on the block that they belong to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">switch</span> highlight.type
              <span class="hljs-keyword">when</span> <span class="hljs-string">'indent'</span>
                head = highlight.end.prev
                <span class="hljs-keyword">while</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentEnd'</span> <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span> <span class="hljs-keyword">then</span> head = head.prev

                <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>There’s already a newline here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  moveBlockTo <span class="hljs-property">@selection</span>, highlight.start.next
                <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>An insert drop signifies that we want to drop the block at the start of the indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  moveBlockTo <span class="hljs-property">@selection</span>, highlight.start.insert <span class="hljs-keyword">new</span> model.NewlineToken()

              <span class="hljs-keyword">when</span> <span class="hljs-string">'block'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>A block drop signifies that we want to drop the block after (the end of) the block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                moveBlockTo <span class="hljs-property">@selection</span>, highlight.end.insert <span class="hljs-keyword">new</span> model.NewlineToken()

              <span class="hljs-keyword">when</span> <span class="hljs-string">'socket'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Remove any previously occupying block or text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> highlight.content()? <span class="hljs-keyword">then</span> highlight.content().remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Insert</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                moveBlockTo <span class="hljs-property">@selection</span>, highlight.start
              
              <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> highlight <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span></pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>We can also drop on the root tree (insert at the start of the program)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  moveBlockTo <span class="hljs-property">@selection</span>, <span class="hljs-property">@tree</span>.start</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Don’t insert a newline if it would create an empty line at the end of the file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  <span class="hljs-keyword">unless</span> <span class="hljs-property">@selection</span>.end.next <span class="hljs-keyword">is</span> <span class="hljs-property">@tree</span>.end
                    <span class="hljs-property">@selection</span>.end.insert <span class="hljs-keyword">new</span> model.NewlineToken()</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>In the special case that we have selected a single block
and dropped it into a socket, we need to check for parenthesis
wrapping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-property">@selection</span> <span class="hljs-keyword">is</span> <span class="hljs-property">@lassoSegment</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@lassoSegment</span>.start.next.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span>
              <span class="hljs-property">@lassoSegment</span>.start.next.block.checkParenWrap()

          <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>If we have dropped the block in nowhere, append it (and it’s floating position) to @floatingBlocks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> dest.x &gt; <span class="hljs-number">0</span>
              <span class="hljs-property">@floatingBlocks</span>.push
                <span class="hljs-attribute">position</span>: dest
                <span class="hljs-attribute">block</span>: <span class="hljs-property">@selection</span></pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>If we have dropped the block on the palette, then delete it.
This normally requires no operations, but if we have selected it as the lassoSegment,
we want to stop drawing its bounding box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@selection</span> <span class="hljs-keyword">is</span> <span class="hljs-property">@lassoSegment</span>
              <span class="hljs-property">@lassoSegment</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>CSS-transform the drag canvas back to the origin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          drag.style.webkitTransform =
            drag.style.mozTransform =
            drag.style.transform = <span class="hljs-string">"translate(0px, 0px)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Clear the drag canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@dragCtx</span>.clearRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, drag.width, drag.height</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>If we inserted into root, move the cursor to the end of the selection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> highlight?</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Seek the next newline after the end of this block,
which is where we’ll want to move the cursor
(so that it looks like we put it directly after the block).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            moveCursorTo <span class="hljs-property">@selection</span>.end</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Signify that we are no longer in a NORMAL DRAG</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@selection</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Redraw after the selection has been set to null, since @redraw is sensitive to what things are being dragged.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@redraw</span>()

      track.addEventListener <span class="hljs-string">'mouseup'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        performNormalMouseUp event

      track.addEventListener <span class="hljs-string">'touchend'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        event.preventDefault()

        <span class="hljs-property">@touchScrollAnchor</span> = <span class="hljs-literal">null</span>

        event.changedTouches[<span class="hljs-number">0</span>].offsetX = event.changedTouches[<span class="hljs-number">0</span>].clientX - findPosLeft(track)
        event.changedTouches[<span class="hljs-number">0</span>].offsetY = event.changedTouches[<span class="hljs-number">0</span>].clientY - findPosTop(track)

        performNormalMouseUp event.changedTouches[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <h2 id="mouse-events-for-lasso-select">Mouse events for LASSO SELECT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-function"><span class="hljs-title">getRectFromPoints</span> = <span class="hljs-params">(a, b)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> draw.Rectangle(</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Take the minimum coordinates for the top-left corner</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          Math.min(a.x, b.x), <span class="hljs-comment">#x</span>
          Math.min(a.y, b.y), <span class="hljs-comment">#y</span></pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Distances are always positive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          Math.abs(a.x - b.x), <span class="hljs-comment">#width</span>
          Math.abs(a.y - b.y)) <span class="hljs-comment">#height</span>

      track.addEventListener <span class="hljs-string">'mousemove'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@lassoAnchor</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>Determine the position of the mouse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          point = getPointFromEvent event
          point.add -<span class="hljs-property">@scrollOffset</span>.x, -<span class="hljs-property">@scrollOffset</span>.y <span class="hljs-comment"># (position fixed, as in relation to the drag canvas, on which we will draw it)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>Get the rectangle we want to draw</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          rect = getRectFromPoints (<span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@lassoAnchor</span>.x - <span class="hljs-property">@scrollOffset</span>.x, <span class="hljs-property">@lassoAnchor</span>.y - <span class="hljs-property">@scrollOffset</span>.y), point</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Clear and redraw the lasso on the drag canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@dragCtx</span>.clearRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, drag.width, drag.height
          <span class="hljs-property">@dragCtx</span>.strokeStyle = <span class="hljs-string">'#00f'</span>
          <span class="hljs-property">@dragCtx</span>.strokeRect rect.x, rect.y, rect.width, rect.height

      track.addEventListener <span class="hljs-string">'mouseup'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@lassoAnchor</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Determine the position of the mouse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          point = getPointFromEvent event</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>Get the rectangle we want to test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          rect = getRectFromPoints <span class="hljs-property">@lassoAnchor</span>, point</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>First pass for lasso segment detection: get intersecting blocks.</p>

            </div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>Find the first matching block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          head = <span class="hljs-property">@tree</span>.start
          firstLassoed = <span class="hljs-literal">null</span>
          <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>.end</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>A block matches if it intersects the lasso rectangle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">and</span> head.block.view.path.intersects rect
              firstLassoed = head
              <span class="hljs-keyword">break</span>
            head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Find the last matching block analagously</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          head = <span class="hljs-property">@tree</span>.end
          lastLassoed = <span class="hljs-literal">null</span>
          <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>.start
            <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockEnd'</span> <span class="hljs-keyword">and</span> head.block.view.path.intersects rect
              lastLassoed = head
              <span class="hljs-keyword">break</span>
            head = head.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Unless we have selected anything, give up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> firstLassoed? <span class="hljs-keyword">and</span> lastLassoed?</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Second pass for lasso segment detection: validate the selection and record wrapping blocks as necessary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            
            tokensToInclude = []

            head = firstLassoed
            <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> lastLassoed</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>For each bit of markup, make sure to include both its start token and end token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">switch</span> head.type
                <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span>, <span class="hljs-string">'blockEnd'</span>
                  tokensToInclude.push head.block.start
                  tokensToInclude.push head.block.end
                <span class="hljs-keyword">when</span> <span class="hljs-string">'indentStart'</span>, <span class="hljs-string">'indentEnd'</span>
                  tokensToInclude.push head.indent.start
                  tokensToInclude.push head.indent.end
                <span class="hljs-keyword">when</span> <span class="hljs-string">'segmentStart'</span>, <span class="hljs-string">'segmentEnd'</span>
                  tokensToInclude.push head.segment.start
                  tokensToInclude.push head.segment.end
              head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>Third pass for lasso segment detection: include all necessary tokens demanded by validation</p>

            </div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Find the first block in tokensToInclude</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = <span class="hljs-property">@tree</span>.start
            <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>.end
              <span class="hljs-keyword">if</span> head <span class="hljs-keyword">in</span> tokensToInclude
                firstLassoed = head; <span class="hljs-keyword">break</span>
              head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>Find the last matching block analagously</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = <span class="hljs-property">@tree</span>.end
            lastLassoed = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>.start
              <span class="hljs-keyword">if</span> head <span class="hljs-keyword">in</span> tokensToInclude
                lastLassoed = head; <span class="hljs-keyword">break</span>
              head = head.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>Fourth pass for lasso segment detection: make sure that we have selected the wrapping block for any indents</p>
<p>Note that this will only occur when we have inserted the indentStart at the beginning or indentEnd at the end
in the second and third pass. This in turn will occur ONLY when the user has selected multiple blocks belonging to the
same wrapping block, and nothing outside it (i.e. the wrapping block of the indent wraps the entire selection).</p>
<p>So it suffices to select that entire wrapping block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> firstLassoed.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>Seek the wrapping block for this indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              depth = <span class="hljs-number">0</span>
              <span class="hljs-keyword">while</span> depth &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-comment"># We need to find the wrapping block, so we keep track of block depth</span></pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>Increment block depth</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> firstLassoed.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">then</span> depth -= <span class="hljs-number">1</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> firstLassoed.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockEnd'</span> <span class="hljs-keyword">then</span> depth += <span class="hljs-number">1</span>

                firstLassoed = firstLassoed.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Set lastLassoed in accordance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              lastLassoed = firstLassoed.block.end

            <span class="hljs-keyword">if</span> firstLassoed.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Seek the wrapping block for this indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              depth = <span class="hljs-number">0</span>
              <span class="hljs-keyword">while</span> depth &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'blockEnd'</span> <span class="hljs-comment"># We need to find the wrapping block, so we keep track of block depth</span></pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Increment block depth</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> lastLassoed.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockEnd'</span> <span class="hljs-keyword">then</span> depth -= <span class="hljs-number">1</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> lastLassoed.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">then</span> depth += <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Set firstLassoed in accordance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              firstLassoed = lastLassoed.block.start</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>Now, insert the actual lasso segment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@lassoSegment</span> = <span class="hljs-keyword">new</span> model.Segment []

            firstLassoed.insertBefore <span class="hljs-property">@lassoSegment</span>.start
            lastLassoed.insert <span class="hljs-property">@lassoSegment</span>.end

            <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Clear the drag canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@dragCtx</span>.clearRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, drag.width, drag.height</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>If we inserted a lasso segment, move the cursor appropriately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-property">@lassoSegment</span>? <span class="hljs-keyword">then</span> moveCursorTo <span class="hljs-property">@lassoSegment</span>.end</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>Flag that we are no longer in a LASSO SELECT.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@lassoAnchor</span> = <span class="hljs-literal">null</span>

          <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <h2 id="utility-functions-for-text-input">Utility functions for TEXT INPUT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-function"><span class="hljs-title">redrawTextInput</span> = =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>Change the edited text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@editedText</span>.value = <span class="hljs-property">@hiddenInput</span>.value</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>Redraw the background (main canvas)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>Determine the position (coordinate-wise) of the typing cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        start = <span class="hljs-property">@editedText</span>.view.bounds[_editedInputLine].x +
          <span class="hljs-property">@mainCtx</span>.measureText(<span class="hljs-property">@hiddenInput</span>.value[...<span class="hljs-property">@hiddenInput</span>.selectionStart]).width

        end = <span class="hljs-property">@editedText</span>.view.bounds[_editedInputLine].x +
          <span class="hljs-property">@mainCtx</span>.measureText(<span class="hljs-property">@hiddenInput</span>.value[...<span class="hljs-property">@hiddenInput</span>.selectionEnd]).width</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>Draw the typing cursor itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> start <span class="hljs-keyword">is</span> end</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>This is just a line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@mainCtx</span>.strokeRect start, <span class="hljs-property">@editedText</span>.view.bounds[_editedInputLine].y, <span class="hljs-number">0</span>, INPUT_LINE_HEIGHT
        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>This is the translucent rectangle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@mainCtx</span>.fillStyle = <span class="hljs-string">'rgba(0, 0, 256, 0.3'</span>
          <span class="hljs-property">@mainCtx</span>.fillRect start, <span class="hljs-property">@editedText</span>.view.bounds[_editedInputLine].y, end - start, INPUT_LINE_HEIGHT

      <span class="hljs-function"><span class="hljs-title">setTextInputFocus</span> = <span class="hljs-params">(focus)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>Deal with the previous focus</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-property">@focus</span>?
          <span class="hljs-keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>Attempt to reparse what’s in the indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            newParse = coffee.parse(<span class="hljs-property">@focus</span>.toString()).next
            <span class="hljs-keyword">if</span> newParse.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span>
              <span class="hljs-keyword">if</span> <span class="hljs-property">@focus</span>.handwritten
                newParse.block.moveTo <span class="hljs-property">@focus</span>.start.prev.block.start.prev
                <span class="hljs-property">@focus</span>.start.prev.block.moveTo <span class="hljs-literal">null</span>
              <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> <span class="hljs-property">@focus</span>.content()?.type <span class="hljs-keyword">is</span> <span class="hljs-string">'text'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@focus</span>.content().remove()
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@focus</span>.content()?.type <span class="hljs-keyword">is</span> <span class="hljs-string">'block'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@focus</span>.content().moveTo <span class="hljs-literal">null</span>

                newParse.block.moveTo <span class="hljs-property">@focus</span>.start</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>Fire the onchange handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-property">@onChange</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@onChange</span> <span class="hljs-keyword">new</span> IceEditorChangeEvent <span class="hljs-property">@focus</span>, focus

          <span class="hljs-keyword">if</span> <span class="hljs-property">@ephemeralOldFocusValue</span> <span class="hljs-keyword">isnt</span> <span class="hljs-property">@focus</span>.toString()
            <span class="hljs-property">@undoStack</span>.push
              <span class="hljs-attribute">type</span>: <span class="hljs-string">'socketTextChange'</span>
              <span class="hljs-attribute">socket</span>: <span class="hljs-property">@focus</span>
              <span class="hljs-attribute">value</span>: <span class="hljs-property">@ephemeralOldFocusValue</span></pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>Literally set the focus</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@focus</span> = focus
        
        <span class="hljs-keyword">if</span> <span class="hljs-property">@focus</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@ephemeralOldFocusValue</span> = <span class="hljs-property">@focus</span>.toString()
        <span class="hljs-keyword">else</span> <span class="hljs-property">@ephemeralOldFocusValue</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>If we just removed the focus, then we are done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-property">@focus</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Record the line that the focus is on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _editedInputLine = <span class="hljs-property">@focus</span>.view.lineStart</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Flag whether we are editing handwritten</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@handwritten</span> = <span class="hljs-property">@focus</span>.handwritten
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@focus</span>.content()</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>If the socket is empty, put a text thing in, setting that to the edited text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@editedText</span> = <span class="hljs-keyword">new</span> model.TextToken <span class="hljs-string">''</span>
          <span class="hljs-property">@focus</span>.start.insert <span class="hljs-property">@editedText</span>
        
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@focus</span>.content().type <span class="hljs-keyword">is</span> <span class="hljs-string">'text'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>If the socket is not empty but contains only text, edit that text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@editedText</span> = <span class="hljs-property">@focus</span>.content()

        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>Otherwise, we have an error condition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Cannot edit occupied socket.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Find the wrapping block and move the cursor to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = <span class="hljs-property">@focus</span>.end; depth = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'indentEnd'</span> <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'segmentEnd'</span> <span class="hljs-keyword">then</span> head = head.next
        
        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">then</span> moveCursorTo head
        <span class="hljs-keyword">else</span> moveCursorBefore head</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>Set the contents of the hidden input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@hiddenInput</span>.value = <span class="hljs-property">@editedText</span>.value</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>Focus the hidden input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setTimeout (<span class="hljs-function">=&gt;</span> <span class="hljs-property">@hiddenInput</span>.focus()), <span class="hljs-number">0</span>

      <span class="hljs-function"><span class="hljs-title">setTextInputHead</span> = <span class="hljs-params">(point)</span> =&gt;</span>
        textInputHead = Math.round (point.x - <span class="hljs-property">@focus</span>.view.bounds[_editedInputLine].x) / <span class="hljs-property">@mainCtx</span>.measureText(<span class="hljs-string">' '</span>).width

        <span class="hljs-property">@hiddenInput</span>.setSelectionRange Math.min(textInputAnchor, textInputHead), Math.max(textInputAnchor, textInputHead)

      <span class="hljs-function"><span class="hljs-title">setTextInputAnchor</span> = <span class="hljs-params">(point)</span> =&gt;</span>
        textInputAnchor = textInputHead = Math.round (point.x - <span class="hljs-property">@focus</span>.view.bounds[_editedInputLine].x - PADDING) / <span class="hljs-property">@mainCtx</span>.measureText(<span class="hljs-string">' '</span>).width
        <span class="hljs-property">@hiddenInput</span>.setSelectionRange textInputAnchor, textInputHead</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <h2 id="mouse-events-for-text-input">Mouse events for TEXT INPUT</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      track.addEventListener <span class="hljs-string">'mousemove'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@isEditingText</span>() <span class="hljs-keyword">and</span> textInputSelecting</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>See where the mouse is</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          point = getPointFromEvent event</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>Set the input head</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          setTextInputHead point</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>Redraw</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          redrawTextInput()

      track.addEventListener <span class="hljs-string">'mouseup'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@isEditingText</span>()
          textInputSelecting = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <h2 id="mouse-events-for-scrolling">Mouse events for SCROLLING</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      track.addEventListener <span class="hljs-string">'mousewheel'</span>, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
        <span class="hljs-property">@clear</span>()

        <span class="hljs-keyword">if</span> event.wheelDelta &gt; <span class="hljs-number">0</span>
          <span class="hljs-keyword">if</span> <span class="hljs-property">@scrollOffset</span>.y &gt;= SCROLL_INTERVAL
            <span class="hljs-property">@scrollOffset</span>.add <span class="hljs-number">0</span>, -SCROLL_INTERVAL
            <span class="hljs-property">@mainCtx</span>.translate <span class="hljs-number">0</span>, SCROLL_INTERVAL
          <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>If we would go past the top of the file, just scroll to exactly the top of the file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@mainCtx</span>.translate <span class="hljs-number">0</span>, <span class="hljs-property">@scrollOffset</span>.y
            <span class="hljs-property">@scrollOffset</span>.y = <span class="hljs-number">0</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@scrollOffset</span>.add <span class="hljs-number">0</span>, SCROLL_INTERVAL
          <span class="hljs-property">@mainCtx</span>.translate <span class="hljs-number">0</span>, -SCROLL_INTERVAL

        <span class="hljs-property">@redraw</span>()

    <span class="hljs-attribute">setValue</span>: <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span>
      <span class="hljs-property">@tree</span> = coffee.parse(value).segment
      <span class="hljs-property">@redraw</span>()

    <span class="hljs-attribute">getValue</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@tree</span>.toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <h2 id="performmeltanimation">performMeltAnimation</h2>
<p>This will animate all the text elements from their current position to a position
that imitates plaintext.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">performMeltAnimation</span>:<span class="hljs-function"> -&gt;</span>

      <span class="hljs-keyword">if</span> <span class="hljs-property">@currentlyAnimating</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">else</span> <span class="hljs-property">@currentlyAnimating</span> = <span class="hljs-literal">true</span>

      <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>We need to find out some properties of dimensions
in the ace editor. So we will need to display the ace editor momentarily off-screen.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-property">@ace</span>.setValue <span class="hljs-property">@getValue</span>()
      <span class="hljs-property">@aceEl</span>.style.top = -<span class="hljs-number">9999</span>
      <span class="hljs-property">@aceEl</span>.style.left = -<span class="hljs-number">9999</span>
      <span class="hljs-property">@aceEl</span>.style.display = <span class="hljs-string">'block'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>We must wait for the Ace editor to render before we continue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      setTimeout (<span class="hljs-function">=&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>First, we will need to get all the text elements which we will be animating.
Simultaneously, we can ask text elements to compute their position as if they were plaintext. This will be the
animation destination. Along the way we will move the cursor around due to newlines and indents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        textElements = []
        translationVectors = []
        head = <span class="hljs-property">@tree</span>.start</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Set up the state which we will pass to </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state =
          <span class="hljs-attribute">x</span>: <span class="hljs-property">@ace</span>.container.getBoundingClientRect().left - findPosLeft(<span class="hljs-property">@aceEl</span>) + <span class="hljs-property">@ace</span>.renderer.$gutterLayer.gutterWidth
          <span class="hljs-attribute">y</span>: <span class="hljs-property">@ace</span>.container.getBoundingClientRect().top - findPosTop(<span class="hljs-property">@aceEl</span>)
          <span class="hljs-attribute">indent</span>: <span class="hljs-number">0</span>
          <span class="hljs-attribute">lineHeight</span>: <span class="hljs-property">@ace</span>.renderer.layerConfig.lineHeight
          <span class="hljs-attribute">leftEdge</span>: <span class="hljs-property">@ace</span>.container.getBoundingClientRect().left - findPosLeft(<span class="hljs-property">@aceEl</span>) + <span class="hljs-property">@ace</span>.renderer.$gutterLayer.gutterWidth

        <span class="hljs-built_in">console</span>.log <span class="hljs-property">@ace</span>.container.getBoundingClientRect(), <span class="hljs-property">@aceEl</span>.offsetLeft, <span class="hljs-property">@aceEl</span>.offsetTop
        <span class="hljs-built_in">console</span>.log <span class="hljs-property">@ace</span>.renderer.layerConfig.offset, <span class="hljs-property">@ace</span>.renderer.scrollLeft
        <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>.end
          <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'text'</span>
            translationVectors.push head.view.computePlaintextTranslationVector state, <span class="hljs-property">@mainCtx</span>
            textElements.push head
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>
            state.y += state.lineHeight
            state.x = state.indent * <span class="hljs-property">@mainCtx</span>.measureText(<span class="hljs-string">' '</span>).width + state.leftEdge
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span>
            state.indent += head.indent.depth
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span>
            state.indent -= head.indent.depth

          head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>We have now obtained the destination position for the animation; now we animate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        count = <span class="hljs-number">0</span>

        animatedColor = <span class="hljs-keyword">new</span> AnimatedColor(<span class="hljs-string">'#EEEEEE'</span>, <span class="hljs-string">'#FFFFFF'</span>, ANIMATION_FRAME_RATE)

        <span class="hljs-function"><span class="hljs-title">tick</span> = =&gt;</span>
          count += <span class="hljs-number">1</span>
          
          <span class="hljs-keyword">if</span> count &lt; ANIMATION_FRAME_RATE
            setTimeout tick, <span class="hljs-number">1000</span> / ANIMATION_FRAME_RATE

          <span class="hljs-property">@main</span>.style.left = PALETTE_WIDTH * (<span class="hljs-number">1</span> - count / ANIMATION_FRAME_RATE)
          <span class="hljs-property">@main</span>.style.backgroundColor = animatedColor.advance()
          <span class="hljs-property">@palette</span>.style.opacity = Math.max <span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-number">2</span> * (count / ANIMATION_FRAME_RATE)

          <span class="hljs-property">@clear</span>()
          
          <span class="hljs-property">@mainCtx</span>.globalAlpha = Math.max <span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-number">2</span> * count / ANIMATION_FRAME_RATE

          <span class="hljs-property">@tree</span>.view.draw <span class="hljs-property">@mainCtx</span>

          <span class="hljs-property">@mainCtx</span>.globalAlpha = <span class="hljs-number">1</span>
          
          <span class="hljs-keyword">for</span> element, i <span class="hljs-keyword">in</span> textElements
            element.view.textElement.draw <span class="hljs-property">@mainCtx</span>
            element.view.translate <span class="hljs-keyword">new</span> draw.Point translationVectors[i].x / ANIMATION_FRAME_RATE, translationVectors[i].y / ANIMATION_FRAME_RATE

          <span class="hljs-keyword">if</span> count &gt;= ANIMATION_FRAME_RATE</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>@ace.value = @getValue() # ACE_MARKER</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@ace</span>.clearSelection()
            <span class="hljs-property">@el</span>.style.display = <span class="hljs-string">'none'</span>
            <span class="hljs-property">@aceEl</span>.style.top = <span class="hljs-number">0</span>
            <span class="hljs-property">@aceEl</span>.style.left = <span class="hljs-number">0</span>
            <span class="hljs-property">@aceEl</span>.style.display = <span class="hljs-string">'block'</span>
            <span class="hljs-property">@currentlyAnimating</span> = <span class="hljs-literal">false</span>

        tick()
      ), <span class="hljs-number">0</span>
    
    <span class="hljs-attribute">performFreezeAnimation</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@currentlyAnimating</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">else</span> <span class="hljs-property">@currentlyAnimating</span> = <span class="hljs-literal">true</span>

      <span class="hljs-property">@setValue</span> <span class="hljs-property">@ace</span>.getValue() <span class="hljs-comment">#value ACE_MARKER</span>

      <span class="hljs-property">@redraw</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>First, we will need to get all the text elements which we will be animating.
Simultaneously, we can ask text elements to compute their position as if they were plaintext. This will be the
animation destination. Along the way we will move the cursor around due to newlines and indents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      textElements = []
      translationVectors = []
      head = <span class="hljs-property">@tree</span>.start</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>Set up the state which we will pass to </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      state =
        <span class="hljs-attribute">x</span>: <span class="hljs-property">@ace</span>.container.getBoundingClientRect().left - findPosLeft(<span class="hljs-property">@aceEl</span>) + <span class="hljs-property">@ace</span>.renderer.$gutterLayer.gutterWidth
        <span class="hljs-attribute">y</span>: <span class="hljs-property">@ace</span>.container.getBoundingClientRect().top - findPosTop(<span class="hljs-property">@aceEl</span>)
        <span class="hljs-attribute">indent</span>: <span class="hljs-number">0</span>
        <span class="hljs-attribute">lineHeight</span>: <span class="hljs-property">@ace</span>.renderer.layerConfig.lineHeight
        <span class="hljs-attribute">leftEdge</span>: <span class="hljs-property">@ace</span>.container.getBoundingClientRect().left - findPosLeft(<span class="hljs-property">@aceEl</span>) + <span class="hljs-property">@ace</span>.renderer.$gutterLayer.gutterWidth
      <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@tree</span>.end
        <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'text'</span>
          translationVectors.push head.view.computePlaintextTranslationVector state, <span class="hljs-property">@mainCtx</span>
          head.view.translate translationVectors[translationVectors.length - <span class="hljs-number">1</span>]
          textElements.push head
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>
          state.y += state.lineHeight
          state.x = state.indent * <span class="hljs-property">@mainCtx</span>.measureText(<span class="hljs-string">' '</span>).width + state.leftEdge
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span>
          state.indent += head.indent.depth
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span>
          state.indent -= head.indent.depth

        head = head.next

      <span class="hljs-property">@aceEl</span>.style.display = <span class="hljs-string">'none'</span>
      <span class="hljs-property">@el</span>.style.display = <span class="hljs-string">'block'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>We have now obtained the destination position for the animation; now we animate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      count = <span class="hljs-number">0</span>

      animatedColor = <span class="hljs-keyword">new</span> AnimatedColor <span class="hljs-string">'#FFFFFF'</span>, <span class="hljs-string">'#EEEEEE'</span>, ANIMATION_FRAME_RATE

      <span class="hljs-function"><span class="hljs-title">tick</span> = =&gt;</span>
        count += <span class="hljs-number">1</span>
        
        <span class="hljs-keyword">if</span> count &lt; ANIMATION_FRAME_RATE
          setTimeout tick, <span class="hljs-number">1000</span> / ANIMATION_FRAME_RATE

        <span class="hljs-property">@main</span>.style.left = PALETTE_WIDTH * (count / ANIMATION_FRAME_RATE)
        <span class="hljs-property">@main</span>.style.backgroundColor = animatedColor.advance()
        <span class="hljs-property">@palette</span>.style.opacity = Math.max <span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-number">2</span> * (<span class="hljs-number">1</span> - count / ANIMATION_FRAME_RATE)

        <span class="hljs-property">@clear</span>()
        
        <span class="hljs-property">@mainCtx</span>.globalAlpha = Math.max <span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-number">2</span> * (<span class="hljs-number">1</span> - count / ANIMATION_FRAME_RATE)

        <span class="hljs-property">@tree</span>.view.draw <span class="hljs-property">@mainCtx</span>

        <span class="hljs-property">@mainCtx</span>.globalAlpha = <span class="hljs-number">1</span>
        
        <span class="hljs-keyword">for</span> element, i <span class="hljs-keyword">in</span> textElements
          element.view.textElement.draw <span class="hljs-property">@mainCtx</span>
          element.view.translate <span class="hljs-keyword">new</span> draw.Point -translationVectors[i].x / ANIMATION_FRAME_RATE, -translationVectors[i].y / ANIMATION_FRAME_RATE

        <span class="hljs-keyword">if</span> count <span class="hljs-keyword">is</span> ANIMATION_FRAME_RATE
          <span class="hljs-property">@redraw</span>()
          <span class="hljs-property">@currentlyAnimating</span> = <span class="hljs-literal">false</span>

      tick()

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
