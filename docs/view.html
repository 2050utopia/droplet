<!DOCTYPE html>

<html>
<head>
  <title>view.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="coffee.html">
                coffee.coffee
              </a>
            
              
              <a class="source" href="controller.html">
                controller.coffee
              </a>
            
              
              <a class="source" href="draw.html">
                draw.coffee
              </a>
            
              
              <a class="source" href="main.html">
                main.coffee
              </a>
            
              
              <a class="source" href="model.html">
                model.coffee
              </a>
            
              
              <a class="source" href="requirejs_config.html">
                requirejs_config.coffee
              </a>
            
              
              <a class="source" href="view.html">
                view.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>view.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>ICE Editor View</p>
<p>Copyright (c) 2014 Anthony Bau.</p>
<p>MIT License</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
define [<span class="hljs-string">'ice-draw'</span>], <span class="hljs-function"><span class="hljs-params">(draw)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="magic-constants">Magic constants</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  PADDING = <span class="hljs-number">5</span>
  INDENT_SPACING = <span class="hljs-number">15</span>
  TOUNGE_HEIGHT = <span class="hljs-number">10</span>
  FONT_HEIGHT = <span class="hljs-number">15</span>
  EMPTY_SOCKET_HEIGHT = FONT_HEIGHT + PADDING * <span class="hljs-number">2</span>
  EMPTY_SOCKET_WIDTH = <span class="hljs-number">20</span>
  EMPTY_INDENT_HEIGHT = FONT_HEIGHT + PADDING * <span class="hljs-number">2</span>
  EMPTY_INDENT_WIDTH = <span class="hljs-number">50</span>
  MIN_SEGMENT_DROP_AREA_WIDTH = <span class="hljs-number">100</span>
  DROP_AREA_HEIGHT = <span class="hljs-number">30</span>
  TAB_WIDTH = <span class="hljs-number">15</span>
  TAB_HEIGHT = <span class="hljs-number">5</span>
  TAB_OFFSET = <span class="hljs-number">10</span>
  SOCKET_DROP_PADDING = <span class="hljs-number">3</span>
  
  <span class="hljs-built_in">exports</span> = {}

  <span class="hljs-built_in">exports</span>.BoundingBoxState = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BoundingBoxState</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(point)</span> -&gt;</span>
      <span class="hljs-property">@x</span> = point.x
      <span class="hljs-property">@y</span> = point.y

  <span class="hljs-built_in">exports</span>.PathWaypoint = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PathWaypoint</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@left</span>, <span class="hljs-property">@right</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1 id="iceview">IceView</h1>
<p>This is the base exports.from = class from which all other View elements (except the CursorView) extend.
Code here handles most tree operations that need to be performed (all of which occur in
FIRST PASS).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.IceView = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IceView</span></span>

    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@block</span>)</span> -&gt;</span>
      <span class="hljs-property">@children</span> = [] <span class="hljs-comment"># All child blocks, for event delegation. (IceView[])</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Start and end lines</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@lineStart</span> = <span class="hljs-property">@lineEnd</span> = <span class="hljs-literal">null</span>

      <span class="hljs-property">@lineChildren</span> = {} <span class="hljs-comment"># Children on each line, computed in FIRST PASS (int:IceView[])</span>

      <span class="hljs-property">@dimensions</span> = {} <span class="hljs-comment"># Bounding box on each line, computed in SECOND PASS (int:draw.Size)</span>

      <span class="hljs-property">@cursors</span> = []

      <span class="hljs-property">@dropArea</span> = <span class="hljs-literal">null</span>

      <span class="hljs-property">@highlightArea</span> = <span class="hljs-literal">null</span>

      <span class="hljs-property">@indented</span> = {}

      <span class="hljs-property">@indentEndsOn</span> = {}

      <span class="hljs-property">@indentStartsOn</span> = {}

      <span class="hljs-property">@pathWaypoints</span> = {} <span class="hljs-comment"># PathWaypoint[]</span>

      <span class="hljs-property">@bounds</span> = {} <span class="hljs-comment"># Bounding boxes on each line, computed in THIRD PASS (int:draw.Rectangle)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="first-pass-generate-linechildren-and-children">FIRST PASS: generate @lineChildren and @children</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeChildren</span>: <span class="hljs-function"><span class="hljs-params">(line)</span> -&gt;</span> <span class="hljs-comment"># (line) is the starting line</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Re-init all variables to blank.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@children</span> = []
      <span class="hljs-property">@lineStart</span> = <span class="hljs-property">@lineEnd</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@dropArea</span> = <span class="hljs-property">@highlightArea</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@lineChildren</span> = {}
      <span class="hljs-property">@dimensions</span> = {}
      <span class="hljs-property">@indented</span> = {}
      <span class="hljs-property">@indentEndsOn</span> = {}
      <span class="hljs-property">@indentStartsOn</span> = {}
      <span class="hljs-property">@pathWaypoints</span> = {}
      <span class="hljs-property">@bounds</span> = {}
      <span class="hljs-property">@cursors</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Record the starting line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@lineStart</span> = line</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Linked-list loop through inner tokens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      head = <span class="hljs-property">@block</span>.start.next
      <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@block</span>.end
        <span class="hljs-keyword">switch</span> head.type
          <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Ask this child to compute its children (thus determining its ending line, as well)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            line = head.block.view.computeChildren line</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Append to children array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@children</span>.push head.block.view</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Append to line children array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> occupiedLine <span class="hljs-keyword">in</span> [head.block.view.lineStart..head.block.view.lineEnd] <span class="hljs-comment"># (iterate over all blocks which this indent occupies)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>(initialize empty array if it doesn’t already exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-property">@lineChildren</span>[occupiedLine] ?= []</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Push to the children on this line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-property">@lineChildren</span>[occupiedLine].push head.block.view

              <span class="hljs-property">@indented</span>[occupiedLine] ||= head.block.view.indented[occupiedLine]
              <span class="hljs-property">@indentEndsOn</span>[occupiedLine] ||= head.block.view.indentEndsOn[occupiedLine]</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Skip to the end of this indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = head.block.end

          <span class="hljs-keyword">when</span> <span class="hljs-string">'indentStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Act analagously for indents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            line = head.indent.view.computeChildren line</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Append to children array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@children</span>.push head.indent.view</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Append to line children array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> occupiedLine <span class="hljs-keyword">in</span> [head.indent.view.lineStart..head.indent.view.lineEnd] <span class="hljs-comment"># (iterate over all lines which this indent occupies)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>(initialize empty array if it doesn’t already exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-property">@lineChildren</span>[occupiedLine] ?= []</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Push to the children on this line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-property">@lineChildren</span>[occupiedLine].push head.indent.view</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Mark that this line is indented here in this block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-property">@indented</span>[occupiedLine] = <span class="hljs-literal">true</span>

            <span class="hljs-property">@indentEndsOn</span>[head.indent.view.lineEnd] = <span class="hljs-literal">true</span>
            <span class="hljs-property">@indentStartsOn</span>[head.indent.view.lineStart] = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Skip to the end of this indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head = head.indent.end

          <span class="hljs-keyword">when</span> <span class="hljs-string">'socketStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Act analagously for sockets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            line = head.socket.view.computeChildren line

            <span class="hljs-property">@children</span>.push head.socket.view

            <span class="hljs-keyword">for</span> occupiedLine <span class="hljs-keyword">in</span> [head.socket.view.lineStart..head.socket.view.lineEnd]
              <span class="hljs-property">@lineChildren</span>[occupiedLine] ?= []

              <span class="hljs-property">@lineChildren</span>[occupiedLine].push head.socket.view

              <span class="hljs-property">@indented</span>[occupiedLine] ||= head.socket.view.indented[occupiedLine]
              <span class="hljs-property">@indentEndsOn</span>[occupiedLine] ||= head.socket.view.indentEndsOn[occupiedLine]

            head = head.socket.end

          <span class="hljs-keyword">when</span> <span class="hljs-string">'segmentStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Act analagously for segments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            line = head.segment.view.computeChildren line

            <span class="hljs-property">@children</span>.push head.segment.view

            <span class="hljs-keyword">for</span> occupiedLine <span class="hljs-keyword">in</span> [head.segment.view.lineStart..head.segment.view.lineEnd]
              <span class="hljs-property">@lineChildren</span>[occupiedLine] ?= []

              <span class="hljs-property">@lineChildren</span>[occupiedLine].push head.segment.view

              <span class="hljs-property">@indented</span>[occupiedLine] ||= head.segment.view.indented[occupiedLine]
              <span class="hljs-property">@indentEndsOn</span>[occupiedLine] ||= head.segment.view.indentEndsOn[occupiedLine]

            head = head.segment.end

          <span class="hljs-keyword">when</span> <span class="hljs-string">'text'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Act analagously for text and cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            head.view.computeChildren line</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>(For text and cursor the token itself is also the manifested thing)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@children</span>.push head.view
            
            <span class="hljs-property">@lineChildren</span>[line] ?= []; <span class="hljs-property">@lineChildren</span>[line].push head.view

          <span class="hljs-keyword">when</span> <span class="hljs-string">'cursor'</span>
            <span class="hljs-property">@cursors</span>.push
              <span class="hljs-attribute">token</span>: head
              <span class="hljs-attribute">line</span>: line

          <span class="hljs-keyword">when</span> <span class="hljs-string">'newline'</span>
            line += <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Advance our head token (linked-loop list)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Record the last line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@lineEnd</span> = line</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Default any empty lines to having children []</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> [<span class="hljs-property">@lineStart</span>..<span class="hljs-property">@lineEnd</span>]
        <span class="hljs-property">@lineChildren</span>[l] ?= []

      <span class="hljs-keyword">return</span> line</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h2 id="second-pass-compute-dimensions-on-each-line">SECOND PASS: compute dimensions on each line</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeDimensions</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># A block's dimensions on each line is strictly a function of its children, so this function has no arguments.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Event propagate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@children</span> <span class="hljs-keyword">then</span> child.computeDimensions()

      <span class="hljs-keyword">return</span> <span class="hljs-property">@dimensions</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>THIRD PASS: compute bounding boxes on each line ##</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeBoundingBox</span>: <span class="hljs-function"><span class="hljs-params">(line, state)</span> -&gt;</span> <span class="hljs-comment"># (line) and (state) are given by the calling parent and signify restrictions on the position of the line (e.g. padding, etc).</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Event propagate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@lineChildren</span>[line] <span class="hljs-keyword">then</span> child.computeBoundingBox line, state <span class="hljs-comment"># In an instance of this function, you will want to change (state) as you move along @lineChildren[line], to adjust for padding and such.</span>

      <span class="hljs-keyword">return</span> <span class="hljs-property">@bounds</span>[line] = <span class="hljs-keyword">new</span> draw.NoRectangle() <span class="hljs-comment"># Should actually equal something</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="fourth-pass-join-path-bits-into-a-path">FOURTH PASS: join “path bits” into a path</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computePath</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Event propagate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@children</span> <span class="hljs-keyword">then</span> child.computePath()

      <span class="hljs-keyword">return</span> <span class="hljs-property">@bounds</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="fifth-pass-draw">FIFTH PASS: draw</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">drawPath</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Event propagate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@children</span> <span class="hljs-keyword">then</span> child.drawPath ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="sixth-pass-draw-cursor">SIXTH Pass: draw cursor</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">drawCursor</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@children</span> <span class="hljs-keyword">then</span> child.drawCursor ctx

      <span class="hljs-keyword">for</span> cursor <span class="hljs-keyword">in</span> <span class="hljs-property">@cursors</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Depending on whether the cursor is positioned at the beginning or the end of the line,
we render it after or before the line it is on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> cursor.token.prev.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">or</span> cursor.token.prev.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span>
          yCoordinate = <span class="hljs-property">@bounds</span>[cursor.line].y
        <span class="hljs-keyword">else</span>
          yCoordinate = <span class="hljs-property">@bounds</span>[cursor.line].bottom()

        cursor.token.view.point.y = yCoordinate

        ctx.fillStyle = <span class="hljs-string">'#000'</span>
        ctx.strokeSTyle = <span class="hljs-string">'#000'</span>
        ctx.beginPath()

        <span class="hljs-keyword">if</span> <span class="hljs-property">@bounds</span>[cursor.line].x &gt;= <span class="hljs-number">5</span>
          ctx.moveTo <span class="hljs-property">@bounds</span>[cursor.line].x, yCoordinate
          ctx.lineTo <span class="hljs-property">@bounds</span>[cursor.line].x - <span class="hljs-number">5</span>, yCoordinate - <span class="hljs-number">5</span>
          ctx.lineTo <span class="hljs-property">@bounds</span>[cursor.line].x - <span class="hljs-number">5</span>, yCoordinate + <span class="hljs-number">5</span>
        <span class="hljs-keyword">else</span>
          ctx.moveTo <span class="hljs-property">@bounds</span>[cursor.line].x, yCoordinate
          ctx.lineTo <span class="hljs-property">@bounds</span>[cursor.line].x + <span class="hljs-number">5</span>, yCoordinate - <span class="hljs-number">5</span>
          ctx.lineTo <span class="hljs-property">@bounds</span>[cursor.line].x + <span class="hljs-number">5</span>, yCoordinate + <span class="hljs-number">5</span>

        ctx.stroke()
        ctx.fill()</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h3 id="convenience-function-full-draw">Convenience function: full draw</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">draw</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
      <span class="hljs-property">@drawPath</span> ctx
      <span class="hljs-property">@drawCursor</span> ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h3 id="convenience-function-computeboundingboxes-">Convenience function: computeBoundingBoxes.</h3>
<p>Normally called on root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeBoundingBoxes</span>:<span class="hljs-function"> -&gt;</span>
      cursor = <span class="hljs-keyword">new</span> draw.Point <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> [<span class="hljs-property">@lineStart</span>..<span class="hljs-property">@lineEnd</span>]
        <span class="hljs-property">@computeBoundingBox</span> line, <span class="hljs-keyword">new</span> BoundingBoxState cursor
        cursor.y += <span class="hljs-property">@dimensions</span>[line].height

      <span class="hljs-keyword">return</span> <span class="hljs-property">@bounds</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h3 id="getbounds">getBounds</h3>
<p>Get the enclosing bounds of this entire element
Must be called after passes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">getBounds</span>:<span class="hljs-function"> -&gt;</span>
      bound = <span class="hljs-keyword">new</span> draw.NoRectangle()

      <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> [<span class="hljs-property">@lineStart</span>..<span class="hljs-property">@lineEnd</span>]
        bound.unite <span class="hljs-property">@bounds</span>[line]

      <span class="hljs-keyword">return</span> bound</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h3 id="convenience-function-compute">Convenience function: compute</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">compute</span>: <span class="hljs-function"><span class="hljs-params">(line = <span class="hljs-number">0</span>)</span> -&gt;</span>
      <span class="hljs-property">@computeChildren</span> line
      <span class="hljs-property">@computeDimensions</span>(); <span class="hljs-property">@computeBoundingBoxes</span>(); <span class="hljs-property">@computePath</span>()

    <span class="hljs-attribute">translate</span>: <span class="hljs-function"><span class="hljs-params">(point)</span> -&gt;</span>
      <span class="hljs-keyword">for</span> line, bound <span class="hljs-keyword">of</span> <span class="hljs-property">@bounds</span> <span class="hljs-keyword">then</span> bound.translate point
      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@children</span> <span class="hljs-keyword">then</span> child.translate point</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h1 id="blockview">BlockView</h1>
<p>The renderer for an ICE.Block(). Most paths and colors
in ICE editor stem from here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.BlockView = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IceView</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(block)</span> -&gt;</span>
      <span class="hljs-keyword">super</span> block
      <span class="hljs-property">@path</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <h2 id="computedimensions">computeDimensions</h2>
<p>Each line of a block adds padding on all four sides;
besides this height = max(children_heights), and
width = sum(children_widths).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeDimensions</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Event propagate, and any other necessary wrappers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">super</span>

      <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> [<span class="hljs-property">@lineStart</span>..<span class="hljs-property">@lineEnd</span>]
        width = PADDING; height = <span class="hljs-number">2</span> * PADDING

        <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@lineChildren</span>[line]

          <span class="hljs-keyword">if</span> child.block.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indent'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>The width of a block on a line is the sum of the widths of the child blocks, plus padding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            width += child.dimensions[line].width + INDENT_SPACING</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>The height of a block on a line is the maximum height of a child block, plus padding.
We add 10 if the indent ends, so as to draw the bottom of the mouth.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            height = Math.max height, child.dimensions[line].height + (<span class="hljs-keyword">if</span> child.lineEnd <span class="hljs-keyword">is</span> line <span class="hljs-keyword">then</span> TOUNGE_HEIGHT <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>)

          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> child.indented[line]
            width += child.dimensions[line].width + PADDING</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>The height of a block on a line is the maximum height of a child block. Indented things do not use any padding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            height = Math.max height, child.dimensions[line].height + (<span class="hljs-keyword">if</span> child.lineEnd <span class="hljs-keyword">is</span> line <span class="hljs-keyword">and</span> child.indentEndsOn[line] <span class="hljs-keyword">then</span> TOUNGE_HEIGHT <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>)

          <span class="hljs-keyword">else</span>
            width += child.dimensions[line].width + PADDING</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>The height of a block on a line is the maximum height of a child block, plus padding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            height = Math.max height, child.dimensions[line].height + <span class="hljs-number">2</span> * PADDING

        <span class="hljs-property">@dimensions</span>[line] = <span class="hljs-keyword">new</span> draw.Size width, height</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h2 id="computeboundingbox">computeBoundingBox</h2>
<p>This function is probably the most computation-intensive function in this entire file.
It has has a lot of special cases to deal with indented blocks
inside us — the tounge, G-shape, and left side of an indent mouth.
It is responsible for aligning block coordinates on each line, and setting up waypoints
to later connect with the container polygon.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeBoundingBox</span>: <span class="hljs-function"><span class="hljs-params">(line, state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Find the middle of this rectangle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      axis = state.y + <span class="hljs-property">@dimensions</span>[line].height / <span class="hljs-number">2</span>
      cursor = state.x

      <span class="hljs-keyword">if</span> <span class="hljs-property">@lineChildren</span>[line].length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].lineEnd <span class="hljs-keyword">is</span> line <span class="hljs-keyword">and</span> <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].indentEndsOn[line]
        axis -= TOUNGE_HEIGHT / <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Accept the bounds given by our parent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@bounds</span>[line] = <span class="hljs-keyword">new</span> draw.Rectangle state.x, state.y, <span class="hljs-property">@dimensions</span>[line].width, <span class="hljs-property">@dimensions</span>[line].height

      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@lineChildren</span>[line]</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Special case for indented things; always jam them together.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> child.block.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indent'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Add the padding on the left of this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cursor += INDENT_SPACING
          
          child.computeBoundingBox line, <span class="hljs-keyword">new</span> BoundingBoxState <span class="hljs-keyword">new</span> draw.Point cursor,
            state.y <span class="hljs-comment"># Position the child at the top of the line.</span>
        
        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Add the padding on the left of this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cursor += PADDING

          child.computeBoundingBox line, <span class="hljs-keyword">new</span> BoundingBoxState <span class="hljs-keyword">new</span> draw.Point cursor,
            axis - child.dimensions[line].height / <span class="hljs-number">2</span> <span class="hljs-comment"># Position the child in the middle of the line</span>

        cursor += child.dimensions[line].width</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Compute the path waypoints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-property">@lineChildren</span>[line].length &gt;  <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (<span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].indented[line] <span class="hljs-keyword">or</span> <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].block.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indent'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Normally, we just enclose everything within these bounds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@pathWaypoints</span>[line] = <span class="hljs-keyword">new</span> PathWaypoint [
          <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].y
          <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].bottom()
        ], [
          <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].right(), <span class="hljs-property">@bounds</span>[line].y
          <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].right(), <span class="hljs-property">@bounds</span>[line].bottom()
        ]

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@lineChildren</span>[line].length &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>There is, however, the special case when a child on this line is indented, or is an indent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">if</span> line <span class="hljs-keyword">is</span> <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].lineEnd <span class="hljs-keyword">and</span> (<span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].indentEndsOn[line] <span class="hljs-keyword">or</span> <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].block.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indent'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If the indent ends on this line, we draw the piece underneath it, and any ‘G’-shape elements after it.</p>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>We name this for conveniency</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          indentChild = <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>]

          paddingLeft = <span class="hljs-keyword">if</span> <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].block.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indent'</span> <span class="hljs-keyword">then</span> INDENT_SPACING <span class="hljs-keyword">else</span> PADDING

          <span class="hljs-keyword">if</span> <span class="hljs-property">@lineChildren</span>[line].length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
            <span class="hljs-property">@pathWaypoints</span>[line] = <span class="hljs-keyword">new</span> PathWaypoint [</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>The line down the left of the child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].y
              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].bottom()
            ], [</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>The box to the left of the child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + paddingLeft, <span class="hljs-property">@bounds</span>[line].y
              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + paddingLeft, indentChild.bounds[line].bottom()</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>The ‘tounge’ underneath the child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point indentChild.bounds[line].right(), indentChild.bounds[line].bottom()</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>For robustness, make sure that we go all the way to the right here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].right(), indentChild.bounds[line].bottom()</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Pop down to the bottom, ready for next rectangle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].right(), <span class="hljs-property">@bounds</span>[line].bottom()
            ]

          <span class="hljs-keyword">else</span>
            <span class="hljs-property">@pathWaypoints</span>[line] = <span class="hljs-keyword">new</span> PathWaypoint [</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>The line down the left of the child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].y
              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].bottom()
            ], [</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>The box to the left of the child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + paddingLeft, <span class="hljs-property">@bounds</span>[line].y
              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + paddingLeft, indentChild.bounds[line].bottom()</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>The ‘tounge’ underneath the child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point indentChild.bounds[line].right(), indentChild.bounds[line].bottom()</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>The ‘hook’ of the G, coming up from the tounge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point indentChild.bounds[line].right(), <span class="hljs-property">@bounds</span>[line].y</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Finish the box, ready for next rectangle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].right(), <span class="hljs-property">@bounds</span>[line].y
              <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].right(), <span class="hljs-property">@bounds</span>[line].bottom()
            ]

        <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>When the child in front of us is indented, we only draw a thin strip
of conainer block to the left of them, with width INDENT_SPACING</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@pathWaypoints</span>[line] = <span class="hljs-keyword">new</span> PathWaypoint [</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>(Left side)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].y
            <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x, <span class="hljs-property">@bounds</span>[line].bottom()
          ], [</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>(Right side)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + INDENT_SPACING, <span class="hljs-property">@bounds</span>[line].y
            <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + INDENT_SPACING, <span class="hljs-property">@bounds</span>[line].bottom()
          ]</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <h2 id="computepath">computePath</h2>
<p>Here we connect the pathBits we set up in computeBoundingBox.
Each pathBits contains points for the right edge and points for the left edge,
and we simply extend the ends of our path to consume them on either side.
This function is responsible for keeping paths rectilinear and adding tabs on blocks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computePath</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">super</span>
      
      <span class="hljs-property">@path</span> = <span class="hljs-keyword">new</span> draw.Path()
      <span class="hljs-property">@dropArea</span> = <span class="hljs-keyword">new</span> draw.Rectangle <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].x, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].bottom() - DROP_AREA_HEIGHT / <span class="hljs-number">2</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].width, DROP_AREA_HEIGHT
      <span class="hljs-property">@dropHighlightReigon</span> = <span class="hljs-keyword">new</span> draw.Rectangle <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].x, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].bottom() - <span class="hljs-number">5</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].width, <span class="hljs-number">10</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Add the top tab (if applicable)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">unless</span> (<span class="hljs-property">@block</span>.inSocket() ? <span class="hljs-literal">false</span>)
        <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x + TAB_OFFSET, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y
        <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x + TAB_OFFSET + TAB_WIDTH / <span class="hljs-number">8</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y + TAB_HEIGHT
        <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x + TAB_OFFSET + TAB_WIDTH * <span class="hljs-number">7</span> / <span class="hljs-number">8</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y + TAB_HEIGHT
        <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x + TAB_OFFSET + TAB_WIDTH, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y

      <span class="hljs-keyword">for</span> line, waypoint <span class="hljs-keyword">of</span> <span class="hljs-property">@pathWaypoints</span>
        
        <span class="hljs-keyword">if</span> <span class="hljs-property">@indentStartsOn</span>[line]</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Add top tab on an indent, if applicable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          entryPoint = <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + INDENT_SPACING + TAB_OFFSET + TAB_WIDTH, <span class="hljs-property">@bounds</span>[line].y</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Keep things rectilinear (except for the tab itself)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-property">@path</span>._points.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> entryPoint.y <span class="hljs-keyword">isnt</span> <span class="hljs-property">@path</span>._points[<span class="hljs-property">@path</span>._points.length - <span class="hljs-number">1</span>].y
            <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@path</span>._points[<span class="hljs-property">@path</span>._points.length - <span class="hljs-number">1</span>].x, entryPoint.y</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Now actually add the top tab</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@path</span>.push entryPoint
          <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + INDENT_SPACING + TAB_OFFSET + TAB_WIDTH * <span class="hljs-number">7</span> / <span class="hljs-number">8</span>, <span class="hljs-property">@bounds</span>[line].y + TAB_HEIGHT
          <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + INDENT_SPACING + TAB_OFFSET + TAB_WIDTH / <span class="hljs-number">8</span>, <span class="hljs-property">@bounds</span>[line].y + TAB_HEIGHT
          <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[line].x + INDENT_SPACING + TAB_OFFSET, <span class="hljs-property">@bounds</span>[line].y

        <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> waypoint.left</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Keep things rectilinear</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-property">@path</span>._points.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> point.x <span class="hljs-keyword">isnt</span> <span class="hljs-property">@path</span>._points[<span class="hljs-number">0</span>].x
            <span class="hljs-property">@path</span>.unshift <span class="hljs-keyword">new</span> draw.Point point.x, <span class="hljs-property">@path</span>._points[<span class="hljs-number">0</span>].y

          <span class="hljs-property">@path</span>.unshift point

        <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> waypoint.right</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Keep things rectilinear</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-property">@path</span>._points.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> point.y <span class="hljs-keyword">isnt</span> <span class="hljs-property">@path</span>._points[<span class="hljs-property">@path</span>._points.length - <span class="hljs-number">1</span>].y
            <span class="hljs-property">@path</span>.push <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@path</span>._points[<span class="hljs-property">@path</span>._points.length - <span class="hljs-number">1</span>].x, point.y

          <span class="hljs-property">@path</span>.push point</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Add the bottom tab (if applicable)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">unless</span> (<span class="hljs-property">@block</span>.inSocket() ? <span class="hljs-literal">false</span>)
        <span class="hljs-property">@path</span>.unshift <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].x + TAB_OFFSET, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].bottom()
        <span class="hljs-property">@path</span>.unshift <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].x + TAB_OFFSET + TAB_WIDTH / <span class="hljs-number">8</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].bottom() + TAB_HEIGHT
        <span class="hljs-property">@path</span>.unshift <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].x + TAB_OFFSET + TAB_WIDTH * <span class="hljs-number">7</span> / <span class="hljs-number">8</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].bottom() + TAB_HEIGHT
        <span class="hljs-property">@path</span>.unshift <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].x + TAB_OFFSET + TAB_WIDTH, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineEnd</span>].bottom()

      <span class="hljs-property">@path</span>.style.fillColor = <span class="hljs-property">@block</span>.color
      <span class="hljs-property">@path</span>.style.strokeColor = <span class="hljs-string">'#000'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <h2 id="drawpath">drawPath</h2>
<p>This just executes that path we constructed in computePath</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">drawPath</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@path</span>._points.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">debugger</span>
      <span class="hljs-property">@path</span>.draw ctx

      <span class="hljs-keyword">super</span>

    <span class="hljs-attribute">translate</span>: <span class="hljs-function"><span class="hljs-params">(point)</span> -&gt;</span>
      <span class="hljs-property">@path</span>.translate point

      <span class="hljs-keyword">super</span>

  <span class="hljs-built_in">exports</span>.TextView = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IceView</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(block)</span> -&gt;</span>
      <span class="hljs-keyword">super</span> block
      <span class="hljs-property">@textElement</span> = <span class="hljs-literal">null</span>
      
    <span class="hljs-attribute">computeChildren</span>: <span class="hljs-function"><span class="hljs-params">(line)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>A text element cannot contain anything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@lineStart</span> = <span class="hljs-property">@lineEnd</span> = line

    <span class="hljs-attribute">computeDimensions</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Construct a manifest text element for this text token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@textElement</span> = <span class="hljs-keyword">new</span> draw.Text <span class="hljs-keyword">new</span> draw.Point(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
        <span class="hljs-property">@block</span>.value</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>A text element only occupies one line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@dimensions</span>[<span class="hljs-property">@lineStart</span>] = <span class="hljs-keyword">new</span> draw.Size <span class="hljs-property">@textElement</span>.bounds().width,
        <span class="hljs-property">@textElement</span>.bounds().height

      <span class="hljs-keyword">return</span> <span class="hljs-property">@dimesions</span>
    
    <span class="hljs-attribute">computeBoundingBox</span>: <span class="hljs-function"><span class="hljs-params">(line, state)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> line <span class="hljs-keyword">is</span> <span class="hljs-property">@lineStart</span></pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Accept the bounds our parent gave us</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@bounds</span>[line] = <span class="hljs-keyword">new</span> draw.Rectangle state.x, state.y, <span class="hljs-property">@dimensions</span>[line].width, <span class="hljs-property">@dimensions</span>[line].height</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Move the text element to where we want it to go</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@textElement</span>.setPosition <span class="hljs-keyword">new</span> draw.Point state.x, state.y
    
    <span class="hljs-attribute">computePath</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># Do nothing</span>

    <span class="hljs-attribute">drawPath</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
      <span class="hljs-property">@textElement</span>.draw ctx

    <span class="hljs-attribute">translate</span>: <span class="hljs-function"><span class="hljs-params">(point)</span> -&gt;</span>
      <span class="hljs-property">@textElement</span>.translate point

      <span class="hljs-keyword">super</span></pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <h2 id="computeplaintexttranslationvector">computePlaintextTranslationVector</h2>
<p>The following is a function unique to TextView This will compute the position of the text as if it were
rendered as plaintext; used by the Controller to do the animation for freeze and melt.</p>
<p>It is passed state and ctx; ctx will remain unchanged and is used for measuring text,
whereas state will be modified (so must be mutable) to be passable to the next text token found after this.</p>
<p>State has properties:</p>
<ul>
<li>indent (num)</li>
<li>x (num)</li>
<li>y (num)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computePlaintextTranslationVector</span>: <span class="hljs-function"><span class="hljs-params">(state, ctx)</span> -&gt;</span>
      point = <span class="hljs-keyword">new</span> draw.Point state.x, state.y

      state.x += ctx.measureText(<span class="hljs-property">@block</span>.value).width

      <span class="hljs-keyword">return</span> point.from <span class="hljs-keyword">new</span> draw.Point <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <h1 id="indentview">IndentView</h1>
<p>This is the renderer for and indent. It doesn’t actually draw anything,
but handles some coordinate placement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.IndentView = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndentView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IceView</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(block)</span> -&gt;</span>
      <span class="hljs-keyword">super</span> block</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <h2 id="computechildren">computeChildren</h2>
<p>We need to override this, because every Indent
starts with a newline. We don’t actually want that
newline to be part of our rendering domain, so we
skip it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeChildren</span>: <span class="hljs-function"><span class="hljs-params">(line)</span> -&gt;</span>
      <span class="hljs-keyword">super</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Skip over the leading newline required by every indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@lineStart</span> += <span class="hljs-number">1</span>

      <span class="hljs-keyword">return</span> <span class="hljs-property">@lineEnd</span></pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h2 id="computedimensions">computeDimensions</h2>
<p>Like BlockView, this has height = max(child_heights),
width = sum(child_widths). An Indent, however, adds no padding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeDimensions</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">super</span></pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>If an indent is empty, then we don’t actually want to deal with any lines.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-property">@lineEnd</span> &gt;= <span class="hljs-property">@lineStart</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> [<span class="hljs-property">@lineStart</span>..<span class="hljs-property">@lineEnd</span>]
        height = width = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@lineChildren</span>[line]</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Indents undertake no padding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          width += child.dimensions[line].width
          height = Math.max height, child.dimensions[line].height

        height = Math.max height, EMPTY_INDENT_HEIGHT
        width = Math.max width, EMPTY_INDENT_WIDTH
        
        <span class="hljs-property">@dimensions</span>[line] = <span class="hljs-keyword">new</span> draw.Size width, height</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <h2 id="computeboundingbox">computeBoundingBox</h2>
<p>Delegate immediately to our children;
since we aren’t planning to draw anything,
this function is pretty minimal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeBoundingBox</span>: <span class="hljs-function"><span class="hljs-params">(line, state)</span> -&gt;</span>
      cursorX = state.x
      cursorY = state.y</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Accept the bounds that our parent gave us</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@bounds</span>[line] = <span class="hljs-keyword">new</span> draw.Rectangle state.x, state.y, <span class="hljs-property">@dimensions</span>[line].width, <span class="hljs-property">@dimensions</span>[line].height

      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@lineChildren</span>[line]
        child.computeBoundingBox line, <span class="hljs-keyword">new</span> BoundingBoxState <span class="hljs-keyword">new</span> draw.Point cursorX, cursorY
        
        cursorX += child.dimensions[line].width</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <h2 id="computepath">computePath</h2>
<p>We must override this method in order to produce a drop area
for drag-and-drop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computePath</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-property">@dropArea</span> = <span class="hljs-keyword">new</span> draw.Rectangle <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y - DROP_AREA_HEIGHT / <span class="hljs-number">2</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].width, DROP_AREA_HEIGHT
      <span class="hljs-property">@dropHighlightReigon</span> = <span class="hljs-keyword">new</span> draw.Rectangle <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y - <span class="hljs-number">5</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].width, <span class="hljs-number">10</span>

      <span class="hljs-keyword">super</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <h1 id="socketview">SocketView</h1>
<p>The renderer for a socket. When a socket is occupied
by a block, it simply delegates all render tasks to the occupying block.
However, if it is occupied by text or is empty, it will render itself
appropriately. That is this class’s responsibility.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.SocketView = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocketView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IceView</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(block)</span> -&gt;</span> <span class="hljs-keyword">super</span> block</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <h2 id="computedimensions">computeDimensions</h2>
<p>We add padding around text if that is what
we contain, but not around blocks. If we 
are empty, our dimensions are a default value
specified in the constants at the top of this
file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeDimensions</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">super</span>
      
      <span class="hljs-keyword">if</span> (content = <span class="hljs-property">@block</span>.content())? <span class="hljs-keyword">then</span> <span class="hljs-keyword">switch</span> <span class="hljs-property">@block</span>.content().type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'block'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>If we contain a block, then we mimick that block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> line, value <span class="hljs-keyword">of</span> content.view.dimensions</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>(Clone the sizes of the contained block)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-property">@dimensions</span>[line] = <span class="hljs-keyword">new</span> draw.Size value.width, value.height

        <span class="hljs-keyword">when</span> <span class="hljs-string">'text'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>If we contain some text, then we add padding around it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@dimensions</span>[content.view.lineStart] = <span class="hljs-keyword">new</span> draw.Size content.view.dimensions[content.view.lineStart].width + <span class="hljs-number">2</span> * PADDING,
            content.view.dimensions[content.view.lineStart].height + <span class="hljs-number">2</span> * PADDING</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Don’t allow ourselves to get smaller than an empty socket, though&gt;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@dimensions</span>[content.view.lineStart].width = Math.max <span class="hljs-property">@dimensions</span>[content.view.lineStart].width, EMPTY_SOCKET_WIDTH
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@dimensions</span>[<span class="hljs-property">@lineStart</span>] = <span class="hljs-keyword">new</span> draw.Size EMPTY_SOCKET_WIDTH, EMPTY_SOCKET_HEIGHT

      <span class="hljs-keyword">return</span> <span class="hljs-property">@dimensions</span></pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <h2 id="computeboundingbox">computeBoundingBox</h2>
<p>Again, we delegate to our content
block if it exists. If we have text as content,
we position the text as aligns with our added padding.
If we are empty, we simply accept the bounds our parent give us
and end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeBoundingBox</span>: <span class="hljs-function"><span class="hljs-params">(line, state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Accept the bounds given by our parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@bounds</span>[line] = <span class="hljs-keyword">new</span> draw.Rectangle state.x, state.y, <span class="hljs-property">@dimensions</span>[line].width, <span class="hljs-property">@dimensions</span>[line].height
      
      <span class="hljs-keyword">if</span> <span class="hljs-property">@lineChildren</span>[line].length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@lineChildren</span>[line].length &gt; <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>This is not allowed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Error: more than one child inside a socket'</span>
      
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@block</span>.content().type <span class="hljs-keyword">is</span> <span class="hljs-string">'text'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Add padding around the text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].computeBoundingBox line, <span class="hljs-keyword">new</span> BoundingBoxState <span class="hljs-keyword">new</span> draw.Point state.x + PADDING, state.y + PADDING

      <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Delegate to our content block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@lineChildren</span>[line][<span class="hljs-number">0</span>].computeBoundingBox line, state</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <h2 id="computepath">computePath</h2>
<p>We must override this to produce a drop area.
We have no drop area if we are filled by a block
(as we are not droppable).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computePath</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">unless</span> <span class="hljs-property">@block</span>.content()?.type <span class="hljs-keyword">is</span> <span class="hljs-string">'block'</span>
        (<span class="hljs-property">@dropArea</span> = <span class="hljs-keyword">new</span> draw.Rectangle()).copy <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>]
        <span class="hljs-property">@dropHighlightReigon</span> = <span class="hljs-keyword">new</span> draw.Rectangle <span class="hljs-property">@dropArea</span>.x - SOCKET_DROP_PADDING, <span class="hljs-property">@dropArea</span>.y - SOCKET_DROP_PADDING, <span class="hljs-property">@dropArea</span>.width + SOCKET_DROP_PADDING * <span class="hljs-number">2</span>, <span class="hljs-property">@dropArea</span>.height + SOCKET_DROP_PADDING * <span class="hljs-number">2</span>

      <span class="hljs-keyword">super</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <h2 id="drawpath">drawPath</h2>
<p>If we are empty or contain text,
then we must draw the white rectangle.
Otherwise, simply delegate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">drawPath</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@block</span>.content()? <span class="hljs-keyword">or</span> <span class="hljs-property">@block</span>.content().type <span class="hljs-keyword">is</span> <span class="hljs-string">'text'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>If we are empty, then draw our unit rectangle. If we have text inside, then draw the wrapping rectangle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].stroke ctx, <span class="hljs-string">'#000'</span>
        <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].fill ctx, <span class="hljs-string">'#FFF'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Event propagate (this deals with block children)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">super</span></pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <h1 id="segmentview">SegmentView</h1>
<p>The renderer for a Segment. Segments are meant to
be entirely invisible, so this simply delegates to children
and manages their y-coordinates as necessary (putting them
one after another, if there are multiple children).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.SegmentView = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SegmentView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IceView</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(block)</span> -&gt;</span> <span class="hljs-keyword">super</span> block</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <h2 id="computedimensions">computeDimensions</h2>
<p>Like an Indent, height = max(child_heights),
width = sum(child_widths) for each line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeDimensions</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">super</span>

      <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> [<span class="hljs-property">@lineStart</span>..<span class="hljs-property">@lineEnd</span>]
        height = width = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@lineChildren</span>[line]</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Segments undertake no padding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          width += child.dimensions[line].width
          height = Math.max height, child.dimensions[line].height
        
        <span class="hljs-property">@dimensions</span>[line] = <span class="hljs-keyword">new</span> draw.Size width, height</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <h2 id="computeboundingbox">computeBoundingBox</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">computeBoundingBox</span>: <span class="hljs-function"><span class="hljs-params">(line, state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>A Segment can compute its bounds the same way an Indent does.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cursorX = state.x
      cursorY = state.y</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Accept the bounds that our parent gave us</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@bounds</span>[line] = <span class="hljs-keyword">new</span> draw.Rectangle state.x, state.y, <span class="hljs-property">@dimensions</span>[line].width, <span class="hljs-property">@dimensions</span>[line].height

      <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@lineChildren</span>[line]
        child.computeBoundingBox line, <span class="hljs-keyword">new</span> BoundingBoxState <span class="hljs-keyword">new</span> draw.Point cursorX, cursorY
        
        cursorX += child.dimensions[line].width</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <h2 id="drawpath">drawPath</h2>
<p>We must override this to provide a drop area</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">drawPath</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-property">@dropArea</span> = <span class="hljs-keyword">new</span> draw.Rectangle <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x,
        <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y - <span class="hljs-number">5</span>,
        Math.max(<span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].width,MIN_SEGMENT_DROP_AREA_WIDTH),
        <span class="hljs-number">10</span>

      <span class="hljs-property">@dropHighlightReigon</span> = <span class="hljs-keyword">new</span> draw.Rectangle <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].x, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].y - <span class="hljs-number">5</span>, <span class="hljs-property">@bounds</span>[<span class="hljs-property">@lineStart</span>].width, <span class="hljs-number">10</span>

      <span class="hljs-keyword">super</span></pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <h1 id="cursorview">CursorView</h1>
<p>This exports.is = class is a bit degenerate;
it’s mainly used by the controller to determine the position
at which a cursor was rendered. The drawing function for a cursor
is actually the responsibility of the cursor’s parent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">exports</span>.CursorView = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CursorView</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@block</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>This will be the point at which the cursor was drawn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@point</span> = <span class="hljs-keyword">new</span> draw.Point <span class="hljs-number">0</span>, <span class="hljs-number">0</span>

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
