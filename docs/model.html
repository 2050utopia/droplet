<!DOCTYPE html>

<html>
<head>
  <title>model.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="coffee.html">
                coffee.coffee
              </a>
            
              
              <a class="source" href="controller.html">
                controller.coffee
              </a>
            
              
              <a class="source" href="draw.html">
                draw.coffee
              </a>
            
              
              <a class="source" href="model.html">
                model.coffee
              </a>
            
              
              <a class="source" href="view.html">
                view.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>model.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Tree classes and operations for ICE editor.</p>
<p>Copyright (c) 2014 Anthony Bau.</p>
<p>MIT License.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-built_in">exports</span> = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="block">Block</h1>
<p>The basic data structure in ICE Editor is a linked list. A Block is a group of 
two tokens, one start token and one end token. Everything between these tokens
is a block’s content. Thus “tree” operations are linked-list
splices.</p>
<p>To handle order-of-operations precedence, a block knows a @precedence, an integer.
When we drop block A into socket B then if and only if B.precedence &gt; A.precedence does A
wrap itself in parentheses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-built_in">exports</span>.Block = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(contents, <span class="hljs-property">@precedence</span> = <span class="hljs-number">0</span>)</span> -&gt;</span>
    <span class="hljs-property">@start</span> = <span class="hljs-keyword">new</span> BlockStartToken <span class="hljs-keyword">this</span>
    <span class="hljs-property">@end</span> = <span class="hljs-keyword">new</span> BlockEndToken <span class="hljs-keyword">this</span>

    <span class="hljs-property">@currentlyParenWrapped</span> = <span class="hljs-literal">false</span>

    <span class="hljs-property">@type</span> = <span class="hljs-string">'block'</span>
    <span class="hljs-property">@color</span> = <span class="hljs-string">'#ddf'</span>

    <span class="hljs-property">@selected</span> = <span class="hljs-literal">false</span> <span class="hljs-comment"># Are we the selected block?</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Fill up the linked list with the array of tokens we got.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    head = <span class="hljs-property">@start</span>
    <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> contents
      head = head.append token.clone()
    head.append <span class="hljs-property">@end</span>

    <span class="hljs-property">@view</span> = <span class="hljs-keyword">new</span> BlockView <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="clone">Clone</h2>
<p>Cloning produces a new Block entirely independent
of this one (there are no linked-list pointers in common).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span>
    clone = <span class="hljs-keyword">new</span> Block []
    clone.color = <span class="hljs-property">@color</span>
    head = <span class="hljs-property">@start</span>.next
    cursor = clone.start
    <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span>
      <span class="hljs-keyword">switch</span> head.type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span>
          block_clone = head.block.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.block.end
        <span class="hljs-keyword">when</span> <span class="hljs-string">'socketStart'</span>
          block_clone = head.socket.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.socket.end
        <span class="hljs-keyword">when</span> <span class="hljs-string">'indentStart'</span>
          block_clone = head.indent.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.indent.end
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">unless</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursorToken'</span> <span class="hljs-keyword">then</span> cursor = cursor.append head.clone()
      head = head.next
    cursor.append clone.end

    <span class="hljs-keyword">return</span> clone</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="insocket">inSocket</h2>
<p>Is this block in a Socket? This function is mainly used
by the View to determine whether a block needs tabs or not,
and by the Controller to determine whether a block can be dropped after.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inSocket</span>:<span class="hljs-function"> -&gt;</span>
    head = <span class="hljs-property">@start</span>.prev
    <span class="hljs-keyword">while</span> head? <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">then</span> head = head.prev
    <span class="hljs-keyword">return</span> head? <span class="hljs-keyword">and</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="moveto">moveTo</h2>
<p>Splice this block out and place it somewhere else.
This will also eliminate any empty lines left behind, and any empty Segments.
Whitespace in general is this function’s responsibility.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">moveTo</span>: <span class="hljs-function"><span class="hljs-params">(parent)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Check for empty segments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> <span class="hljs-property">@start</span>.prev? <span class="hljs-keyword">and</span> <span class="hljs-property">@start</span>.prev.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@start</span>.prev.segment.end <span class="hljs-keyword">is</span> <span class="hljs-property">@end</span>.next
      <span class="hljs-property">@start</span>.prev.segment.remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Don’t leave empty lines behind</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@end</span>.next? <span class="hljs-keyword">and</span> <span class="hljs-property">@start</span>.prev?
      last = <span class="hljs-property">@end</span>.next
      <span class="hljs-keyword">while</span> last? <span class="hljs-keyword">and</span> (last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentEnd'</span> <span class="hljs-keyword">or</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span>) <span class="hljs-keyword">then</span> last = last.next

      first = <span class="hljs-property">@start</span>.prev
      <span class="hljs-keyword">while</span> first? <span class="hljs-keyword">and</span> (first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">or</span> first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span>) <span class="hljs-keyword">then</span> first = first.prev

      <span class="hljs-keyword">if</span> first? <span class="hljs-keyword">and</span> (first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>) <span class="hljs-keyword">and</span> ((<span class="hljs-keyword">not</span> last?) <span class="hljs-keyword">or</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">or</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (first.prev?.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">and</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span>)
        first.remove()
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> last? <span class="hljs-keyword">and</span> (last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>) <span class="hljs-keyword">and</span> ((<span class="hljs-keyword">not</span> first?) <span class="hljs-keyword">or</span> first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>)
        last.remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Unsplice ourselves</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@start</span>.prev? <span class="hljs-keyword">then</span> <span class="hljs-property">@start</span>.prev.next = <span class="hljs-property">@end</span>.next
    <span class="hljs-keyword">if</span> <span class="hljs-property">@end</span>.next? <span class="hljs-keyword">then</span> <span class="hljs-property">@end</span>.next.prev = <span class="hljs-property">@start</span>.prev
    <span class="hljs-property">@start</span>.prev = <span class="hljs-property">@end</span>.next = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Splice ourselves into the requested parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> parent?
      <span class="hljs-property">@end</span>.next = parent.next
      <span class="hljs-keyword">if</span> parent.next? <span class="hljs-keyword">then</span> parent.next.prev = <span class="hljs-property">@end</span>

      parent.next = <span class="hljs-property">@start</span>
      <span class="hljs-property">@start</span>.prev = parent</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Check to see if we need to wrap ouselves in parentheses
To do this, we find our actual parent (not wrapping segment).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> parent? <span class="hljs-keyword">and</span> parent.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">then</span> parent = parent.prev
    <span class="hljs-keyword">if</span> parent?.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> parent.socket.precedence &gt; <span class="hljs-property">@precedence</span>
      <span class="hljs-keyword">unless</span> <span class="hljs-property">@currentlyParenWrapped</span>
        <span class="hljs-property">@start</span>.insert <span class="hljs-keyword">new</span> TextToken <span class="hljs-string">'('</span>
        <span class="hljs-property">@end</span>.insertBefore <span class="hljs-keyword">new</span> TextToken <span class="hljs-string">')'</span>
        <span class="hljs-property">@currentlyParenWrapped</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@currentlyParenWrapped</span>
      <span class="hljs-property">@start</span>.next.remove(); <span class="hljs-property">@end</span>.prev.remove()
      <span class="hljs-property">@currentlyParenWrapped</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="checkparenwrap">checkParenWrap</h2>
<p>Wrap ourselves or unwrap in parentheses if necessary, otherwise do nothing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">checkParenWrap</span>:<span class="hljs-function"> -&gt;</span>
    parent = <span class="hljs-property">@start</span>.prev</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>To do this, we find our actual parent (not wrapping segment).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> parent? <span class="hljs-keyword">and</span> parent.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">then</span> parent = parent.prev
    <span class="hljs-keyword">if</span> parent?.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> parent.socket.precedence &gt; <span class="hljs-property">@precedence</span>
      <span class="hljs-keyword">unless</span> <span class="hljs-property">@currentlyParenWrapped</span>
        <span class="hljs-property">@start</span>.insert <span class="hljs-keyword">new</span> TextToken <span class="hljs-string">'('</span>
        <span class="hljs-property">@end</span>.insertBefore <span class="hljs-keyword">new</span> TextToken <span class="hljs-string">')'</span>
        <span class="hljs-property">@currentlyParenWrapped</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@currentlyParenWrapped</span>
      <span class="hljs-property">@start</span>.next.remove(); <span class="hljs-property">@end</span>.prev.remove()
      <span class="hljs-property">@currentlyParenWrapped</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="find">find</h2>
<p>This one is mainly used for hit-testing during drag-and-drop by the Controller.
It finds the first child fitting f(x) that does not have a child who fits f(x).</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>(todo — move to Controller?)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">find</span>: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span>
    head = <span class="hljs-property">@start</span>.next
    <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If we found a child block, find in there</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">and</span> f(head.block) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.block.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">and</span> f(head.indent) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.indent.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> f(head.socket) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.socket.find f
      head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Maybe the <em>we</em> are the first child with no fitting children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> f <span class="hljs-keyword">this</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>We found no results, so return null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="tostring">toString</h2>
<p>This one is mainly used for debugging. The string representation (“compiled code”)
for anything between our start and end tokens. This is computed by stringifying
everything, then splicing off everything after the end token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span>
    string = <span class="hljs-property">@start</span>.toString <span class="hljs-attribute">indent</span>: <span class="hljs-string">''</span>
    <span class="hljs-keyword">return</span> string[..string.length-<span class="hljs-property">@end</span>.toString(<span class="hljs-attribute">indent</span>: <span class="hljs-string">''</span>).length-<span class="hljs-number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h1 id="indent">Indent</h1>
<p>An Indent, like a Block, consists of two tokens, start and end. An Indent also knows its @depth,
which is the number of spaces that it is indented in. When compiling/stringifying, every newline
inside an indent will add @depth spaces after it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.Indent = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Indent</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(contents, <span class="hljs-property">@depth</span>)</span> -&gt;</span>
    <span class="hljs-property">@start</span> = <span class="hljs-keyword">new</span> IndentStartToken <span class="hljs-keyword">this</span>
    <span class="hljs-property">@end</span> = <span class="hljs-keyword">new</span> IndentEndToken <span class="hljs-keyword">this</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'indent'</span>
    
    head = <span class="hljs-property">@start</span>
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> contents
      head = head.append block.clone()
    head.append <span class="hljs-property">@end</span>
    
    <span class="hljs-property">@view</span> = <span class="hljs-keyword">new</span> IndentView <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="clone">clone</h2>
<p>Like Block, creates an Indent whose string representation and data structure 
is identical, but shares no linked-list pointers with us.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span>
    clone = <span class="hljs-keyword">new</span> Indent [], <span class="hljs-property">@depth</span>
    head = <span class="hljs-property">@start</span>.next
    cursor = clone.start
    <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span>
      <span class="hljs-keyword">switch</span> head.type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span>
          block_clone = head.block.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.block.end
        <span class="hljs-keyword">when</span> <span class="hljs-string">'socketStart'</span>
          block_clone = head.socket.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.socket.end
        <span class="hljs-keyword">when</span> <span class="hljs-string">'indentStart'</span>
          block_clone = head.indent.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.indent.end
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">unless</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursorToken'</span> <span class="hljs-keyword">then</span> cursor = cursor.append head.clone()
      head = head.next
    cursor.append clone.end

    <span class="hljs-keyword">return</span> clone</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="find">find</h2>
<p>This one is mainly used for hit-testing during drag-and-drop by the Controller.
It finds the first child fitting f(x) that does not have a child who fits f(x).</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>(todo — move to Controller?)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">find</span>: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Find the innermost child fitting function f(x)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    head = <span class="hljs-property">@start</span>.next
    <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If we found a child block, find in there</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">and</span> f(head.block) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.block.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">and</span> f(head.indent) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.indent.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> f(head.socket) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.socket.find f
      head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Could <em>we</em> be the first fitting element with no fitting children?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> f <span class="hljs-keyword">this</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Couldn’t find any, so return null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="tostring">toString</h2>
<p>This one is mainly used for debugging. Like Block.toString, computes
the compiled code for everything between the two end tokens, by stringifying
the start and splicing of the string representation of the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    string = <span class="hljs-property">@start</span>.toString(state)
    <span class="hljs-keyword">return</span> string[...string.length-<span class="hljs-property">@end</span>.toString(state).length-<span class="hljs-number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h1 id="segment">Segment</h1>
<p>A Segment is a basically invisible piece of markup, which knows its start and end tokens.
In rendering, this is usually passed through unnoticed. It is useful for mass tree operations,
for instance the Controller’s LASSO SELECT, which will drag multiple blocks at once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.Segment = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Segment</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(contents)</span> -&gt;</span>
    <span class="hljs-property">@start</span> = <span class="hljs-keyword">new</span> SegmentStartToken <span class="hljs-keyword">this</span>
    <span class="hljs-property">@end</span> = <span class="hljs-keyword">new</span> SegmentEndToken <span class="hljs-keyword">this</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'segment'</span>
    
    head = <span class="hljs-property">@start</span>
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> contents
      head = head.append block.clone()
    head.append <span class="hljs-property">@end</span>
    
    <span class="hljs-property">@view</span> = <span class="hljs-keyword">new</span> SegmentView <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="clone">clone</h2>
<p>Like Block, creates an Segment whose string representation and data structure 
is identical, but shares no linked-list pointers with us.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span>
    clone = <span class="hljs-keyword">new</span> Segment []
    head = <span class="hljs-property">@start</span>.next
    cursor = clone.start
    <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span>
      <span class="hljs-keyword">switch</span> head.type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span>
          block_clone = head.block.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.block.end
        <span class="hljs-keyword">when</span> <span class="hljs-string">'socketStart'</span>
          block_clone = head.socket.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.socket.end
        <span class="hljs-keyword">when</span> <span class="hljs-string">'indentStart'</span>
          block_clone = head.indent.clone()
          block_clone.start.prev = cursor
          cursor.next = block_clone.start
          cursor = block_clone.end
          head = head.indent.end
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">unless</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursorToken'</span> <span class="hljs-keyword">then</span> cursor = cursor.append head.clone()
      head = head.next
    cursor.append clone.end

    <span class="hljs-keyword">return</span> clone</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="remove">remove</h2>
<p>This method is unique to Segments because you would never want to call it
on any other kind of markup. This removes the start and end tokens, thus leaving
the string representation of the data unchanged, but removing this Segment from existence.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">remove</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@start</span>.remove()
    <span class="hljs-property">@end</span>.remove()
    <span class="hljs-property">@start</span>.next = <span class="hljs-property">@end</span>
    <span class="hljs-property">@end</span>.prev = <span class="hljs-property">@start</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h2 id="moveto">moveTo</h2>
<p>Splice this segment out and place it somewhere else.
This will also eliminate any empty lines left behind, and any empty Segments.
Whitespace in general is this function’s responsibility.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">moveTo</span>: <span class="hljs-function"><span class="hljs-params">(parent)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Check for empty segments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> <span class="hljs-property">@start</span>.prev? <span class="hljs-keyword">and</span> <span class="hljs-property">@start</span>.prev.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@start</span>.prev.segment.end <span class="hljs-keyword">is</span> <span class="hljs-property">@end</span>.next
      <span class="hljs-property">@start</span>.prev.segment.remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Don’t leave empty lines behind</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@end</span>.next? <span class="hljs-keyword">and</span> <span class="hljs-property">@start</span>.prev?
      last = <span class="hljs-property">@end</span>.next
      <span class="hljs-keyword">while</span> last? <span class="hljs-keyword">and</span> (last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentEnd'</span> <span class="hljs-keyword">or</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span>) <span class="hljs-keyword">then</span> last = last.next

      first = <span class="hljs-property">@start</span>.prev
      <span class="hljs-keyword">while</span> first? <span class="hljs-keyword">and</span> (first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">or</span> first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'cursor'</span>) <span class="hljs-keyword">then</span> first = first.prev

      <span class="hljs-keyword">if</span> first? <span class="hljs-keyword">and</span> (first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>) <span class="hljs-keyword">and</span> ((<span class="hljs-keyword">not</span> last?) <span class="hljs-keyword">or</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span> <span class="hljs-keyword">or</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (first.prev?.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">and</span> last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentEnd'</span>)
        first.remove()
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> last? <span class="hljs-keyword">and</span> (last.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>) <span class="hljs-keyword">and</span> ((<span class="hljs-keyword">not</span> first?) <span class="hljs-keyword">or</span> first.type <span class="hljs-keyword">is</span> <span class="hljs-string">'newline'</span>)
        last.remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Unsplice ourselves</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@start</span>.prev? <span class="hljs-keyword">then</span> <span class="hljs-property">@start</span>.prev.next = <span class="hljs-property">@end</span>.next
    <span class="hljs-keyword">if</span> <span class="hljs-property">@end</span>.next? <span class="hljs-keyword">then</span> <span class="hljs-property">@end</span>.next.prev = <span class="hljs-property">@start</span>.prev
    <span class="hljs-property">@start</span>.prev = <span class="hljs-property">@end</span>.next = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Splice ourselves into the requested parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> parent?
      <span class="hljs-property">@end</span>.next = parent.next
      <span class="hljs-keyword">if</span> parent.next? <span class="hljs-keyword">then</span> parent.next.prev = <span class="hljs-property">@end</span>

      parent.next= <span class="hljs-property">@start</span>
      <span class="hljs-property">@start</span>.prev = parent</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="find">find</h2>
<p>This one is mainly used for hit-testing during drag-and-drop by the Controller.
It finds the first child fitting f(x) that does not have a child who fits f(x).</p>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>(todo — move to Controller?)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">find</span>: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Find the innermost child fitting function f(x)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    head = <span class="hljs-property">@start</span>.next
    <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If we found a child block, find in there</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">and</span> f(head.block) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.block.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">and</span> f(head.indent) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.indent.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> f(head.socket) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.socket.find f
      head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Couldn’t find any, so we are the innermost child fitting f()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> f(<span class="hljs-keyword">this</span>) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h2 id="tostring">toString</h2>
<p>This one is actually called often from the Controller, since
Segments serve as the root elements of every tree. As with Blocks and Indents,
this is computed by stringifying the start token (get all code) and splicing off things after
the end token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span>
    start = <span class="hljs-property">@start</span>.toString(<span class="hljs-attribute">indent</span>: <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> start[...start.length-<span class="hljs-property">@end</span>.toString(<span class="hljs-attribute">indent</span>: <span class="hljs-string">''</span>).length]</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h1 id="socket">Socket</h1>
<p>A Socket is an inline droppable area for a Block, and
also a typable area for Text. Like a Block and an Indent,
a Socket consists of a start and end token. Sockets may only
contain <em>one</em> child element, although this may mean multiple tokens,
if the child element is a Block, Indent, or Segment.</p>
<p>A special type of Socket is a handwritten socket, for whom
the @handwritten property will be true, and is handled specially
by the Controller.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-built_in">exports</span>.Socket = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Socket</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(content, <span class="hljs-property">@precedence</span> = <span class="hljs-number">0</span>)</span> -&gt;</span>
    <span class="hljs-property">@start</span> = <span class="hljs-keyword">new</span> SocketStartToken <span class="hljs-keyword">this</span>
    <span class="hljs-property">@end</span> = <span class="hljs-keyword">new</span> SocketEndToken <span class="hljs-keyword">this</span>
    
    <span class="hljs-keyword">if</span> content? <span class="hljs-keyword">and</span> content.start?
      
      <span class="hljs-property">@start</span>.next = content.start
      content.start.prev = <span class="hljs-property">@start</span>

      <span class="hljs-property">@end</span>.prev = content.end
      content.end.next = <span class="hljs-property">@end</span>

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> content?

      <span class="hljs-property">@start</span>.next = content
      content.prev = <span class="hljs-property">@start</span>

      <span class="hljs-property">@end</span>.prev = content
      content.next = <span class="hljs-property">@end</span>

    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@start</span>.next = <span class="hljs-property">@end</span>
      <span class="hljs-property">@end</span>.prev = <span class="hljs-property">@start</span>

    <span class="hljs-property">@type</span> = <span class="hljs-string">'socket'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>A handwritten socket is a special kind of socket that doesn’t accept blocks
Its controller instance also has special key bindings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@handwritten</span> = <span class="hljs-literal">false</span>

    <span class="hljs-property">@view</span> = <span class="hljs-keyword">new</span> SocketView <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="clone">clone</h2>
<p>Cloning produces an identical Socket with no shared linked-list pointers.
To produce this clone, we need only delegate to our content block, because
there <em>may only be one</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@content</span>()? <span class="hljs-keyword">then</span> <span class="hljs-keyword">new</span> Socket <span class="hljs-property">@content</span>().clone() <span class="hljs-keyword">else</span> <span class="hljs-keyword">new</span> Socket()</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="content">content</h2>
<p>Get the content block of this Socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">content</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-function"><span class="hljs-title">unwrap</span> = <span class="hljs-params">(el)</span> -&gt;</span>
      <span class="hljs-keyword">switch</span> el.type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> el.block
        <span class="hljs-keyword">when</span> <span class="hljs-string">'segmentStart'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> unwrap el.next
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> el
    <span class="hljs-keyword">if</span> <span class="hljs-property">@start</span>.next <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span>
      <span class="hljs-keyword">return</span> unwrap <span class="hljs-property">@start</span>.next
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h2 id="find">find</h2>
<p>This one is mainly used for hit-testing during drag-and-drop by the Controller.
It finds the first child fitting f(x) that does not have a child who fits f(x).</p>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>(todo — move to Controller?)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">find</span>: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Find the innermost child fitting function f(x)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    head = <span class="hljs-property">@start</span>.next
    <span class="hljs-keyword">while</span> head <span class="hljs-keyword">isnt</span> <span class="hljs-property">@end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>If we found a child block, find in there</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'blockStart'</span> <span class="hljs-keyword">and</span> f(head.block) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.block.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'indentStart'</span> <span class="hljs-keyword">and</span> f(head.indent) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.indent.find f
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> head.type <span class="hljs-keyword">is</span> <span class="hljs-string">'socketStart'</span> <span class="hljs-keyword">and</span> f(head.socket) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> head.socket.find f
      head = head.next</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Couldn’t find any, so we are the innermost child fitting f()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> f <span class="hljs-keyword">this</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

  <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@start</span>.toString(<span class="hljs-attribute">indent</span>:<span class="hljs-string">''</span>)[...-<span class="hljs-property">@end</span>.toString(<span class="hljs-attribute">indent</span>:<span class="hljs-string">''</span>).length]</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <h1 id="token">Token</h1>
<p>This is the class from which all ICE Editor tokens descend.
It knows basic linked-list operations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.Token = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h2 id="append">append</h2>
<p>Splice the linked list starting at (token)
to the end of this token. This disconnects us from
any linked list segment starting at @next, and conjoins us
with that starting at (token).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">append</span>: <span class="hljs-function"><span class="hljs-params">(token)</span> -&gt;</span>
    token.prev = <span class="hljs-keyword">this</span>
    <span class="hljs-property">@next</span> = token</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2 id="insert">insert</h2>
<p>Insert signle token (token) into this linked list
right after us. This retains our linked list order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">insert</span>: <span class="hljs-function"><span class="hljs-params">(token)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@next</span>?
      token.next = <span class="hljs-property">@next</span>
      <span class="hljs-property">@next</span>.prev = token
    token.prev = <span class="hljs-keyword">this</span>
    <span class="hljs-property">@next</span> = token
    <span class="hljs-keyword">return</span> <span class="hljs-property">@next</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h2 id="insertbefore">insertBefore</h2>
<p>Insert (token) in this linked list before us, as with insert.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">insertBefore</span>: <span class="hljs-function"><span class="hljs-params">(token)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@prev</span>?
      token.prev = <span class="hljs-property">@prev</span>
      <span class="hljs-property">@prev</span>.next = token

    token.next = <span class="hljs-keyword">this</span>
    <span class="hljs-property">@prev</span> = token

    <span class="hljs-keyword">return</span> <span class="hljs-property">@prev</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <h2 id="remove">remove</h2>
<p>Splice us out of the linked list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">remove</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@prev</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@prev</span>.next = <span class="hljs-property">@next</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@next</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@next</span>.prev = <span class="hljs-property">@prev</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h2 id="tostring">toString</h2>
<p>Converting a Token to a string gets you the compilation of this
and every token after it. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@next</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@next</span>.toString(state) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h1 id="special-kinds-of-tokens">Special kinds of tokens</h1>

            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <h2 id="cursortoken">CursorToken</h2>
<p>A user’s cursor, which the Controller can perform operations at
and the View renders as a black triangle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.CursorToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CursorToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@view</span> = <span class="hljs-keyword">new</span> CursorView <span class="hljs-keyword">this</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'cursor'</span>

  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">new</span> CursorToken()</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <h2 id="texttoken">TextToken</h2>
<p>A token representing plain text.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.TextToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@value</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@view</span> = <span class="hljs-keyword">new</span> TextView <span class="hljs-keyword">this</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'text'</span>

  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">new</span> TextToken <span class="hljs-property">@value</span>

  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-property">@value</span> + <span class="hljs-keyword">if</span> <span class="hljs-property">@next</span>? <span class="hljs-keyword">then</span> <span class="hljs-property">@next</span>.toString(state) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h2 id="markup-tokens">Markup tokens</h2>
<p>These are the tokens to which we referred earlier when we discussed
Blocks, Indents, Segments, and Sockets. They represent the start and end of a piece of markup.
They should <em>never</em> be instantiated, except by their respective markup classes
(Block, Start, Segment, and Indent).</p>
<p>When stringifying, they do no operations. Thus they have no responsibility
but to identify their type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.BlockStartToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockStartToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@block</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'blockStart'</span>

<span class="hljs-built_in">exports</span>.BlockEndToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockEndToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@block</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'blockEnd'</span>

<span class="hljs-built_in">exports</span>.SocketStartToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocketStartToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@socket</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'socketStart'</span>

<span class="hljs-built_in">exports</span>.SocketEndToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocketEndToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@socket</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'socketEnd'</span>

<span class="hljs-built_in">exports</span>.SegmentStartToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SegmentStartToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@segment</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'segmentStart'</span>

<span class="hljs-built_in">exports</span>.SegmentEndToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SegmentEndToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@segment</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'segmentEnd'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <h2 id="indentstart-and-indentend">IndentStart and IndentEnd</h2>
<p>These tokens must increment or decrement the number of spaces
to insert at each newline. This number is stored and modified in (state),
an object passed down whenever a stringification occurs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.IndentStartToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndentStartToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@indent</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> =  <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'indentStart'</span>

  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.indent += (<span class="hljs-string">' '</span> <span class="hljs-keyword">for</span> [<span class="hljs-number">1.</span>.<span class="hljs-property">@indent</span>.depth]).join <span class="hljs-string">''</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@next</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@next</span>.toString(state) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>

<span class="hljs-built_in">exports</span>.IndentEndToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndentEndToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@indent</span>)</span> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> =  <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'indentEnd'</span>

  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.indent = state.indent[...-<span class="hljs-property">@indent</span>.depth]
    <span class="hljs-keyword">if</span> <span class="hljs-property">@next</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@next</span>.toString(state) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h2 id="newlinetoken">NewlineToken</h2>
<p>This token represents a newline. When stringifying, it inserts (state.indent) spaces
if necessary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span>.NewlineToken = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewlineToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Token</span></span>
  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@prev</span> = <span class="hljs-property">@next</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@type</span> = <span class="hljs-string">'newline'</span>

  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">new</span> NewlineToken()

  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-string">'\n'</span> + state.indent + <span class="hljs-keyword">if</span> <span class="hljs-property">@next</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@next</span>.toString(state) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>

<span class="hljs-built_in">window</span>.ICE = <span class="hljs-built_in">exports</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
